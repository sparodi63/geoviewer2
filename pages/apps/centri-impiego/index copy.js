var svg_ente = `<svg class="svg-icon v-align" viewBox="0 0 42.32 60.38">
  <g id="Livello_2" data-name="Livello 2">
    <g id="Livello_1-2" data-name="Livello 1">
      <path d="M21.16,0A21.17,21.17,0,0,0,2.31,30.79c.2.39.42.78.64,1.16s.51.81.78,1.21l8,12.42,9.47,14.8,9.48-14.8,8-12.42L40,30.79A21.17,21.17,0,0,0,21.16,0Zm0,32A10.59,10.59,0,1,1,31.75,21.36,10.59,10.59,0,0,1,21.16,32Z" />
    </g>
  </g>
</svg>`;
var svg_indirizzo = `<svg class="svg-icon v-align" viewBox="0 0 59.38 52.49">
  <g id="Livello_2" data-name="Livello 2">
    <g id="Livello_1-2" data-name="Livello 1">
      <path d="M1,26H8.15V52.49H24.36V32.41H35V52.49H51.23V26h7.13A1,1,0,0,0,59,24.15l-7.78-6.4v-12H44.07v6.08L29.69,0,.37,24.15A1,1,0,0,0,1,26Z"/>
    </g>
  </g>
</svg>`;
var svg_mail = `<svg class="svg-icon v-align" viewBox="0 0 44.76 46.74">
  <g id="Livello_2" data-name="Livello 2">
    <g id="Livello_1-2" data-name="Livello 1">
      <g>
        <polygon points="0 19.19 0 44.08 15.25 31.76 0 19.19"/>
        <polygon points="29.52 31.84 44.76 44.09 44.76 19.27 29.52 31.84"/>
        <path d="M2.33,18,20.44,3l.86-.71,0,0,.08,0A1.78,1.78,0,0,1,22.36,2h0a1.68,1.68,0,0,1,1.05.35L42.42,18h2.15a.27.27,0,0,0,.15-.05L23.42.35A1.68,1.68,0,0,0,22.37,0h0a1.7,1.7,0,0,0-.94.28l-.08,0,0,0-.86.71L.09,17.86A.25.25,0,0,0,.28,18Z"/>
        <path d="M24.68,35.84a3.63,3.63,0,0,1-4.47,0L16.71,33,0,46.46v0a.24.24,0,0,0,.24.24H44.53a.24.24,0,0,0,.23-.24v0L28.06,33.05Z"/>
        <path d="M28.77,12.17H25.44l-.31,1.42A3.65,3.65,0,0,0,21.8,11.9a5.61,5.61,0,0,0-3.54,1.22,8,8,0,0,0-2.42,3.14A9.45,9.45,0,0,0,15,20.15a5.83,5.83,0,0,0,.82,3.2A4.6,4.6,0,0,0,18,25.2a4.73,4.73,0,0,0,2.76.26,4.84,4.84,0,0,0,2.52-1.37A1.72,1.72,0,0,0,24,25.2a3,3,0,0,0,1.58.34,7.35,7.35,0,0,0,3.29-.75,8.37,8.37,0,0,0,2.65-2,9.32,9.32,0,0,0,1.73-2.91,9.18,9.18,0,0,0,.61-3.3,10.13,10.13,0,0,0-.75-4A8.91,8.91,0,0,0,31,9.47a9.86,9.86,0,0,0-3.42-2,13.38,13.38,0,0,0-4.39-.69,14.23,14.23,0,0,0-5.35,1,11.51,11.51,0,0,0-6.68,6.73,13.85,13.85,0,0,0-.89,5,12.47,12.47,0,0,0,.86,4.69,10,10,0,0,0,2.57,3.65,11.44,11.44,0,0,0,4.17,2.34A18,18,0,0,0,23.4,31a18.27,18.27,0,0,0,3.82-.37,12.94,12.94,0,0,0,3.16-1.11,9.46,9.46,0,0,0,2.46-1.78,6.12,6.12,0,0,0,1.71-2.4H31.86a5.91,5.91,0,0,1-2.73,2.19,12.68,12.68,0,0,1-3.95,1.06,16.75,16.75,0,0,1-5.27-.21,10.34,10.34,0,0,1-4-1.73,8,8,0,0,1-2.51-3,9.05,9.05,0,0,1-.86-4,13.07,13.07,0,0,1,.4-3.18,10.5,10.5,0,0,1,1.18-2.85,8.45,8.45,0,0,1,2.16-2.47,9.62,9.62,0,0,1,3-1.54,12.49,12.49,0,0,1,3.77-.54,11,11,0,0,1,3.61.56,7.73,7.73,0,0,1,2.67,1.53A6.69,6.69,0,0,1,31,13.49a7.39,7.39,0,0,1-.23,6.19,7.62,7.62,0,0,1-1.88,2.42,3.12,3.12,0,0,1-1.75.89.46.46,0,0,1-.35-.17.64.64,0,0,1-.14-.45,6.82,6.82,0,0,1,.17-1.15ZM24,19.92a6.15,6.15,0,0,1-1.37,2.39,2.78,2.78,0,0,1-2.08.94,2,2,0,0,1-1.65-.8,3.7,3.7,0,0,1-.63-2.32,8.57,8.57,0,0,1,.48-2.85A5.73,5.73,0,0,1,20.08,15a2.83,2.83,0,0,1,2-.86,2.25,2.25,0,0,1,1,.21,2,2,0,0,1,.74.61,2.86,2.86,0,0,1,.47.94,4.48,4.48,0,0,1,.15,1.2A9,9,0,0,1,24,19.92Z"/>
      </g>
    </g>
  </g>
</svg>`;

var baseURL =
  "https://geoservizi.regione.liguria.it/geoserver/M2136/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=M2136%3AL7350&maxFeatures=50&outputFormat=application%2Fjson&srsName=EPSG%3A4326";

var baseLegendUrl = "../../../static/img/centri-impiego/legend/";

var config = [
  { id: "CPI", legendLabel: "CPI - Centro per l'impiego" },
  { id: "COM", legendLabel: "COM - Comune" },
  { id: "EF", legendLabel: "EF - Ente di formazione" },
  { id: "AL", legendLabel: "AL - Agenzia per il lavoro" },
  { id: "COOP", legendLabel: "COOP - Cooperativa" }
  // { id: "A", legendLabel: "A - Altro" }
];

var layers = [];

config.forEach(function(tipo) {
  layers.push(getLayer(tipo.id, tipo.legendLabel));
});

// console.log(layers);

function getTemplate(id) {
  var tpl = "";
  tpl += '<div class="div-popup div-' + id + '" >';
  tpl += svg_ente;
  tpl += '<span class="v-align" >{NOME_SEDE}</span><br>';
  tpl += svg_indirizzo;
  tpl +=
    '<span class="v-align" >{INDIRIZZO} {CIVICO}, {CAP} {COMUNE}</span><br>';
  // tpl += svg_mail;
  // tpl += '<span class="v-align" >{E_MAIL}</span><br>';
  tpl += "</div>";
  return tpl;
}

function getLayer(id, legendLabel) {
  var template = getTemplate(id);
  return {
    type: "JSON",
    dataType: "json",
    cluster: {
      options: {
        iconCreateFunction: function(cluster) {
          return L.divIcon({
            html: cluster.getChildCount(),
            className: "cluster cluster_" + id,
            iconSize: L.point(31, 31)
          });
        },
        showCoverageOnHover: false,
        maxClusterRadius: 80
      }
    },
    name: id,
    visible: true,
    geomSubType: "POINT",
    url: baseURL + "&cql_filter=TIPO_SEDE='" + id + "'",
    legend: {
      label: legendLabel,
      icon: baseLegendUrl + id + ".png"
    },
    tooltip: "{NOME_SEDE}",
    popup: template,
    classes: [
      {
        style: {
          iconUrl: baseLegendUrl + id + ".png",
          iconSize: [20, 29],
          iconAnchor: [14, 29],
          popupAnchor: [0, -29]
        }
      }
    ]
  };
}

var map = {
  id: 0,
  name: "centri-impiego",
  layers: layers
};

GV.init({
  debug: true,
  maps: [map],
  application: {
    layout: {
      title: " ",
      legend: {
        options: {
          show: true,
          showAddMap: false,
          showInfoMap: false,
          showBaseLayerSwitcher: false
        }
      },
      tools: [
        {
          name: "gv-inner-html",
          position: "topleft",
          options: {
            props: [
              {
                html: '<div class="gv-color-scheme" id="logo"></div>'
              }
            ]
          }
        },
        {
          name: "gv-search",
          position: "topleft",
          options: {
            layers: ["CPI", "COM", "EF", "AL", "COOP", "A"],
            propertyName: "NOME_SEDE"
          }
        },
        {
          name: "gv-inner-html",
          position: "bottomleft",
          options: {
            props: [
              {
                html: '<div id="loghi"></div>'
              }
            ]
          }
        }
        // {
        //   name: 'gv-scuoladigitale-legend',
        //   position: 'topright',
        //   options: {
        //     maps: maps,
        //   },
        // },
      ]
    }
  },
  baseLayers: [
    {
      type: "OSM",
      visible: true
    }
  ]
});

var configOld = {
  CPI: { id: "CPI", legendLabel: "CPI - Centro per l'impiego" },
  COM: { id: "COM", legendLabel: "COM - Comune" },
  EF: { id: "EF", legendLabel: "EF - Ente di formazione" },
  AL: { id: "AL", legendLabel: "AL - Agenzia per il lavoro" },
  COOP: { id: "COOP", legendLabel: "COOP - Cooperativa" }
  // A: { id: "A", legendLabel: "A - Altro" }
};

var layersOld = [
  {
    type: "JSON",
    dataType: "json",
    cluster: {
      options: {
        iconCreateFunction: function(cluster) {
          return L.divIcon({
            html: cluster.getChildCount(),
            className: "cluster cluster_" + configOld["CPI"].id,
            iconSize: L.point(29, 29)
          });
        },
        showCoverageOnHover: false,
        maxClusterRadius: 80
      }
    },
    name: "CPI",
    visible: true,
    geomSubType: "POINT",
    url: baseURL + "&cql_filter=TIPO_SEDE='" + configOld["CPI"].id + "'",
    legend: {
      label: configOld["CPI"].legendLabel,
      icon: baseLegendUrl + configOld["CPI"].id + ".png"
    },
    tooltip: "{NOME_SEDE}",
    popup: tpl,
    classes: [
      {
        style: {
          iconUrl: baseLegendUrl + configOld["CPI"].id + ".png",
          iconSize: [20, 29],
          iconAnchor: [14, 29],
          popupAnchor: [0, -29]
        }
      }
    ]
  },
  {
    type: "JSON",
    dataType: "json",
    cluster: {
      options: {
        iconCreateFunction: function(cluster) {
          return L.divIcon({
            html: cluster.getChildCount(),
            className: "cluster cluster_" + configOld["COM"].id,
            iconSize: L.point(29, 29)
          });
        },
        showCoverageOnHover: false,
        maxClusterRadius: 80
      }
    },
    name: "COM",
    visible: true,
    geomSubType: "POINT",
    url: baseURL + "&cql_filter=TIPO_SEDE='" + configOld["COM"].id + "'",
    legend: {
      label: configOld["COM"].legendLabel,
      icon: baseLegendUrl + configOld["COM"].id + ".png"
    },
    tooltip: "{NOME_SEDE}",
    popup: tpl,
    classes: [
      {
        style: {
          iconUrl: baseLegendUrl + configOld["COM"].id + ".png",
          iconSize: [20, 29],
          iconAnchor: [14, 29],
          popupAnchor: [0, -29]
        }
      }
    ]
  }
];
