<template>
    <div id="gv-geocoder" class="geocoder">
        <el-select
            v-model="address"
            filterable
            clearable
            remote
            size="mini"
            placeholder="Ricerca Indirizzo..."
            :remote-method="remoteMethod"
            @change="onChange"
            :loading="loading"
            loading-text="Caricamento... "
            no-match-text="Nessun indirizzo trovato"
            no-data-text="Nessun indirizzo trovato"
        >
            <el-option
                v-for="item in results"
                :key="item.value"
                :label="item.label"
                :value="item.value">
            </el-option>
        </el-select>
    </div>
</template>


<script>

import getGoogleGeocode from '../services/getGoogleGeocode'

import Vue from 'vue'
import { Select, Option } from 'element-ui'
Vue.use(Select)
Vue.use(Option)

export default {
  data() {
    return {
      results: [],
      address: [],
      loading: false,
      marker: null,
    }
  },
  methods: {
    remoteMethod(query) {
      if (query.length < 4) {
        this.results = []
        return
      }
      this.loading = true
      getGoogleGeocode(query)
        .then(results => {
          this.loading = false
          if (results && results.length > 0) {
            this.results = results.map(result => ({
              label: result.formatted_address,
              value: result.place_id,
              location: result.geometry.location,
            }))
          } else {
            this.results = []
          }
        })
        .catch(error => {
          this.loading = false
          console.error(error)
        })
    },
    onChange(value) {
      const result = this.results.find(item => item.value === value)
      if (result) {
        this.marker = GV.app.map.addMarker(result)
      } else {
        if (this.marker) {
          GV.app.map.removeLayer(this.marker)
        }
      }
    },
  },
  mounted: function() {},
}
</script>

<style scoped >
.geocoder {
  height: 26px;
  width: 180px;
  z-index: 800;
}
@media only screen and (max-width: 540px) {
  .geocoder {
    width: 140px;
  }
}
</style>