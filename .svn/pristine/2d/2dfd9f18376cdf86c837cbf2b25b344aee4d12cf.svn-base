var GV=GV||{};GV.Models={};GV.Buttons={};GV.Views={};GV.Util=function(){return{getUrlParam:function(b){var a=new RegExp("[\\?&]"+b+"=([^&#]*)").exec(window.location.href);GV.Util.log("GV.Util.getUrlParam");return a?decodeURIComponent(a[1]):null},getUrlParamFromString:function(a,c){var b=new RegExp("[\\?&]"+c+"=([^&#]*)").exec(a);if(!b){return 0}return b[1]||0},log:function(a,d){var b="log";if(!GV.debug){return}switch(d){case 0:b="warn";break;case 1:case 2:b="error";break;default:b="info";break}try{console[b](a)}catch(c){}},msgBox:function(a){window.alert(a)},setUnderscoreTemplate:function(){if(_){_.templateSettings={interpolate:/\{\{(.+?)\}\}/g}}},ajax:function(b,c){var a={jsonpCallback:"getJson",type:"GET"};GV.Util.log("GV.Util.ajax");$.ajax(_.extend(a,b)).done(function(e){try{if(c){c(e)}}catch(d){console.error(d.message)}}).fail(function(d,f,e){if(d.statusText!=="OK"){console.error("GV.Util.ajax - Non sono riuscito a caricare la url:\n"+url+"\nErrore: "+d.status+" - "+f+" - "+e)}})},parseXML:function(c){GV.Util.log("GV.Util.parseXML");try{var b=null;if(window.DOMParser&&window.XSLTProcessor){var d=new DOMParser();b=d.parseFromString(c,"text/xml")}else{b=new ActiveXObject("Msxml2.DOMDocument.3.0");b.async=false;b.loadXML(c)}return b}catch(a){throw {name:"xmlTransformation",message:"GV.Util.parseXml: errore parsing xml - "+a.message,level:1}}},isPointInLig:function(b,f){GV.Util.log("GV.Util.isPointInLig");if(!b||!f){return false}var a=7.4,e=43.7,d=10.1,c=44.8;return(b>a)&&(b<d)&&(f>e)&&(f<c)},toArray:function(a){return Array.prototype.slice.call(a)},bind:function(b,a){return function(){return a.apply(b,GV.Util.toArray(arguments))}},getArrayElementByAttribute:function(e,c,d){if(!e){return null}var b,a=e.length;for(b=0;b<a;b++){if(e[b][c]===d){return e[b]}}return null},geoCode:function(a,b,d){var c=new google.maps.Geocoder();c.geocode({address:a},function(h,f){if(f===google.maps.GeocoderStatus.OK){var e=h[0].geometry.location.lng();var j=h[0].geometry.location.lat();var g={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Point",coordinates:[e,j]},properties:{address:a}}]};if(b){for(var i in b){if(b.hasOwnProperty(i)){g.features[0].properties[i]=b[i]}}}d(g)}else{if(f===google.maps.GeocoderStatus.ZERO_RESULTS){GV.Util.msgBox("Indirizzo '"+a+"' non trovato")}else{console.error("Errore di geocoding: "+f)}}})},getParamString:function(d,a,b){var e=[];for(var c in d){e.push(encodeURIComponent(b?c.toUpperCase():c)+"="+encodeURIComponent(d[c]))}return((!a||a.indexOf("?")===-1)?"?":"&")+e.join("&")},template:function(b,a){var c=/\{ *([\w_\-]+) *\}/g;return b.replace(c,function(f,d){var e=a[d];if(e===undefined){throw new Error("No value provided for variable "+f)}else{if(typeof e==="function"){e=e(a)}}return e})},getZoomFromScaleDenom:function(a){return _.findIndex(GV.Globals.BASE_SCALES,function(b){return a>b})},getScaleLabelsFromZoom:function(a){return GV.Globals.BASE_SCALE_LABELS[a]},getScaleFromZoom:function(a){return GV.Globals.BASE_SCALES[a]}}}();GV.App=Marionette.Application.extend({initialize:function(b){var a=this;GV.app=this;GV.debug=b.debug;this.proxy=b.proxy||GV.Globals.DEFAULT_PROXY;GV.Util.log("GV.App.initialize");GV.Util.log(b);if(!b){GV.debug=true;GV.Util.log("GV.App: Mancano opzioni di configurazione",2);return}GV.rlMaps=new GV.Models.RlMaps();GV.layerFactory=new GV.LayerFactory();this.layout=new GV.Views.Layout(b);this.map=this.layout.map;this.layout.render(b);if(b.config&&b.config.maps&&b.config.maps.length>0){_.each(b.config.maps,function(c){GV.rlMaps.add(new GV.Models.RlMap(c))})}if(b.idMap){this.addRlMap(b.idMap,b)}else{if(b&&b.callback){b.callback(a)}}this.start(b)},addRlMap:function(c,b){var a=this;$.ajax({url:GV.Globals.RL_MAP_CONFIG_SERVICE+c,dataType:"jsonp"}).done(function(d){var e=d.data;GV.rlMaps.add(new GV.Models.RlMap(e));if(b&&b.callback){b.callback(a)}if(e.extent_3857){a.map.setInitialExtent(e.extent_3857)}if(b.setMapTitle){$("#gv-container").append("<div id='gv-title'>"+e.name+"</div>")}})}});var GV=GV||{};GV.Models={};GV.Buttons={};GV.Views={};GV.Globals={DEFAULT_PROXY:"/geoservices/proxy/proxy.jsp?url=",RL_MAP_CONFIG_SERVICE:"http://geoportale.regione.liguria.it/geoservices/REST/config/map/",RL_CREATE_SLD_SERVICE:"http://geoportale.regione.liguria.it/geoservices/REST/config/create_sld/",RL_METADATA_URL:"/geoservices/REST/metadata/scheda_xml/",INFO_WMS_MAX_FEATURES:10,BASE_SCALES:[591657550.5,295828775.3,147914387.6,73957193.82,36978596.91,18489298.45,9244649.227,4622324.614,2311162.307,1155581.153,577790.5767,288895.2884,144447.6442,72223.82209,36111.91104,18055.95552,9027.977761,4513.98888,2256.99444,1128.49722],BASE_SCALE_LABELS:{8:"1:1.600.000",9:"1:800.000",10:"1:400.000",11:"1:200.000",12:"1:100.000",13:"1:50.000",14:"1:25.000",15:"1:12.500",16:"1:6.250",17:"1:3.125",18:"1:1.560",19:"1:800",20:"1:400"}};GV.InfoWmsManager=function(){return{_requestCount:0,_numRequests:0,_features:[],activate:function(a){GV.Util.log("GV.infoWmsManager.activate");a.on("click",GV.infoWmsManager.request)},buildWMSOptions:function(b,f,c){var g=GV.app.map.latLngToContainerPoint(c,GV.app.map.getZoom()),i=GV.app.map.getSize(),a=GV.app.map.getBounds(),h=GV.app.map.options.crs.project(a.getSouthWest()),e=GV.app.map.options.crs.project(a.getNorthEast());var d={request:"GetFeatureInfo",service:"WMS",crs:"EPSG:3857",styles:"",version:"1.1.0",format:"application/json",bbox:h.x+","+h.y+","+e.x+","+e.y,height:i.y,width:i.x,layers:f,query_layers:f,FEATURE_COUNT:100,buffer:10,info_format:"application/json"};_.extend(d,{});d[d.version==="1.3.0"?"i":"x"]=g.x;d[d.version==="1.3.0"?"j":"y"]=g.y;return GV.app.proxy+b+GV.Util.getParamString(d,b,true)},handleResponse:function(a){GV.infoWmsManager._requestCount++;_.each(a,function(b){b.layer=b.id.split(".")[0]});Array.prototype.push.apply(GV.infoWmsManager._features,a);if(GV.infoWmsManager._requestCount===GV.infoWmsManager._numRequests){$(".leaflet-container").css("cursor","default");console.log(GV.infoWmsManager._features);alert("GFI"+GV.infoWmsManager._features.length)}},request:function(b){GV.infoWmsManager._requestCount=0;GV.infoWmsManager._numRequests=0;GV.infoWmsManager._features=[];var a=GV.rlMaps.toJSON();_.each(a,function(c){var d=null,f=[];_.each(c.layers,function(h){if(h.idMap===c.id&&h.type==="WMS"&&h.queryable&&h.visible&&GV.app.map.layerInRange(h)){d=h.wmsParams.url;f.push(h.wmsParams.name)}});var g=f.join(",");if(d&&f.length>0){var e=GV.infoWmsManager.buildWMSOptions(d,g,b.latlng);GV.infoWmsManager._numRequests++;$(".leaflet-container").css("cursor","wait");$.ajax({url:e,dataType:"json"}).done(function(h){GV.infoWmsManager.handleResponse(h.features)})}})}}};GV.LayerFactory=function(){var a='<a href="http://www.esri.com/">Esri</a>';return{lastZIndex:11,createPane:function(c,f,d){var b=d.getPane("tilePane");var e=d.createPane(c,b);e.style.zIndex=f;return e},create:function(b,d){var c=this[b.type](b,d);c.legend=b.legend;c.config=b;return c},OSM:function(b){b.legend={label:"OpenStreetMap"};return L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'})},ESRI_IMAGERY:function(c,d){c.legend={label:"ESRI Imagery"};c.name=c.type;var b="DigitalGlobe, GeoEye, i-cubed, USDA, USGS, AEX, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community";return L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; "+a+", "+b,maxZoom:19})},ESRI_STREETS:function(c,d){c.legend={label:"ESRI Streets"};c.name=c.type;var b="USGS, NOAA";return L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; "+a+", "+b,maxZoom:19})},ESRI_TOPOGRAPHIC:function(c,d){c.legend={label:"ESRI Topographic"};c.name=c.type;var b="USGS, NOAA";return L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; "+a+", "+b,maxZoom:19})},ESRI_GRAY:function(c,d){c.legend={label:"ESRI Gray"};c.name=c.type;var b="HERE, DeLorme, MapmyIndia, OpenStreetMap contributors";return L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; "+a+", "+b,maxZoom:16})},ESRI_DARKGRAY:function(c,d){c.legend={label:"ESRI Dark Gray"};c.name=c.type;var b="HERE, DeLorme, MapmyIndia, OpenStreetMap contributors";return L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; "+a+", "+b,maxZoom:16})},WMS:function(j,c){GV.Util.log("GV.layerFactory - Creazione Layer WMS: "+j.name);GV.Util.log(j);var l={tiled:true,transparent:true,TILESORIGIN:"-20037508,-20037508",FORMAT_OPTIONS:"antialias:text"};var i=(j.geomType==="VECTOR")?"image/png8":(j.cacheMinZoomLevel)?"image/jpeg":"image/png",b=(j.minScale)?GV.Util.getZoomFromScaleDenom(j.minScale):8,h=(j.maxScale)?GV.Util.getZoomFromScaleDenom(j.maxScale):20,d=j.wmsParams.url,e=j.name,g=j.opacity||1,k=(j.cacheMinZoomLevel)?256:1024;_.extend(l,{layers:e,format:i,opacity:g,minZoom:b,maxZoom:h,tileSize:k});var f=L.tileLayer.wms(d,l);f.setZIndex(j.zIndex);f.type="WMS";f.name=e;return f},JSON:function(j,b){var c=j.url,d=j.name,f=j.wfsParams,g=j.classes,m=j.tooltip,e=j.popup,i=j.dataType||"jsonp";var l={};if(g&&g.length>0){if(j.geomSubType==="POINT"){l.pointToLayer=function(n,q){var p;_.each(g,function(r){if(r.filter&&r.filter.key&&r.filter.value){if(n.properties[r.filter.key]==r.filter.value){p=r.style}}else{p=r.style}});if(p.iconUrl){var o=L.icon({iconUrl:p.iconUrl,iconSize:p.iconSize,iconAnchor:p.iconAnchor,popupAnchor:p.popupAnchor});return L.marker(q,{icon:o})}else{return L.circleMarker(q,p)}}}else{l.style=function(n){var o;_.each(g,function(p){if(p.filter&&p.filter.key&&p.filter.value){if(n.properties[p.filter.key]==p.filter.value){o=p.style}}else{o=p.style}});return o}}l.filter=function(o,n){var p=false;_.each(g,function(q){if(q.filter&&q.filter.key&&q.filter.value){if(o.properties[q.filter.key]==q.filter.value){p=true}}});return p}}if(m||e){l.onEachFeature=function(o,n){if(m){n.options.title=GV.Util.template(m,o.properties)}if(e){n.bindPopup(GV.Util.template(e,o.properties))}}}var h=L.geoJson(null,l);h.name=d;h.setFilter=function(n){h.filter=n;if(n){h.eachLayer(function(o){var p=0;_.each(n,function(q){if(o.feature.properties[q.key]==q.value){p=h.config.opacity||1}});o.setOpacity(p)})}else{h.eachLayer(function(o){var p=h.config.opacity||1;o.setOpacity(p)})}};if(f&&f.typeName&&f.url){var k={service:"WFS",version:"2.0.0",request:"GetFeature",srsName:"EPSG:4326",outputFormat:"text/javascript",format_options:"callback: getJson",typeName:f.typeName};c=f.url+GV.Util.getParamString(k);i="jsonp"}$.ajax({url:c,dataType:i,jsonpCallback:"getJson",success:function(n){h.addData(n)}});return h}}};GV.Map=L.Map.extend({rlMaps:[],layers:[],initialExtent:[],mapOptions:{zoomControl:false},initialize:function(a){this.setMapOptions(a);L.Map.prototype.initialize.call(this,"gv-map",_.extend(L.Map.prototype.options,this.mapOptions));this.setInitialExtent();this.setInfoWms(a);this.setLayersInRange()},setMapOptions:function(a){if(a.config.application&&a.config.application.layout&&a.config.application.mapOptions){_.extend(this.mapOptions,a.config.application.mapOptions)}},setInitialExtent:function(){var b=this.mapOptions.initialExtent||"830036,5402959,1123018,5597635";var d=b.split(",");var c=L.point(d[0],d[1]);var f=L.point(d[2],d[3]);var a=L.Projection.SphericalMercator.unproject(c);var e=L.Projection.SphericalMercator.unproject(f);this.initialExtent=L.latLngBounds(a,e);this.fitBounds(this.initialExtent)},setInfoWms:function(a){if(this.mapOptions.infoWms){GV.infoWmsManager=new GV.InfoWmsManager();GV.infoWmsManager.activate(this,a.config)}},setLayersInRange:function(){this.on("zoom",function(){var a=GV.rlMaps.getAllLayersConfig();_.each(a,function(b){GV.rlMaps.setLayerAttribute(b.name,"inRange",this.layerInRange(b))},this)})},setLayerVisible:function(a,b){if(b){this.loadLayers([a])}else{this.removeLayer(this.getLayerByName(a.name))}},layerInRange:function(a){return(this.getScale()<a.minScale&&this.getScale()>a.maxScale)},loadControls:function(b){if(b.config.application&&b.config.application.layout&&b.config.application.layout.controls){var a=b.config.application.layout.controls;var c;this.controls={};_.each(a,function(d){switch(d.name){case"scaleControl":c=L.control.scale({imperial:false}).addTo(this);this.controls[d]=c;break;case"zoomControl":c=L.control.zoom(d.options).addTo(this);this.controls[d]=c;break;default:break}},this)}},loadBaseLayers:function(a){_.each(a,function(b){var c=GV.layerFactory.create(b,this);if(c&&b.visible){c.addTo(this)}},this)},loadLayers:function(a){_.each(a,function(b){if(!this.getLayerByName(b.name)){var c=GV.layerFactory.create(b,this);if(c&&b.visible&&!this.getLayerByName(b.name)){c.addTo(this)}}},this)},getLayerByName:function(b){var a=null;this.eachLayer(function(c){if(c.config&&c.config.name&&c.config.name===b){a=c}});return a},getScaleLabel:function(){return GV.Util.getScaleLabelsFromZoom(this._zoom)},getScale:function(){return GV.Util.getScaleFromZoom(this._zoom)}});GV.Util=function(){return{getUrlParam:function(b){var a=new RegExp("[\\?&]"+b+"=([^&#]*)").exec(window.location.href);GV.Util.log("GV.Util.getUrlParam");return a?decodeURIComponent(a[1]):null},getUrlParamFromString:function(a,c){var b=new RegExp("[\\?&]"+c+"=([^&#]*)").exec(a);if(!b){return 0}return b[1]||0},log:function(a,d){var b="log";if(!GV.debug){return}switch(d){case 0:b="warn";break;case 1:case 2:b="error";break;default:b="info";break}try{console[b](a)}catch(c){}},msgBox:function(a){window.alert(a)},setUnderscoreTemplate:function(){if(_){_.templateSettings={interpolate:/\{\{(.+?)\}\}/g}}},ajax:function(b,c){var a={jsonpCallback:"getJson",type:"GET"};GV.Util.log("GV.Util.ajax");$.ajax(_.extend(a,b)).done(function(e){try{if(c){c(e)}}catch(d){console.error(d.message)}}).fail(function(d,f,e){if(d.statusText!=="OK"){console.error("GV.Util.ajax - Non sono riuscito a caricare la url:\n"+url+"\nErrore: "+d.status+" - "+f+" - "+e)}})},parseXML:function(c){GV.Util.log("GV.Util.parseXML");try{var b=null;if(window.DOMParser&&window.XSLTProcessor){var d=new DOMParser();b=d.parseFromString(c,"text/xml")}else{b=new ActiveXObject("Msxml2.DOMDocument.3.0");b.async=false;b.loadXML(c)}return b}catch(a){throw {name:"xmlTransformation",message:"GV.Util.parseXml: errore parsing xml - "+a.message,level:1}}},isPointInLig:function(b,f){GV.Util.log("GV.Util.isPointInLig");if(!b||!f){return false}var a=7.4,e=43.7,d=10.1,c=44.8;return(b>a)&&(b<d)&&(f>e)&&(f<c)},toArray:function(a){return Array.prototype.slice.call(a)},bind:function(b,a){return function(){return a.apply(b,GV.Util.toArray(arguments))}},getArrayElementByAttribute:function(e,c,d){if(!e){return null}var b,a=e.length;for(b=0;b<a;b++){if(e[b][c]===d){return e[b]}}return null},geoCode:function(a,b,d){var c=new google.maps.Geocoder();c.geocode({address:a},function(h,f){if(f===google.maps.GeocoderStatus.OK){var e=h[0].geometry.location.lng();var j=h[0].geometry.location.lat();var g={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Point",coordinates:[e,j]},properties:{address:a}}]};if(b){for(var i in b){if(b.hasOwnProperty(i)){g.features[0].properties[i]=b[i]}}}d(g)}else{if(f===google.maps.GeocoderStatus.ZERO_RESULTS){GV.Util.msgBox("Indirizzo '"+a+"' non trovato")}else{console.error("Errore di geocoding: "+f)}}})},getParamString:function(d,a,b){var e=[];for(var c in d){e.push(encodeURIComponent(b?c.toUpperCase():c)+"="+encodeURIComponent(d[c]))}return((!a||a.indexOf("?")===-1)?"?":"&")+e.join("&")},template:function(b,a){var c=/\{ *([\w_\-]+) *\}/g;return b.replace(c,function(f,d){var e=a[d];if(e===undefined){throw new Error("No value provided for variable "+f)}else{if(typeof e==="function"){e=e(a)}}return e})},getZoomFromScaleDenom:function(a){return _.findIndex(GV.Globals.BASE_SCALES,function(b){return a>b})},getScaleLabelsFromZoom:function(a){return GV.Globals.BASE_SCALE_LABELS[a]},getScaleFromZoom:function(a){return GV.Globals.BASE_SCALES[a]}}}();GV.Buttons.fullscreen=function(a,b){return L.control.fullscreen(a)};GV.Buttons.geocoder=function(a,b){return new L.Control.Geocoder(a)};GV.Buttons.locate=function(a,b){return new L.Control.Locate(a)};GV.Buttons.navbar=function(a,b){return L.control.navbar(a)};GV.Buttons.print=function(a,b){return L.easyButton({position:a.position,leafletClasses:true,states:[{stateName:"print",onClick:function(c,d){console.log("print")},title:"Zoom alla estensione iniziale",icon:"fa-print"}]})};GV.Buttons.zoom=function(a,b){return L.control.zoom(a)};(function(){L.Control.EasyBar=L.Control.extend({options:{position:"topleft",id:null,leafletClasses:true},initialize:function(e,c){if(c){L.Util.setOptions(this,c)}this._buildContainer();this._buttons=[];for(var d=0;d<e.length;d++){e[d]._bar=this;e[d]._container=e[d].button;this._buttons.push(e[d]);this.container.appendChild(e[d].button)}},_buildContainer:function(){this._container=this.container=L.DomUtil.create("div","");this.options.leafletClasses&&L.DomUtil.addClass(this.container,"leaflet-bar easy-button-container leaflet-control");this.options.id&&(this.container.id=this.options.id)},enable:function(){L.DomUtil.addClass(this.container,"enabled");L.DomUtil.removeClass(this.container,"disabled");this.container.setAttribute("aria-hidden","false");return this},disable:function(){L.DomUtil.addClass(this.container,"disabled");L.DomUtil.removeClass(this.container,"enabled");this.container.setAttribute("aria-hidden","true");return this},onAdd:function(){return this.container},addTo:function(f){this._map=f;for(var d=0;d<this._buttons.length;d++){this._buttons[d]._map=f}var c=this._container=this.onAdd(f),g=this.getPosition(),e=f._controlCorners[g];L.DomUtil.addClass(c,"leaflet-control");if(g.indexOf("bottom")!==-1){e.insertBefore(c,e.firstChild)}else{e.appendChild(c)}return this}});L.easyBar=function(){var c=[L.Control.EasyBar];for(var d=0;d<arguments.length;d++){c.push(arguments[d])}return new (Function.prototype.bind.apply(L.Control.EasyBar,c))};L.Control.EasyButton=L.Control.extend({options:{position:"topleft",id:null,type:"replace",states:[],leafletClasses:true,tagName:"button"},initialize:function(d,f,e,g){this.options.states=[];if(g!=null){this.options.id=g}this.storage={};if(typeof arguments[arguments.length-1]==="object"){L.Util.setOptions(this,arguments[arguments.length-1])}if(this.options.states.length===0&&typeof d==="string"&&typeof f==="function"){this.options.states.push({icon:d,onClick:f,title:typeof e==="string"?e:""})}this._states=[];for(var c=0;c<this.options.states.length;c++){this._states.push(new b(this.options.states[c],this))}this._buildButton();this._activateState(this._states[0])},_buildButton:function(){this.button=L.DomUtil.create(this.options.tagName,"");if(this.tagName==="button"){this.button.type="button"}if(this.options.id){this.button.id=this.options.id}if(this.options.leafletClasses){L.DomUtil.addClass(this.button,"leaflet-bar-part leaflet-interactive easy-button gv-bgcolor")}L.DomEvent.addListener(this.button,"dblclick",L.DomEvent.stop);L.DomEvent.addListener(this.button,"mousedown",L.DomEvent.stop);L.DomEvent.addListener(this.button,"click",function(d){L.DomEvent.stop(d);this._currentState.onClick(this,this._map?this._map:null);this._map.getContainer().focus()},this);if(this.options.type=="replace"){this.button.appendChild(this._currentState.icon)}else{for(var c=0;c<this._states.length;c++){this.button.appendChild(this._states[c].icon)}}},_currentState:{stateName:"unnamed",icon:(function(){return document.createElement("span")})()},_states:null,state:function(c){if(typeof c=="string"){this._activateStateNamed(c)}else{if(typeof c=="number"){this._activateState(this._states[c])}}return this},_activateStateNamed:function(d){for(var c=0;c<this._states.length;c++){if(this._states[c].stateName==d){this._activateState(this._states[c])}}},_activateState:function(d){if(d===this._currentState){return}else{if(this.options.type=="replace"){this.button.appendChild(d.icon);this.button.removeChild(this._currentState.icon)}if(d.title){this.button.title=d.title}else{this.button.removeAttribute("title")}for(var c=0;c<this._states.length;c++){L.DomUtil.removeClass(this._states[c].icon,this._currentState.stateName+"-active");L.DomUtil.addClass(this._states[c].icon,d.stateName+"-active")}L.DomUtil.removeClass(this.button,this._currentState.stateName+"-active");L.DomUtil.addClass(this.button,d.stateName+"-active");this._currentState=d}},enable:function(){L.DomUtil.addClass(this.button,"enabled");L.DomUtil.removeClass(this.button,"disabled");this.button.setAttribute("aria-hidden","false");return this},disable:function(){L.DomUtil.addClass(this.button,"disabled");L.DomUtil.removeClass(this.button,"enabled");this.button.setAttribute("aria-hidden","true");return this},removeFrom:function(c){this._container.parentNode.removeChild(this._container);this._map=null;return this},onAdd:function(){var c=L.easyBar([this],{position:this.options.position,leafletClasses:this.options.leafletClasses});this._container=c.container;return this._container}});L.easyButton=function(){var c=Array.prototype.concat.apply([L.Control.EasyButton],arguments);return new (Function.prototype.bind.apply(L.Control.EasyButton,c))};function b(c,d){this.title=c.title;this.stateName=c.stateName?c.stateName:"unnamed-state";this.icon=L.DomUtil.create("span","");L.DomUtil.addClass(this.icon,"button-state state-"+this.stateName.replace(/(^\s*|\s*$)/g,""));this.icon.innerHTML=a(c.icon);this.onClick=L.Util.bind(c.onClick?c.onClick:function(){},d)}function a(d){var c;if(d.match(/[&;=<>"']/)){c=d}else{d=d.replace(/(^\s*|\s*$)/g,"");c=L.DomUtil.create("span","");if(d.indexOf("fa-")===0){L.DomUtil.addClass(c,"fa "+d)}else{if(d.indexOf("glyphicon-")===0){L.DomUtil.addClass(c,"glyphicon "+d)}else{L.DomUtil.addClass(c,d)}}c=c.outerHTML}return c}})();L.Control.Fullscreen=L.Control.extend({options:{position:"topleft",title:{"false":"Schermo intero","true":"Esci da Schermo intero"}},onAdd:function(b){var a=L.DomUtil.create("div","leaflet-control-fullscreen leaflet-bar leaflet-control");this.link=L.DomUtil.create("a","ms ms-max-extent",a);this.link.href="#";this._map=b;this._map.on("fullscreenchange",this._toggleTitle,this);this._toggleTitle();L.DomEvent.on(this.link,"click",this._click,this);return a},_click:function(a){L.DomEvent.stopPropagation(a);L.DomEvent.preventDefault(a);this._map.toggleFullscreen(this.options)},_toggleTitle:function(){this.link.title=this.options.title[this._map.isFullscreen()]}});L.Map.include({isFullscreen:function(){return this._isFullscreen||false},toggleFullscreen:function(b){var a=this.getContainer();if(this.isFullscreen()){if(b&&b.pseudoFullscreen){this._disablePseudoFullscreen(a)}else{if(document.exitFullscreen){document.exitFullscreen()}else{if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else{if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}else{if(document.msExitFullscreen){document.msExitFullscreen()}else{this._disablePseudoFullscreen(a)}}}}}}else{if(b&&b.pseudoFullscreen){this._enablePseudoFullscreen(a)}else{if(a.requestFullscreen){a.requestFullscreen()}else{if(a.mozRequestFullScreen){a.mozRequestFullScreen()}else{if(a.webkitRequestFullscreen){a.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}else{if(a.msRequestFullscreen){a.msRequestFullscreen()}else{this._enablePseudoFullscreen(a)}}}}}}},_enablePseudoFullscreen:function(a){L.DomUtil.addClass(a,"leaflet-pseudo-fullscreen");this._setFullscreen(true);this.invalidateSize();this.fire("fullscreenchange")},_disablePseudoFullscreen:function(a){L.DomUtil.removeClass(a,"leaflet-pseudo-fullscreen");this._setFullscreen(false);this.invalidateSize();this.fire("fullscreenchange")},_setFullscreen:function(b){this._isFullscreen=b;var a=this.getContainer();if(b){L.DomUtil.addClass(a,"leaflet-fullscreen-on")}else{L.DomUtil.removeClass(a,"leaflet-fullscreen-on")}},_onFullscreenChange:function(b){var a=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement;if(a===this.getContainer()&&!this._isFullscreen){this._setFullscreen(true);this.fire("fullscreenchange")}else{if(a!==this.getContainer()&&this._isFullscreen){this._setFullscreen(false);this.fire("fullscreenchange")}}}});L.Map.mergeOptions({fullscreenControl:false});L.Map.addInitHook(function(){if(this.options.fullscreenControl){this.fullscreenControl=new L.Control.Fullscreen(this.options.fullscreenControl);this.addControl(this.fullscreenControl)}var b;if("onfullscreenchange" in document){b="fullscreenchange"}else{if("onmozfullscreenchange" in document){b="mozfullscreenchange"}else{if("onwebkitfullscreenchange" in document){b="webkitfullscreenchange"}else{if("onmsfullscreenchange" in document){b="MSFullscreenChange"}}}}if(b){var a=L.bind(this._onFullscreenChange,this);this.whenReady(function(){L.DomEvent.on(document,b,a)});this.on("unload",function(){L.DomEvent.off(document,b,a)})}});L.control.fullscreen=function(a){return new L.Control.Fullscreen(a)};(function(b){var a;if(typeof define==="function"&&define.amd){define(["leaflet"],b)}else{if(typeof module!=="undefined"){a=require("leaflet");module.exports=b(a)}else{if(typeof window.L==="undefined"){throw"Leaflet must be loaded first"}b(window.L)}}}(function(a){a.Control.Geocoder=a.Control.extend({options:{showResultIcons:false,collapsed:true,expand:"click",position:"topright",placeholder:"Ricerca Indirizzo...",errorMessage:"Non trovato."},_callbackId:0,initialize:function(b){a.Util.setOptions(this,b);if(!this.options.geocoder){this.options.geocoder=new a.Control.Geocoder.Nominatim()}},onAdd:function(g){var e="leaflet-control-geocoder",b=a.DomUtil.create("div",e+" leaflet-bar"),d=a.DomUtil.create("a","ms ms-zoom",b),f=this._form=a.DomUtil.create("form",e+"-form",b),c;d.innerHTML="";d.href="javascript:void(0);";this._map=g;this._container=b;c=this._input=a.DomUtil.create("input");c.type="text";c.placeholder=this.options.placeholder;a.DomEvent.addListener(c,"keydown",this._keydown,this);this._errorElement=document.createElement("div");this._errorElement.className=e+"-form-no-error";this._errorElement.innerHTML=this.options.errorMessage;this._alts=a.DomUtil.create("ul",e+"-alternatives leaflet-control-geocoder-alternatives-minimized");f.appendChild(c);this._container.appendChild(this._errorElement);b.appendChild(this._alts);a.DomEvent.addListener(f,"submit",this._geocode,this);if(this.options.collapsed){if(this.options.expand==="click"){a.DomEvent.addListener(d,"click",function(h){if(h.button===0&&h.detail!==2){this._toggle()}},this)}else{a.DomEvent.addListener(d,"mouseover",this._expand,this);a.DomEvent.addListener(d,"mouseout",this._collapse,this);this._map.on("movestart",this._collapse,this)}}else{a.DomEvent.addListener(d,"click",function(h){this._geocode(h)},this);this._expand()}a.DomEvent.disableClickPropagation(b);return b},_geocodeResult:function(c){a.DomUtil.removeClass(this._container,"leaflet-control-geocoder-throbber");if(c.length===1){this._geocodeResultSelected(c[0])}else{if(c.length>0){this._alts.innerHTML="";this._results=c;a.DomUtil.removeClass(this._alts,"leaflet-control-geocoder-alternatives-minimized");for(var b=0;b<c.length;b++){this._alts.appendChild(this._createAlt(c[b],b))}}else{a.DomUtil.addClass(this._errorElement,"leaflet-control-geocoder-error")}}},markGeocode:function(b){this._map.fitBounds(b.bbox);if(this._geocodeMarker){this._map.removeLayer(this._geocodeMarker)}this._geocodeMarker=new a.Marker(b.center).bindPopup(b.html||b.name).addTo(this._map).openPopup();return this},_geocode:function(b){a.DomEvent.preventDefault(b);a.DomUtil.addClass(this._container,"leaflet-control-geocoder-throbber");this._clearResults();this.options.geocoder.geocode(this._input.value,this._geocodeResult,this);return false},_geocodeResultSelected:function(b){if(this.options.collapsed){this._collapse()}else{this._clearResults()}this.markGeocode(b)},_toggle:function(){if(this._container.className.indexOf("leaflet-control-geocoder-expanded")>=0){this._collapse()}else{this._expand()}},_expand:function(){a.DomUtil.addClass(this._container,"leaflet-control-geocoder-expanded");this._input.select()},_collapse:function(){this._container.className=this._container.className.replace(" leaflet-control-geocoder-expanded","");a.DomUtil.addClass(this._alts,"leaflet-control-geocoder-alternatives-minimized");a.DomUtil.removeClass(this._errorElement,"leaflet-control-geocoder-error")},_clearResults:function(){a.DomUtil.addClass(this._alts,"leaflet-control-geocoder-alternatives-minimized");this._selection=null;a.DomUtil.removeClass(this._errorElement,"leaflet-control-geocoder-error")},_createAlt:function(c,e){var b=a.DomUtil.create("li",""),d=a.DomUtil.create("a","",b),f=this.options.showResultIcons&&c.icon?a.DomUtil.create("img","",d):null,g=c.html?undefined:document.createTextNode(c.name),h=function h(i){a.DomEvent.preventDefault(i);this._geocodeResultSelected(c)};if(f){f.src=c.icon}b.setAttribute("data-result-index",e);if(c.html){d.innerHTML=c.html}else{d.appendChild(g)}a.DomEvent.addListener(b,"click",h,this);return b},_keydown:function(d){var f=this,b=function b(e){if(f._selection){a.DomUtil.removeClass(f._selection,"leaflet-control-geocoder-selected");f._selection=f._selection[e>0?"nextSibling":"previousSibling"]}if(!f._selection){f._selection=f._alts[e>0?"firstChild":"lastChild"]}if(f._selection){a.DomUtil.addClass(f._selection,"leaflet-control-geocoder-selected")}};switch(d.keyCode){case 27:if(this.options.collapsed){this._collapse()}break;case 38:b(-1);a.DomEvent.preventDefault(d);break;case 40:b(1);a.DomEvent.preventDefault(d);break;case 13:if(this._selection){var c=parseInt(this._selection.getAttribute("data-result-index"),10);this._geocodeResultSelected(this._results[c]);this._clearResults();a.DomEvent.preventDefault(d)}}return true}});a.Control.geocoder=function(b){return new a.Control.Geocoder(b)};a.Control.Geocoder.callbackId=0;a.Control.Geocoder.jsonp=function(c,g,h,d,e){var f="_l_geocoder_"+(a.Control.Geocoder.callbackId++);g[e||"callback"]=f;window[f]=a.Util.bind(h,d);var b=document.createElement("script");b.type="text/javascript";b.src=c+a.Util.getParamString(g);b.id=f;document.getElementsByTagName("head")[0].appendChild(b)};a.Control.Geocoder.getJSON=function(c,d,e){var b=new XMLHttpRequest();b.onreadystatechange=function(){if(b.readyState!=4){return}if(b.status!=200&&b.status!=304){e("");return}e(JSON.parse(b.response))};b.open("GET",c+a.Util.getParamString(d),true);b.setRequestHeader("Accept","application/json");b.send(null)};a.Control.Geocoder.template=function(d,b,c){return d.replace(/\{ *([\w_]+) *\}/g,function(g,e){var f=b[e];if(f===undefined){f=""}else{if(typeof f==="function"){f=f(b)}}return a.Control.Geocoder.htmlEscape(f)})};a.Control.Geocoder.htmlEscape=(function(){var e=/[&<>"'`]/g;var c=/[&<>"'`]/;var d={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"};function b(f){return d[f]}return function(f){if(f==null){return""}else{if(!f){return f+""}}f=""+f;if(!c.test(f)){return f}return f.replace(e,b)}})();a.Control.Geocoder.Nominatim=a.Class.extend({options:{serviceUrl:"//nominatim.openstreetmap.org/",geocodingQueryParams:{},reverseQueryParams:{},htmlTemplate:function(c){var b=c.address,d=[];if(b.road||b.building){d.push("{building} {road} {house_number}")}if(b.city||b.town||b.village){d.push('<span class="'+(d.length>0?"leaflet-control-geocoder-address-detail":"")+'">{postcode} {city} {town} {village}</span>')}if(b.state||b.country){d.push('<span class="'+(d.length>0?"leaflet-control-geocoder-address-context":"")+'">{state} {country}</span>')}return a.Control.Geocoder.template(d.join("<br/>"),b,true)}},initialize:function(b){a.Util.setOptions(this,b)},geocode:function(d,b,c){a.Control.Geocoder.jsonp(this.options.serviceUrl+"search/",a.extend({q:d,limit:5,format:"json",addressdetails:1},this.options.geocodingQueryParams),function(h){var g=[];for(var f=h.length-1;f>=0;f--){var k=h[f].boundingbox;for(var e=0;e<4;e++){k[e]=parseFloat(k[e])}g[f]={icon:h[f].icon,name:h[f].display_name,html:this.options.htmlTemplate?this.options.htmlTemplate(h[f]):undefined,bbox:a.latLngBounds([k[0],k[2]],[k[1],k[3]]),center:a.latLng(h[f].lat,h[f].lon),properties:h[f]}}b.call(c,g)},this,"json_callback")},reverse:function(c,e,b,d){a.Control.Geocoder.jsonp(this.options.serviceUrl+"reverse/",a.extend({lat:c.lat,lon:c.lng,zoom:Math.round(Math.log(e/256)/Math.log(2)),addressdetails:1,format:"json"},this.options.reverseQueryParams),function(g){var f=[],h;if(g&&g.lat&&g.lon){h=a.latLng(g.lat,g.lon);f.push({name:g.display_name,html:this.options.htmlTemplate?this.options.htmlTemplate(g):undefined,center:h,bounds:a.latLngBounds(h,h),properties:g})}b.call(d,f)},this,"json_callback")}});a.Control.Geocoder.nominatim=function(b){return new a.Control.Geocoder.Nominatim(b)};a.Control.Geocoder.Bing=a.Class.extend({initialize:function(b){this.key=b},geocode:function(d,b,c){a.Control.Geocoder.jsonp("//dev.virtualearth.net/REST/v1/Locations",{query:d,key:this.key},function(h){var f=[];if(h.resourceSets.length>0){for(var e=h.resourceSets[0].resources.length-1;e>=0;e--){var g=h.resourceSets[0].resources[e],j=g.bbox;f[e]={name:g.name,bbox:a.latLngBounds([j[0],j[1]],[j[2],j[3]]),center:a.latLng(g.point.coordinates)}}}b.call(c,f)},this,"jsonp")},reverse:function(c,e,b,d){a.Control.Geocoder.jsonp("//dev.virtualearth.net/REST/v1/Locations/"+c.lat+","+c.lng,{key:this.key},function(j){var g=[];for(var f=j.resourceSets[0].resources.length-1;f>=0;f--){var h=j.resourceSets[0].resources[f],k=h.bbox;g[f]={name:h.name,bbox:a.latLngBounds([k[0],k[1]],[k[2],k[3]]),center:a.latLng(h.point.coordinates)}}b.call(d,g)},this,"jsonp")}});a.Control.Geocoder.bing=function(b){return new a.Control.Geocoder.Bing(b)};a.Control.Geocoder.RaveGeo=a.Class.extend({options:{querySuffix:"",deepSearch:true,wordBased:false},jsonp:function(f,h,c){var d="_l_geocoder_"+(a.Control.Geocoder.callbackId++),g=[];f.prepend=d+"(";f.append=")";for(var e in f){g.push(e+"="+escape(f[e]))}window[d]=a.Util.bind(h,c);var b=document.createElement("script");b.type="text/javascript";b.src=this._serviceUrl+"?"+g.join("&");b.id=d;document.getElementsByTagName("head")[0].appendChild(b)},initialize:function(d,b,c){a.Util.setOptions(this,c);this._serviceUrl=d;this._scheme=b},geocode:function(d,b,c){a.Control.Geocoder.jsonp(this._serviceUrl,{address:d+this.options.querySuffix,scheme:this._scheme,outputFormat:"jsonp",deepSearch:this.options.deepSearch,wordBased:this.options.wordBased},function(h){var f=[];for(var e=h.length-1;e>=0;e--){var g=h[e],j=a.latLng(g.y,g.x);f[e]={name:g.address,bbox:a.latLngBounds([j]),center:j}}b.call(c,f)},this)}});a.Control.Geocoder.raveGeo=function(d,b,c){return new a.Control.Geocoder.RaveGeo(d,b,c)};a.Control.Geocoder.MapQuest=a.Class.extend({options:{serviceUrl:"//www.mapquestapi.com/geocoding/v1"},initialize:function(c,b){this._key=decodeURIComponent(c);a.Util.setOptions(this,b)},_formatName:function(){var c=[],b;for(b=0;b<arguments.length;b++){if(arguments[b]){c.push(arguments[b])}}return c.join(", ")},geocode:function(d,b,c){a.Control.Geocoder.jsonp(this.options.serviceUrl+"/address",{key:this._key,location:d,limit:5,outFormat:"json"},function(h){var f=[],j,g;if(h.results&&h.results[0].locations){for(var e=h.results[0].locations.length-1;e>=0;e--){j=h.results[0].locations[e];g=a.latLng(j.latLng);f[e]={name:this._formatName(j.street,j.adminArea4,j.adminArea3,j.adminArea1),bbox:a.latLngBounds(g,g),center:g}}}b.call(c,f)},this)},reverse:function(c,e,b,d){a.Control.Geocoder.jsonp(this.options.serviceUrl+"/reverse",{key:this._key,location:c.lat+","+c.lng,outputFormat:"json"},function(j){var g=[],k,h;if(j.results&&j.results[0].locations){for(var f=j.results[0].locations.length-1;f>=0;f--){k=j.results[0].locations[f];h=a.latLng(k.latLng);g[f]={name:this._formatName(k.street,k.adminArea4,k.adminArea3,k.adminArea1),bbox:a.latLngBounds(h,h),center:h}}}b.call(d,g)},this)}});a.Control.Geocoder.mapQuest=function(c,b){return new a.Control.Geocoder.MapQuest(c,b)};a.Control.Geocoder.Mapbox=a.Class.extend({options:{service_url:"https://api.tiles.mapbox.com/v4/geocode/mapbox.places-v1/"},initialize:function(b){this._access_token=b},geocode:function(d,b,c){a.Control.Geocoder.getJSON(this.options.service_url+encodeURIComponent(d)+".json",{access_token:this._access_token,},function(h){var f=[],k,g,j;if(h.features&&h.features.length){for(var e=0;e<=h.features.length-1;e++){k=h.features[e];g=a.latLng(k.center.reverse());if(k.hasOwnProperty("bbox")){j=a.latLngBounds(a.latLng(k.bbox.slice(0,2).reverse()),a.latLng(k.bbox.slice(2,4).reverse()))}else{j=a.latLngBounds(g,g)}f[e]={name:k.place_name,bbox:j,center:g}}}b.call(c,f)})},suggest:function(d,b,c){return this.geocode(d,b,c)},reverse:function(c,e,b,d){a.Control.Geocoder.getJSON(this.options.service_url+encodeURIComponent(c.lng)+","+encodeURIComponent(c.lat)+".json",{access_token:this._access_token,},function(j){var g=[],l,h,k;if(j.features&&j.features.length){for(var f=0;f<=j.features.length-1;f++){l=j.features[f];h=a.latLng(l.center.reverse());if(l.hasOwnProperty("bbox")){k=a.latLngBounds(a.latLng(l.bbox.slice(0,2).reverse()),a.latLng(l.bbox.slice(2,4).reverse()))}else{k=a.latLngBounds(h,h)}g[f]={name:l.place_name,bbox:k,center:h}}}b.call(d,g)})}});a.Control.Geocoder.mapbox=function(b){return new a.Control.Geocoder.Mapbox(b)};a.Control.Geocoder.What3Words=a.Class.extend({options:{serviceUrl:"http://api.what3words.com/"},initialize:function(b){this._accessToken=b},geocode:function(d,b,c){a.Control.Geocoder.getJSON(this.options.serviceUrl+"w3w",{key:this._accessToken,string:d.split(/\s+/).join("."),},function(g){var e=[],i,f,h;if(g.position&&g.position.length){i=g.words;f=a.latLng(g.position[0],g.position[1]);h=a.latLngBounds(f,f);e[0]={name:i.join("."),bbox:h,center:f}}b.call(c,e)})},suggest:function(d,b,c){return this.geocode(d,b,c)},reverse:function(c,e,b,d){a.Control.Geocoder.getJSON(this.options.serviceUrl+"position",{key:this._accessToken,position:[c.lat,c.lng].join(",")},function(h){var f=[],j,g,i;if(h.position&&h.position.length){j=h.words;g=a.latLng(h.position[0],h.position[1]);i=a.latLngBounds(g,g);f[0]={name:j.join("."),bbox:i,center:g}}b.call(d,f)})}});a.Control.Geocoder.what3words=function(b){return new a.Control.Geocoder.What3Words(b)};a.Control.Geocoder.Google=a.Class.extend({options:{service_url:"https://maps.googleapis.com/maps/api/geocode/json"},initialize:function(b){this._key=b},geocode:function(d,b,c){var e={address:d,};if(this._key&&this._key.length){e.key=this._key}a.Control.Geocoder.getJSON(this.options.service_url,e,function(j){var g=[],l,h,k;if(j.results&&j.results.length){for(var f=0;f<=j.results.length-1;f++){l=j.results[f];h=a.latLng(l.geometry.location);k=a.latLngBounds(a.latLng(l.geometry.viewport.northeast),a.latLng(l.geometry.viewport.southwest));g[f]={name:l.formatted_address,bbox:k,center:h}}}b.call(c,g)})},reverse:function(c,f,b,d){var e={latlng:encodeURIComponent(c.lat)+","+encodeURIComponent(c.lng)};if(this._key&&this._key.length){e.key=this._key}a.Control.Geocoder.getJSON(this.options.service_url,e,function(k){var h=[],m,j,l;if(k.results&&k.results.length){for(var g=0;g<=k.results.length-1;g++){m=k.results[g];j=a.latLng(m.geometry.location);l=a.latLngBounds(a.latLng(m.geometry.viewport.northeast),a.latLng(m.geometry.viewport.southwest));h[g]={name:m.formatted_address,bbox:l,center:j}}}b.call(d,h)})}});a.Control.Geocoder.google=function(b){return new a.Control.Geocoder.Google(b)};a.Control.Geocoder.Photon=a.Class.extend({options:{serviceUrl:"//photon.komoot.de/api/",reverseUrl:"//photon.komoot.de/reverse/",nameProperties:["name","street","suburb","hamlet","town","city","state","country"]},initialize:function(b){a.setOptions(this,b)},geocode:function(d,b,c){var e=a.extend({q:d,},this.options.geocodingQueryParams);a.Control.Geocoder.getJSON(this.options.serviceUrl,e,a.bind(function(f){b.call(c,this._decodeFeatures(f))},this))},suggest:function(d,b,c){return this.geocode(d,b,c)},reverse:function(d,f,b,c){var e=a.extend({lat:d.lat,lon:d.lng},this.options.geocodingQueryParams);a.Control.Geocoder.getJSON(this.options.reverseUrl,e,a.bind(function(g){b.call(c,this._decodeFeatures(g))},this))},_decodeFeatures:function(j){var d=[],b,h,l,g,e,k;if(j&&j.features){for(b=0;b<j.features.length;b++){h=j.features[b];l=h.geometry.coordinates;g=a.latLng(l[1],l[0]);e=h.properties.extent;if(e){k=a.latLngBounds([e[1],e[0]],[e[3],e[2]])}else{k=a.latLngBounds(g,g)}d.push({name:this._deocodeFeatureName(h),center:g,bbox:k,properties:h.properties})}}return d},_deocodeFeatureName:function(d){var c,b;for(c=0;!b&&c<this.options.nameProperties.length;c++){b=d.properties[this.options.nameProperties[c]]}return b}});a.Control.Geocoder.photon=function(b){return new a.Control.Geocoder.Photon(b)};return a.Control.Geocoder}));
/*
 Copyright (c) 2016 Dominik Moritz

 This file is part of the leaflet locate control. It is licensed under the MIT license.
 You can find the project at: https://github.com/domoritz/leaflet-locatecontrol
 */
(function(a,b){if(typeof define==="function"&&define.amd){define(["leaflet"],a)}else{if(typeof exports==="object"){if(typeof b!=="undefined"&&b.L){module.exports=a(L)}else{module.exports=a(require("leaflet"))}}}if(typeof b!=="undefined"&&b.L){b.L.Control.Locate=a(L)}}(function(a){var b=a.Control.extend({options:{position:"topleft",layer:undefined,setView:"untilPan",keepCurrentZoomLevel:false,clickBehavior:{inView:"stop",outOfView:"setView",},drawCircle:true,drawMarker:true,markerClass:a.CircleMarker,circleStyle:{color:"#136AEC",fillColor:"#136AEC",fillOpacity:0.15,weight:2,opacity:0.5},markerStyle:{color:"#136AEC",fillColor:"#2A93EE",fillOpacity:0.7,weight:2,opacity:0.9,radius:5},followCircleStyle:{},followMarkerStyle:{},icon:"fa fa-map-marker",iconLoading:"fa fa-spinner fa-spin",iconElementTag:"span",circlePadding:[0,0],metric:true,onLocationError:function(c,d){alert(c.message)},onLocationOutsideMapBounds:function(c){c.stop();alert(c.options.strings.outsideMapBoundsMsg)},showPopup:true,strings:{title:"Show me where I am",metersUnit:"meters",feetUnit:"feet",popup:"You are within {distance} {unit} from this point",outsideMapBoundsMsg:"You seem located outside the boundaries of the map"},locateOptions:{maxZoom:Infinity,watch:true,setView:false}},initialize:function(c){for(var d in c){if(typeof this.options[d]==="object"){a.extend(this.options[d],c[d])}else{this.options[d]=c[d]}}this.options.followMarkerStyle=a.extend({},this.options.markerStyle,this.options.followMarkerStyle);this.options.followCircleStyle=a.extend({},this.options.circleStyle,this.options.followCircleStyle)},onAdd:function(d){var c=a.DomUtil.create("div","leaflet-control-locate leaflet-bar leaflet-control");this._layer=this.options.layer||new a.LayerGroup();this._layer.addTo(d);this._event=undefined;this._link=a.DomUtil.create("a","leaflet-bar-part leaflet-bar-part-single",c);this._link.href="#";this._link.title=this.options.strings.title;this._icon=a.DomUtil.create(this.options.iconElementTag,this.options.icon,this._link);a.DomEvent.on(this._link,"click",a.DomEvent.stopPropagation).on(this._link,"click",a.DomEvent.preventDefault).on(this._link,"click",this._onClick,this).on(this._link,"dblclick",a.DomEvent.stopPropagation);this._resetVariables();this._map.on("unload",this._unload,this);return c},_onClick:function(){this._justClicked=true;this._userPanned=false;if(this._active&&!this._event){this.stop()}else{if(this._active&&this._event!==undefined){var c=this._map.getBounds().contains(this._event.latlng)?this.options.clickBehavior.inView:this.options.clickBehavior.outOfView;switch(c){case"setView":this.setView();break;case"stop":this.stop();break}}else{this.start()}}this._updateContainerStyle()},start:function(){this._activate();if(this._event){this._drawMarker(this._map);if(this.options.setView){this.setView()}}this._updateContainerStyle()},stop:function(){this._deactivate();this._cleanClasses();this._resetVariables();this._removeMarker()},_activate:function(){if(!this._active){this._map.locate(this.options.locateOptions);this._active=true;this._map.on("locationfound",this._onLocationFound,this);this._map.on("locationerror",this._onLocationError,this);this._map.on("dragstart",this._onDrag,this)}},_deactivate:function(){this._map.stopLocate();this._active=false;this._map.off("locationfound",this._onLocationFound,this);this._map.off("locationerror",this._onLocationError,this);this._map.off("dragstart",this._onDrag,this)},setView:function(){if(this._isOutsideMapBounds()){this.options.onLocationOutsideMapBounds(this)}else{if(this.options.keepCurrentZoomLevel){this._map.panTo([this._event.latitude,this._event.longitude])}else{this._map.fitBounds(this._event.bounds,{padding:this.options.circlePadding,maxZoom:this.options.locateOptions.maxZoom})}}this._drawMarker()},_drawMarker:function(){if(this._event.accuracy===undefined){this._event.accuracy=0}var c=this._event.accuracy;var i=this._event.latlng;if(this.options.drawCircle){var f=this._isFollowing()?this.options.followCircleStyle:this.options.circleStyle;if(!this._circle){this._circle=a.circle(i,c,f).addTo(this._layer)}else{this._circle.setLatLng(i).setRadius(c).setStyle(f)}}var h,g;if(this.options.metric){h=c.toFixed(0);g=this.options.strings.metersUnit}else{h=(c*3.2808399).toFixed(0);g=this.options.strings.feetUnit}if(this.options.drawMarker){var d=this._isFollowing()?this.options.followMarkerStyle:this.options.markerStyle;if(!this._marker){this._marker=new this.options.markerClass(i,d).addTo(this._layer)}else{this._marker.setLatLng(i).setStyle(d)}}var e=this.options.strings.popup;if(this.options.showPopup&&e&&this._marker){this._marker.bindPopup(a.Util.template(e,{distance:h,unit:g}))._popup.setLatLng(i)}},_removeMarker:function(){this._layer.clearLayers();this._marker=undefined;this._circle=undefined},_unload:function(){this.stop();this._map.off("unload",this._unload,this)},_onLocationError:function(c){if(c.code==3&&this.options.locateOptions.watch){return}this.stop();this.options.onLocationError(c,this)},_onLocationFound:function(c){if(this._event&&(this._event.latlng.lat===c.latlng.lat&&this._event.latlng.lng===c.latlng.lng&&this._event.accuracy===c.accuracy)){return}if(!this._active){return}this._event=c;this._drawMarker();this._updateContainerStyle();switch(this.options.setView){case"once":if(this._justClicked){this.setView()}break;case"untilPan":if(!this._userPanned){this.setView()}break;case"always":this.setView();break;case false:break}this._justClicked=false},_onDrag:function(){if(this._event){this._userPanned=true;this._updateContainerStyle();this._drawMarker()}},_isFollowing:function(){if(!this._active){return false}if(this.options.setView==="always"){return true}else{if(this.options.setView==="untilPan"){return !this._userPanned}}},_isOutsideMapBounds:function(){if(this._event===undefined){return false}return this._map.options.maxBounds&&!this._map.options.maxBounds.contains(this._event.latlng)},_updateContainerStyle:function(){if(!this._container){return}if(this._active&&!this._event){this._setClasses("requesting")}else{if(this._isFollowing()){this._setClasses("following")}else{if(this._active){this._setClasses("active")}else{this._cleanClasses()}}}},_setClasses:function(c){if(c=="requesting"){a.DomUtil.removeClasses(this._container,"active following");a.DomUtil.addClasses(this._container,"requesting");a.DomUtil.removeClasses(this._icon,this.options.icon);a.DomUtil.addClasses(this._icon,this.options.iconLoading)}else{if(c=="active"){a.DomUtil.removeClasses(this._container,"requesting following");a.DomUtil.addClasses(this._container,"active");a.DomUtil.removeClasses(this._icon,this.options.iconLoading);a.DomUtil.addClasses(this._icon,this.options.icon)}else{if(c=="following"){a.DomUtil.removeClasses(this._container,"requesting");a.DomUtil.addClasses(this._container,"active following");a.DomUtil.removeClasses(this._icon,this.options.iconLoading);a.DomUtil.addClasses(this._icon,this.options.icon)}}}},_cleanClasses:function(){a.DomUtil.removeClass(this._container,"requesting");a.DomUtil.removeClass(this._container,"active");a.DomUtil.removeClass(this._container,"following");a.DomUtil.removeClasses(this._icon,this.options.iconLoading);a.DomUtil.addClasses(this._icon,this.options.icon)},_resetVariables:function(){this._active=false;this._justClicked=false;this._userPanned=false}});a.control.locate=function(c){return new a.Control.Locate(c)};(function(){var c=function(f,d,e){e=e.split(" ");e.forEach(function(g){a.DomUtil[f].call(this,d,g)})};a.DomUtil.addClasses=function(d,e){c("addClass",d,e)};a.DomUtil.removeClasses=function(d,e){c("removeClass",d,e)}})();return b},window));(function(){L.Control.NavBar=L.Control.extend({options:{position:"topleft",forwardTitle:"Vai avanti",backTitle:"Via indietro",homeTitle:"Vai alla estensione iniziale"},onAdd:function(c){if(!this.options.center){this.options.center=c.getCenter()}if(!this.options.zoom){this.options.zoom=c.getZoom()}options=this.options;var b="leaflet-control-navbar",a=L.DomUtil.create("div",b+" leaflet-bar");this._homeButton=this._createButton(options.homeTitle,"fa fa-home",a,this._goHome);this._fwdButton=this._createButton(options.forwardTitle,"fa fa-caret-right",a,this._goFwd);this._backButton=this._createButton(options.backTitle,"fa fa-caret-left",a,this._goBack);this._viewHistory=[{center:this.options.center,zoom:this.options.zoom}];this._curIndx=0;this._updateDisabled();c.once("moveend",function(){this._map.on("moveend",this._updateHistory,this)},this);c.setView(options.center,options.zoom);return a},onRemove:function(a){a.off("moveend",this._updateHistory,this)},_goHome:function(){if(this.options.bbox){try{this._map.fitBounds(this.options.bbox)}catch(a){this._map.setView(this.options.center,this.options.zoom)}}this._map.setView(this.options.center,this.options.zoom)},_goBack:function(){if(this._curIndx!==0){this._map.off("moveend",this._updateHistory,this);this._map.once("moveend",function(){this._map.on("moveend",this._updateHistory,this)},this);this._curIndx--;this._updateDisabled();var a=this._viewHistory[this._curIndx];this._map.setView(a.center,a.zoom)}},_goFwd:function(){if(this._curIndx!=this._viewHistory.length-1){this._map.off("moveend",this._updateHistory,this);this._map.once("moveend",function(){this._map.on("moveend",this._updateHistory,this)},this);this._curIndx++;this._updateDisabled();var a=this._viewHistory[this._curIndx];this._map.setView(a.center,a.zoom)}},_createButton:function(e,c,a,b){var d=L.DomUtil.create("a",c,a);d.href="#";d.title=e;L.DomEvent.on(d,"mousedown dblclick",L.DomEvent.stopPropagation).on(d,"click",L.DomEvent.stop).on(d,"click",b,this).on(d,"click",this._refocusOnMap,this);return d},_updateHistory:function(){var b={center:this._map.getCenter(),zoom:this._map.getZoom()};var a=this._curIndx+1;this._viewHistory.splice(a,this._viewHistory.length-a,b);this._curIndx++;this._updateDisabled()},_setFwdEnabled:function(b){var a="leaflet-disabled";var c="leaflet-control-navbar-fwd-disabled";if(b===true){L.DomUtil.removeClass(this._fwdButton,c);L.DomUtil.removeClass(this._fwdButton,a)}else{L.DomUtil.addClass(this._fwdButton,c);L.DomUtil.addClass(this._fwdButton,a)}},_setBackEnabled:function(c){var b="leaflet-disabled";var a="leaflet-control-navbar-back-disabled";if(c===true){L.DomUtil.removeClass(this._backButton,a);L.DomUtil.removeClass(this._backButton,b)}else{L.DomUtil.addClass(this._backButton,a);L.DomUtil.addClass(this._backButton,b)}},_updateDisabled:function(){if(this._curIndx==(this._viewHistory.length-1)){this._setFwdEnabled(false)}else{this._setFwdEnabled(true)}if(this._curIndx<=0){this._setBackEnabled(false)}else{this._setBackEnabled(true)}}});L.control.navbar=function(a){return new L.Control.NavBar(a)}})();GV.Models.RlLayer=Backbone.Model.extend({initialize:function(){if(this.get("minScale")===0){this.set("minScale",591657550)}this.set("zIndex",GV.layerFactory.lastZIndex++);if(GV.app.map){this.set("inRange",GV.app.map.layerInRange(this.attributes))}else{this.set("inRange",true)}}});GV.Models.RlLayers=Backbone.Collection.extend({model:GV.Models.RlLayer});GV.Models.RlMap=Backbone.Model.extend({urlRoot:"/geoservices/REST/config/map/",initialize:function(){var a=new GV.Models.RlLayers(this.get("layers"));a.models=a.models.reverse();this.set("layers",a);this.get("layers").on("change",this.layersChanged,this);this.set("type","map")},layersChanged:function(a){this.trigger("layer:change",a)},parse:function(a){return a.data},toJSON:function(){var a=Backbone.Model.prototype.toJSON.call(this);if(a.layers&&a.layers.toJSON){a.layers=a.layers.toJSON()}return a}});GV.Models.RlMaps=Backbone.Collection.extend({model:GV.Models.RlMap,url:"/geoservices/REST/config/map/",add:function(c,a){var b={at:0};if(a){_.extend(b,a)}Backbone.Collection.prototype.add.call(this,c,b)},getLayerConfig:function(b){var a=null;_.each(this.models,function(d){var c=d.get("layers").models;a=_.find(c,function(e){return e.attributes.name===b})});if(a){return a.attributes}},getAllLayersConfig:function(){var a=[];_.each(this.models,function(b){_.each(b.get("layers").toJSON(),function(c){a.push(c)})});return a},setLayerAttribute:function(b,c,d){var a=null;_.each(this.models,function(f){var e=f.get("layers").models;_.each(e,function(g){if(g.get("name")===b){g.set(c,d)}})})}});GV.Views.Layout=Marionette.LayoutView.extend({template:false,controls:[],initialize:function(a){this.el=a.el;this.addMap(a);this.listenTo(GV.rlMaps,"add",this.onAddMap)},render:function(a){var b=a.config.application.layout;if(this.map&&this.map.loadBaseLayers){this.map.loadBaseLayers(a.config.baseLayers)}if(this.map&&this.map.loadControls){this.map.loadControls(a)}if(b.toolbar){this.addToolbars(b.toolbar)}if(b.legend){this.addLegend(b.legend)}return this},addMap:function(b){var a=new GV.Views.MapView();$(b.el).append(a.el);a.render(b);this.map=a.map},addToolbars:function(a){_.each(a,function(c){var b=c.position||"topleft";_.each(c.items,function(e){var d=e.options||{};d.position=b;if(GV.Buttons[e.name]){var f=GV.Buttons[e.name](d,this.map);f.name=e.name;this.controls.push(f);f.addTo(this.map)}else{console.log("Bottone "+e.name+" non esistente")}},this)},this)},addLegend:function(b){var a=$("#gv-container");a.append("<div id='gv-legend-button'> </div>");this.addRegions({legendButton:"#gv-legend-button"});var c=new GV.Views.LegendButton();this.legendButton.show(c);a.append("<div id='gv-legend' style='display:none;'></div>");this.addRegions({legend:"#gv-legend"});var d=new GV.Views.LegendLayout();this.legend.show(d);d.title.show(new GV.Views.LegendTitle());d.body.show(new GV.Views.LegendBody({collection:GV.rlMaps}));if(b.show){$("#gv-legend").css({display:"block"});$("#gv-legend-button").css({display:"none"})}},onAddMap:function(a){var b=a.attributes.layers.toJSON();this.map.loadLayers(b)}});GV.Views.LegendItem=Marionette.CompositeView.extend({tagName:"ul",className:"gv-list-group",getTemplate:function(){var a;if(this.model.get("type")==="map"){if(GV.app.config.application.layout.legend.showMapInfoButton){a=['<li class="gv-list-legend-map-item"><%= name %>','<a class="gv-legend-map-info ms ms-information" title="Scheda metadati" href="/geoservices/REST/metadata/scheda_xml/<%= id %>?style=metadati.xsl" target="_blank"></a>',"</li>"].join("\n");return _.template(a)}else{return _.template("<li class='gv-list-legend-map-item'><%= name %></li>")}}else{if(this.model.get("inRange")){if(this.model.get("visible")){a=['<li class="gv-list-legend-layer-item">',"<div>",'<img class="gv-legend-layer-icon" src="<%= legend.icon %>" width="24px" height="24px">','<span class="gv-layer-visibility-span"><input type="checkbox" class="gv-layer-visibility-cb" checked></span>','<span class="gv-layer-title-span"><%= title %></span>',"</div>","</li>"].join("\n");return _.template(a)}else{a=['<li class="gv-list-legend-layer-item">','<img class="gv-legend-layer-icon" src="<%= legend.icon %>" width="24px" height="24px">','<span class="gv-layer-visibility-span"><input type="checkbox" class="gv-layer-visibility-cb"></span>','<span class="gv-layer-title-span"><%= title %></span>',"</li>"].join("\n");return _.template(a)}}else{a=['<li class="gv-list-legend-layer-disabled-item">','<img class="gv-legend-layer-icon" src="<%= legend.icon %>" width="24px" height="24px">','<span class="gv-layer-visibility-span"><input type="checkbox" class="gv-layer-visibility-cb" disabled></span>','<span class="gv-layer-title-span"><%= title %></span>',"</li>"].join("\n");return _.template(a)}}},initialize:function(){this.collection=this.model.get("layers");this.listenTo(this.collection,"change:inRange",this.onChangeInRangeLayer)},onChangeInRangeLayer:function(a){console.log("GV.Views.LegendItem: onChangeInRangeLayer");console.log(a);this.render()},events:{"click .gv-layer-visibility-cb":"setLayerVisibility"},setLayerVisibility:function(c){var a=this.model.attributes;if(a.type!=="map"){var b=c.currentTarget.checked;c.stopPropagation();this.model.set("visible",b);GV.app.map.setLayerVisible(a,b)}}});GV.Views.LegendBody=Marionette.CollectionView.extend({tagName:"ul",className:"gv-list-group",childView:GV.Views.LegendItem});GV.Views.LegendTitle=Marionette.ItemView.extend({className:"gv-legend-title gv-bgcolor",events:{"click .gv-close":"hideLegend","click .gv-legend-add":"addMap"},hideLegend:function(){$("#gv-legend").fadeOut("slow");$("#gv-legend-button").css({display:"block"})},addMap:function(){},getTemplate:function(){var a=["<div>","<b>LEGENDA</b>","<button class='gv-close' type='button'>Ã</button>","<button class='gv-legend-add ms ms-layers-add' title='Aggiungi Mappa' type='button'></button>","</div>",""].join("\n");return _.template(a)}});GV.Views.LegendLayout=Marionette.LayoutView.extend({template:_.template("<div id='gv-legend-title'></div><div id='gv-legend-body'></div>"),regions:{title:"#gv-legend-title",body:"#gv-legend-body"}});GV.Views.LegendButton=Marionette.ItemView.extend({template:_.template("<div  class='gv-legend-button gv-bgcolor gv-legend-button ms ms-layers-o' title='Legenda'></div>"),events:{click:"showLegend"},showLegend:function(){$("#gv-legend").fadeIn("slow")}});GV.Views.MapView=Backbone.View.extend({id:"gv-map",render:function(a){var b=a.mapType||"leaflet";if(b==="leaflet"){this.map=new GV.Map(a)}return this}});