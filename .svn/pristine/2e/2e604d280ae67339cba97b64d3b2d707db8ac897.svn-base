<template>
    <div id="gv-container">
        <gv-header v-if="showHeader"></gv-header>
        <gv-map ref="gv-map"></gv-map>
        <div v-show="showTitle" class="gv-color-scheme" id="gv-title">{{this.getTitle()}}</div>
        <gv-legend ref="gv-legend" v-if="showLegend"></gv-legend>
    </div>
</template>


<script>
import globals from '../globals'

import isTouch from '../util/isTouch'
import getProtocol from '../util/getProtocol'
import mountComponent from '../util/mountComponent'
import Vue from 'vue'

// Componenti Vue
import Map from './Map'
Vue.component('gv-map', Map)
import Legend from './Legend'
Vue.component('gv-legend', Legend)
import Header from './Header'
Vue.component('gv-header', Header)
// Componenti lazy
Vue.component('gv-iframe-panel', () => import('./IFrame.vue'))
Vue.component('gv-info-wms-list', () => import('./InfoWmsList.vue'))
Vue.component('gv-info-wms-html', () => import('./InfoWmsHtml.vue'))

export default {
  name: 'gv-app',
  data() {
    return {
      showHeader: GV.config.application.layout.header,
      showTitle: GV.config.application.layout.title,
      showLegend: GV.config.application.layout.legend,
    }
  },
  created() {
    GV.log('gv-app: created')
    // imposto GV.app in modo da averlo a disposizione appena creato il componente
    GV.app = this
  },
  mounted() {
    GV.log('gv-app: mounted')
    // gestione toolbar
    this.addToolbars(GV.config.application.layout.toolbar)

    GV.eventBus.$emit('gv-app-mounted', this)

    if (GV.loadingInstance) {
      GV.loadingInstance.close()
    }
  },
  methods: {
    getTitle() {
      return GV.config.title
    },
    getMaps() {
      return GV.config.maps
    },
    addToolbars() {
      if (GV.config.application.layout.toolbar) {
        var toolbar = GV.config.application.layout.toolbar
        toolbar.forEach(tb => {
          const position = tb.position || 'topleft'
          tb.items.forEach(item => {
            item.options = item.options || {}
            item.options.position = item.options.position || position
            this.addButton(item)
          })
        })
      }
    },
    addButton(item) {
      if (GV.Buttons[item.name]) {
        var button = GV.Buttons[item.name](item.options, GV.app.map)
        if (button) {
          button.name = item.name
          button.addTo(GV.app.map)
          GV.app.map.buttons.push(button)
          if (button.options.vueComponent) {
            this.mountBtnComponent(button.options.vueComponent)
          }
          if (button.options.callBack) {
            button.options.callBack(button)
          }
          if (button.options.autoClick) {
            setTimeout(function() {
              button.button.click()
            }, 1)
          }
        }
      } else {
        throw new Error('Bottone ' + item.name + ' non esistente')
      }
    },
    mountBtnComponent(options) {
      mountComponent({
        containerId: options.containerId,
        elId: options.id,
        vm: new Vue({
          template: `<${options.id}></${options.id}>`,
        }),
        toggleEl: false,
      })
    },
    setTitle(mapConfig) {
      // Imposto titolo
      if (GV.config.application.layout.title === '{map.title}') {
        GV.config.title = mapConfig.name
      }
    },
  },
}
</script>


<style>

</style>