/**
 * Created by parodi on 02/08/2016.
 */


GV.InfoWmsManager = function () {
    'use strict';
    return {
        _requestCount: 0,
        _numRequests: 0,
        _features: [],

        activate: function (map) {
            GV.Util.log('GV.infoWmsManager.activate');

            // Attivo evento click
            map.on('click', GV.infoWmsManager.request);
        },

        buildWMSOptions: function (url, layers, latlng) {
            var point = GV.app.map.latLngToContainerPoint(latlng, GV.app.map.getZoom()),
                size = GV.app.map.getSize(),
                bounds = GV.app.map.getBounds(),
                sw = GV.app.map.options.crs.project(bounds.getSouthWest()),
                ne = GV.app.map.options.crs.project(bounds.getNorthEast());

            var params = {
                request: 'GetFeatureInfo',
                service: 'WMS',
                crs: 'EPSG:3857',
                styles: '',
                version: '1.1.0',
                format: 'application/json',
                bbox: sw.x + ',' + sw.y + ',' + ne.x + ',' + ne.y,
                height: size.y,
                width: size.x,
                layers: layers,
                query_layers: layers,
                FEATURE_COUNT: 100,
                buffer: 10,
                info_format: 'application/json'
            };

            _.extend(params, {});
            params[params.version === '1.3.0' ? 'i' : 'x'] = point.x;
            params[params.version === '1.3.0' ? 'j' : 'y'] = point.y;

            //TODO gestione PROXY
            return GV.app.proxy + url + GV.Util.getParamString(params, url, true);
        },

        handleResponse: function(features) {
            GV.infoWmsManager._requestCount++;
            _.each(features, function (feature) {
                feature.layer = feature.id.split('.')[0];
            });
            Array.prototype.push.apply(GV.infoWmsManager._features, features);
            if (GV.infoWmsManager._requestCount === GV.infoWmsManager._numRequests) {
                $('.leaflet-container').css('cursor', 'default');
                //TODO gestire output
                console.log(GV.infoWmsManager._features);
                alert('GFI' + GV.infoWmsManager._features.length);
            }

            /*
             var feature = response.features[0];
             if (feature) {
             L.popup()
             .setLatLng(e.latlng)
             .setContent(L.Util.template("<h2>{COD_PROV}</h2>", feature.properties))
             .openOn(map);
             }
             */
        },

        request: function (e) {
            GV.infoWmsManager._requestCount = 0;
            GV.infoWmsManager._numRequests = 0;
            GV.infoWmsManager._features = [];

            // Ciclo sulle mappe caricate
            var rlMaps = GV.rlMaps.toJSON();
            _.each(rlMaps, function (rlMap) {
                var url = null,
                    layersArray = [];

                // Ciclo sui layer caricati sulla mappa leaflet
                _.each(rlMap.layers, function (layerConfig) {
                    if (layerConfig.idMap === rlMap.id && layerConfig.type === 'WMS' && layerConfig.queryable && layerConfig.visible && GV.app.map.layerInRange(layerConfig)) {
                        url = layerConfig.wmsParams.url;
                        layersArray.push(layerConfig.wmsParams.name);
                    }
                });

                var layers = layersArray.join(',');

                if (url && layersArray.length > 0) {
                    var wmsUrl = GV.infoWmsManager.buildWMSOptions(url, layers, e.latlng);
                    GV.infoWmsManager._numRequests++;
                    $('.leaflet-container').css('cursor', 'wait');
                    $.ajax({
                        url: wmsUrl,
                        dataType: 'json'
                    }).done(function (response) {
                        GV.infoWmsManager.handleResponse(response.features);
                    });
                }


            });
        }
    };

};
