/* matchMedia() polyfill - Test a CSS media type/query in JS. Authors & copyright (c) 2012: Scott Jehl, Paul Irish, Nicholas Zakas, David Knight. Dual MIT/BSD license */
window.matchMedia||(window.matchMedia=function(){var b=(window.styleMedia||window.media);if(!b){var c=document.createElement("style"),a=document.getElementsByTagName("script")[0],d=null;c.type="text/css";c.id="matchmediajs-test";a.parentNode.insertBefore(c,a);d=("getComputedStyle" in window)&&window.getComputedStyle(c,null)||c.currentStyle;b={matchMedium:function(e){var f="@media "+e+"{ #matchmediajs-test { width: 1px; } }";if(c.styleSheet){c.styleSheet.cssText=f}else{c.textContent=f}return d.width==="1px"}}}return function(e){return{matches:b.matchMedium(e||"all"),media:e||"all"}}}());var GV=GV||{};GV.Buttons={};GV.Views={};GV.Util=function(){return{getUrlParam:function(b){var a=new RegExp("[\\?&]"+b+"=([^&#]*)").exec(window.location.href);GV.Util.log("GV.Util.getUrlParam");return a?decodeURIComponent(a[1]):null},getUrlParamFromString:function(a,c){var b=new RegExp("[\\?&]"+c+"=([^&#]*)").exec(a);if(!b){return 0}return b[1]||0},log:function(a,d){var b="log";if(!GV.config.debug){return}switch(d){case 0:b="warn";break;case 1:case 2:b="error";break;default:b="info";break}try{console[b](a)}catch(c){}},msgBox:function(a){window.alert(a)},setUnderscoreTemplate:function(){if(_){_.templateSettings={interpolate:/\{\{(.+?)\}\}/g}}},getXML:function(b,e){var a=b.url,c=b.data,d=b.method;$.ajax({url:a,dataType:(GV.Util.isBrowserIE())?"text":"xml",data:c,method:d||"GET"}).done(function(f){try{var g=f;if(GV.Util.isBrowserIE()){var j=new ActiveXObject("Microsoft.XMLDOM");j.async="false";j.loadXML(f);g=j}e(g)}catch(h){GV.Util.log(h,2)}})},parseXML:function(c){GV.Util.log("GV.Util.parseXML");try{var b=null;if(window.DOMParser&&window.XSLTProcessor){var d=new DOMParser();b=d.parseFromString(c,"text/xml")}else{b=new ActiveXObject("Msxml2.DOMDocument.3.0");b.async=false;b.loadXML(c)}return b}catch(a){GV.Util.log("GV.Util.parseXml: errore parsing xml - "+a.message,1)}},isPointInLig:function(b,f){GV.Util.log("GV.Util.isPointInLig");if(!b||!f){return false}var a=7.4,e=43.7,d=10.1,c=44.8;return(b>a)&&(b<d)&&(f>e)&&(f<c)},getParamString:function(d,a,b){var e=[];for(var c in d){e.push(encodeURIComponent(b?c.toUpperCase():c)+"="+encodeURIComponent(d[c]))}return((!a||a.indexOf("?")===-1)?"?":"&")+e.join("&")},template:function(b,a){var c=/\{ *([\w_\-]+) *\}/g;return b.replace(c,function(f,d){var e=a[d];if(e===undefined){throw new Error("No value provided for variable "+f)}else{if(typeof e==="function"){e=e(a)}}return e})},getZoomFromScaleDenom:function(a){return _.findIndex(GV.globals.BASE_SCALES,function(b){return a>b})},getScaleLabelsFromZoom:function(a){return GV.globals.BASE_SCALE_LABELS[a]},getScaleFromZoom:function(a){return GV.globals.BASE_SCALES[a]},endsWith:function(b,a){return b.indexOf(a,b.length-a.length)!==-1},isTouch:function(){return window.matchMedia("(pointer: coarse)").matches},isBrowserIE:function(){return navigator.userAgent.indexOf("MSIE ")>0||navigator.userAgent.indexOf("Trident")>0||navigator.userAgent.indexOf("Edge")>0},setDrag:function(){interact(".draggable").draggable({inertia:true,restrict:{restriction:"parent",endOnly:true,elementRect:{top:0,left:0,bottom:1,right:1}},autoScroll:true,onmove:a,onend:function(c){var b=c.target.querySelector("p");b&&(b.textContent="moved a distance of "+(Math.sqrt(c.dx*c.dx+c.dy*c.dy)|0)+"px")}});function a(c){var d=c.target,b=(parseFloat(d.getAttribute("data-x"))||0)+c.dx,e=(parseFloat(d.getAttribute("data-y"))||0)+c.dy;d.style.webkitTransform=d.style.transform="translate("+b+"px, "+e+"px)";d.setAttribute("data-x",b);d.setAttribute("data-y",e)}window.dragMoveListener=a}}}();GV.globals={DEFAULT_PROXY:"/geoservices/proxy/proxy.jsp?url=",RL_MAP_CONFIG_SERVICE:"http://geoportale.regione.liguria.it/geoservices/REST/config/map/",RL_CREATE_SLD_SERVICE:"http://geoportale.regione.liguria.it/geoservices/REST/config/create_sld/",RL_METADATA_URL:"/geoservices/REST/metadata/scheda_xml/",MAX_BOUNDS:L.latLngBounds(L.latLng(43.4,7.3),L.latLng(44.8,10.5)),INFO_WMS_MAX_FEATURES:10,SMALL_SCREEN:window.matchMedia("(max-width: 700px)").matches,BASE_SCALES:[591657550.5,295828775.3,147914387.6,73957193.82,36978596.91,18489298.45,9244649.227,4622324.614,2311162.307,1155581.153,577790.5767,288895.2884,144447.6442,72223.82209,36111.91104,18055.95552,9027.977761,4513.98888,2256.99444,1128.49722],BASE_SCALE_LABELS:{8:"1:1.600.000",9:"1:800.000",10:"1:400.000",11:"1:200.000",12:"1:100.000",13:"1:50.000",14:"1:25.000",15:"1:12.500",16:"1:6.250",17:"1:3.125",18:"1:1.560",19:"1:800",20:"1:400"}};Vue.component("gv-iframe-panel",{template:'<div v-show="visible" :class="cls"><div class="gv-panel-title gv-bgcolor">{{title}}<button class="gv-close" type="button" @click="closePanel">×</button></div><div><div class="gv-html-panel-body"><iframe id="iframe" :src="src" :height="height" :width="width" style="border: none;" ></iframe></div></div></div>',props:["html","src","visible","cls","title","width","height"],methods:{closePanel:function(){this.$el.parentNode.removeChild(this.$el)}},mounted:function(){if(this.html){var a=this;setTimeout(function(){a.$el.querySelector("#iframe").contentDocument.body.innerHTML=a.html},3)}}});Vue.component("gv-legend-layer",{template:'<li :class="getClass"><img class="gv-legend-layer-icon" :src="iconUrl" width="24px" height="24px" @click="showLegendPanel"><span class="gv-layer-visibility-span"><input type="checkbox" class="gv-layer-visibility-cb" v-model="layer.visible" @click="setLayerVisible"></span><span class="gv-layer-title-span">{{layer.legend.label}}</span></li>',props:["layer"],computed:{iconUrl:function(){return this.layer.legend.icon},getClass:function(){return(this.layer.inRange)?"gv-list-legend-layer-item":"gv-list-legend-layer-disabled-item"}},methods:{setLayerVisible:function(a){this.layer.visible=a.srcElement.checked;GV.map.setLayerVisible(this.layer,a.srcElement.checked)},showLegendPanel:function(h){console.log("showLegendPanel");var b=this.layer;if((b.multiClasse||b.legend.popUpFlag)){var c=null,e=null,g,a;if(b.legend.popUpUrl&&b.legend.popUpFlag){c=b.legend.popUpUrl;g=(GV.Util.SMALL_SCREEN)?400:600;a=(GV.Util.SMALL_SCREEN)?400:600}else{if(b.multiClasse){if(b.flagGeoserver){c=b.wmsParams.url+"LAYER="+b.name+"&REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&";g=400;a=350}else{var d=b.classes;e="<table width=100% border=0>";_.each(d,function(j){e+="<tr>";e+='<td width=30><img src="'+j.legendIcon+'"></td>';e+="<td >"+j.legendLabel+"</td>";e+="</tr>"});e+="</table>"}}}var f=new Vue({template:'<gv-iframe-panel v-draggable visible="true" :src="src" :html="html" :height="height" :width="width" :cls="cls" :title="title"></gv-iframe-panel>',data:{title:"LEGENDA - "+b.legend.label,src:c,html:e,width:g,height:a,cls:"gv-legend-multi"},created:function(){$("#gv-container").append("<div id='gv-legend-multi'></div>")}});f.$mount("#gv-legend-multi")}}}});Vue.component("gv-legend",{template:'<div id="gv-legend"><div id="gv-legend-title"><div class="gv-panel-title gv-bgcolor"><b>LEGENDA</b><button class="gv-close" type="button" @click="hideLegend">×</button><button v-show="showAddMap" class="gv-legend-add ms ms-layers-add" title="Aggiungi Mappa" type="button"></button></div></div><div id="gv-legend-body"><ul v-for="map in maps" class="gv-list-group"><li class="gv-list-legend-map-item">{{map.name}}<span v-show="showInfoMap" class="gv-legend-map-info ms ms-information" title="Scheda metadati" @click.prevent="showMapInfoPanel(map)"></span></li><ul class="gv-list-group"><li v-for="layer in map.layers" :layer="layer" :class="getClass(layer)"><img class="gv-legend-layer-icon" :src="iconUrl(layer)" width="24px" height="24px" @click="showLegendPanel(layer)"><span class="gv-layer-visibility-span"><input type="checkbox" class="gv-layer-visibility-cb" v-model="layer.visible" @click="setLayerVisible(layer, $event)"></span><span class="gv-layer-title-span">{{layer.legend.label}}</span></li></ul></ul></div></div>',props:["showAddMap","showInfoMap"],data:function(){return{maps:GV.config.maps}},computed:{},methods:{hideLegend:function(a){$("#gv-legend").css({display:"none"});$("#gv-legend-button").css({display:"block"})},showMapInfoPanel:function(a){alert(a.id)},iconUrl:function(a){return a.legend.icon},getClass:function(a){return(a.inRange)?"gv-list-legend-layer-item":"gv-list-legend-layer-disabled-item"},setLayerVisible:function(a,b){GV.map.setLayerVisible(a,b.currentTarget.checked)},showLegendPanel:function(e){if(e.inRange&&(e.multiClasse||e.legend.popUpFlag)){var b=null,d=null,g,a;if(e.legend.popUpUrl&&e.legend.popUpFlag){b=e.legend.popUpUrl;g=(GV.Util.SMALL_SCREEN)?400:600;a=(GV.Util.SMALL_SCREEN)?400:600}else{if(e.multiClasse){if(e.flagGeoserver){b=e.wmsParams.url+"LAYER="+e.name+"&REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&";g=400;a=350}else{var c=e.classes;d="<table width=100% border=0>";_.each(c,function(h){d+="<tr>";d+='<td width=30><img src="'+h.legendIcon+'"></td>';d+="<td >"+h.legendLabel+"</td>";d+="</tr>"});d+="</table>"}}}var f=new Vue({template:'<gv-iframe-panel v-draggable visible="true" :src="src" :html="html" :height="height" :width="width" :cls="cls" :title="title"></gv-iframe-panel>',data:{title:"LEGENDA - "+e.legend.label,src:b,html:d,width:g,height:a,cls:"gv-legend-multi"},created:function(){$("#gv-container").append("<div id='gv-legend-multi'></div>")}});f.$mount("#gv-legend-multi")}}}});Vue.component("gv-map",{template:'<div id= "gv-map"></div>',mounted:function(){GV.Util.log("gv-map mounted");GV.map=new GV.Map()}});Vue.component("gv-wms-info-list",{template:'<div v-show="visible" :class="cls"><div class="gv-panel-title gv-bgcolor">Risultato Info<button class="gv-close" type="button" @click="closePanel">×</button></div><div class="gv-html-panel-body"><ul class="gv-list-group"><li v-for="item in items" class="gv-info-wms-list-item"><span class="gv-info-wms-list-item-span" @click="featureInfo(item)">{{item.label}} ( {{item.layer.legend.label}} )</span></li></ul></div></div>',props:["cls","items","visible"],methods:{closePanel:function(){this.$el.parentNode.removeChild(this.$el);GV.map.getLayerByName("InfoWmsHilite").clearLayers()},featureInfo:function(a){GV.infoWmsManager.showFeatureInfo(a)}}});Vue.directive("draggable",{inserted:function(a){a.className+=" draggable"}});GV.App=Vue.extend({template:'<div :id="this.$options.el"><div id="gv-container"><gv-map ref="gv-map"></gv-map><div v-show="showTitle" id="gv-title">{{this.getTitle()}}</div><gv-legend ref="gv-legend" v-if="showLegend" :showAddMap="showAddMap" :showInfoMap="showInfoMap"></gv-legend></div></div>',data:function(){return GV.config},computed:{showTitle:function(){return(GV.config.application.layout.title&&!GV.globals.SMALL_SCREEN)},showLegend:function(){return this.getButton("legend")?true:false},showAddMap:function(){return this.getButtonOption("legend","showAddMap")},showInfoMap:function(){return this.getButtonOption("legend","showInfoMap")}},created:function(){GV.Util.log("GV.App created ");GV.app=this;this.checkOptions();this.setGVConfig();GV.Util.setDrag()},mounted:function(){GV.Util.log("GV.App mounted");var a=this;this.addToolbars(GV.config.application.layout.toolbar);if(GV.config.application.mapOptions&&GV.config.application.mapOptions.click){if(GV.config.application.mapOptions.click==="info"&&!GV.Util.isTouch()){GV.infoWmsManager.activate()}}if(this.$options.maps&&this.$options.maps.length>0){_.each(this.$options.maps,function(b){a.addMap(b)})}if(GV.config.idMap){this.addRlMap(GV.config.idMap,GV.config.application.callback)}else{if(GV.config.application.callback){GV.config.application.callback(this)}}},methods:{getTitle:function(){if(GV.config.application.layout.title==="{map.title}"){return this.mapTitle}else{return GV.config.application.layout.title}},checkOptions:function(){if(!this.$options.el){GV.config.debug=true;GV.Util.log('Parametro "el" non definito',2);return false}if(!document.getElementById(this.$options.el.replace("#",""))){GV.config.debug=true;GV.Util.log("Elemento "+this.$options.el.replace("#","")+" non presente",2);return false}return true},setGVConfig:function(){GV.config.el=this.$options.el;GV.config.debug=this.$options.debug;GV.config.idMap=this.$options.idMap;if(this.$options.baseLayers){GV.config.baseLayers=this.$options.baseLayers}if(this.$options.application){GV.config.application=this.$options.application}GV.config.application.layout=this.$options.application.layout||{};GV.config.application.proxy=this.$options.application.proxy||GV.globals.DEFAULT_PROXY},getMaps:function(){return this.maps},addToolbars:function(){if(GV.config.application.layout.toolbar){var a=GV.config.application.layout.toolbar;_.each(a,function(c){var b=c.position||"topleft";_.each(c.items,function(d){d.options=d.options||{};d.options.position=d.options.position||b;this.addButton(d)},this)},this)}},addButton:function(b){if(GV.Buttons[b.name]){var a=GV.Buttons[b.name](b.options,GV.map);if(a){a.name=b.name;a.addTo(GV.map)}}else{GV.Util.log("Bottone "+b.name+" non esistente")}},getButton:function(a){var b=null;_.each(GV.config.application.layout.toolbar,function(c){_.each(c.items,function(d){if(d.name===a){b=d}},this)},this);return b},getButtonOption:function(a,b){var c=null;_.each(GV.config.application.layout.toolbar,function(d){_.each(d.items,function(e){if(e.name===a){c=e.options[b]}},this)},this);return c},addRlMap:function(b,c){var a=this;if(!b){GV.Util.log("addRlMap: prametro idMap mancante",2);return}$.ajax({url:GV.globals.RL_MAP_CONFIG_SERVICE+b,dataType:"jsonp"}).done(function(d){if(!d.success){GV.Util.log("Errore Caricamento Configurazione Mappa: "+d.message,2);return}a.addMap(d.data);if(c){c(a)}}).fail(function(d,f,e){GV.Util.log(e,2)})},addMap:function(a){this.mapTitle=a.name;GV.config.addMapConfig(a);GV.map.loadLayers(a.layers);if(a.extent_3857){GV.map.setInitialExtent(a.extent_3857)}}}});GV.Map=L.Map.extend({layers:[],baseLayers:[],initialExtent:[],mapOptions:{zoomControl:false,maxBounds:GV.globals.MAX_BOUNDS,maxBoundsViscosity:1,minZoom:7},initialize:function(){_.extend(this.mapOptions,GV.config.application.mapOptions);L.Map.prototype.initialize.call(this,"gv-map",_.extend(L.Map.prototype.options,this.mapOptions));this.setInitialExtent();this.setLayersInRange();this.setLoading();this.loadBaseLayers();this.loadControls()},setInitialExtent:function(){var b=this.mapOptions.initialExtent||"830036,5402959,1123018,5597635";var d=b.split(",");var c=L.point(d[0],d[1]);var f=L.point(d[2],d[3]);var a=L.Projection.SphericalMercator.unproject(c);var e=L.Projection.SphericalMercator.unproject(f);this.initialExtent=L.latLngBounds(a,e);this.fitBounds(this.initialExtent)},setLayersInRange:function(){this.on("zoom",function(){var a=GV.config.getAllLayersConfig();_.each(a,function(b){GV.config.setLayerAttribute(b.name,"inRange",this.layerInRange(b))},this)})},setLayerVisible:function(a,b){if(b){a.visible=true;this.loadLayers([a])}else{this.removeLayer(this.getLayerByName(a.name))}},layerInRange:function(a){if(!a.minScale&&!a.minScale){return true}return(this.getScale()<a.minScale&&this.getScale()>a.maxScale)},loadControls:function(){if(this.mapOptions.controls){var a;this.controls={};_.each(this.mapOptions.controls,function(b){switch(b.name){case"scale":a=L.control.scale({imperial:false}).addTo(this);this.controls[b]=a;break}},this)}},loadBaseLayers:function(){_.each(GV.config.baseLayers,function(a){var b=GV.layerFactory.create(a,this);this.baseLayers[b.config.legend.label]=b;if(b&&a.visible){b.on("loading",function(){this.loading(true,b)},this);b.on("load",function(){this.loading(false,b)},this);b.addTo(this)}},this)},loadLayers:function(a){_.each(a,function(b){if(!this.getLayerByName(b.name)){var c=GV.layerFactory.create(b,this);if(c&&b.visible){c.on("loading",function(){this.loading(true,c)},this);c.on("load",function(){this.loading(false,c)},this);c.addTo(this)}}},this)},getLayerByName:function(b){var a=null;this.eachLayer(function(c){if(c.config&&c.config.name&&c.config.name===b){a=c}});return a},getScaleLabel:function(){return GV.Util.getScaleLabelsFromZoom(this._zoom)},getScale:function(){return GV.Util.getScaleFromZoom(this._zoom)},setLoading:function(){this._spinning=0;this.on("layerremove",function(a){if(a.layer.loading){this.loading(false)}if(typeof a.layer.on!="function"){return}a.layer.off("load");a.layer.off("loading")},this)},loading:function(b,a){if(!!b){if(this._spinning===0){GV.Util.log("start load: "+a.config.name+" - "+new Date());this._container.style.cursor="progress"}this._spinning++}else{this._spinning--;if(this._spinning<=0){GV.Util.log("end load: "+a.config.name+" - "+new Date());this._container.style.cursor="default"}}}});(function(b,a,c){L.MarkerClusterGroup=L.FeatureGroup.extend({options:{maxClusterRadius:80,iconCreateFunction:null,spiderfyOnMaxZoom:true,showCoverageOnHover:true,zoomToBoundsOnClick:true,singleMarkerMode:false,disableClusteringAtZoom:null,removeOutsideVisibleBounds:true,animate:true,animateAddingMarkers:false,spiderfyDistanceMultiplier:1,spiderLegPolylineOptions:{weight:1.5,color:"#222",opacity:0.5},chunkedLoading:false,chunkInterval:200,chunkDelay:50,chunkProgress:null,polygonOptions:{}},initialize:function(e){L.Util.setOptions(this,e);if(!this.options.iconCreateFunction){this.options.iconCreateFunction=this._defaultIconCreateFunction}this._featureGroup=L.featureGroup();this._featureGroup.addEventParent(this);this._nonPointGroup=L.featureGroup();this._nonPointGroup.addEventParent(this);this._inZoomAnimation=0;this._needsClustering=[];this._needsRemoving=[];this._currentShownBounds=null;this._queue=[];var d=L.DomUtil.TRANSITION&&this.options.animate;L.extend(this,d?this._withAnimation:this._noAnimation);this._markerCluster=d?L.MarkerCluster:L.MarkerClusterNonAnimated},addLayer:function(f){if(f instanceof L.LayerGroup){return this.addLayers([f])}if(!f.getLatLng){this._nonPointGroup.addLayer(f);return this}if(!this._map){this._needsClustering.push(f);return this}if(this.hasLayer(f)){return this}if(this._unspiderfy){this._unspiderfy()}this._addLayer(f,this._maxZoom);this._topClusterLevel._recalculateBounds();var d=f,e=this._map.getZoom();if(f.__parent){while(d.__parent._zoom>=e){d=d.__parent}}if(this._currentShownBounds.contains(d.getLatLng())){if(this.options.animateAddingMarkers){this._animationAddLayer(f,d)}else{this._animationAddLayerNonAnimated(f,d)}}return this},removeLayer:function(d){if(d instanceof L.LayerGroup){return this.removeLayers([d])}if(!d.getLatLng){this._nonPointGroup.removeLayer(d);return this}if(!this._map){if(!this._arraySplice(this._needsClustering,d)&&this.hasLayer(d)){this._needsRemoving.push(d)}return this}if(!d.__parent){return this}if(this._unspiderfy){this._unspiderfy();this._unspiderfyLayer(d)}this._removeLayer(d,true);this._topClusterLevel._recalculateBounds();d.off("move",this._childMarkerMoved,this);if(this._featureGroup.hasLayer(d)){this._featureGroup.removeLayer(d);if(d.clusterShow){d.clusterShow()}}return this},addLayers:function(h){if(!L.Util.isArray(h)){return this.addLayer(h)}var e=this._featureGroup,n=this._nonPointGroup,p=this.options.chunkedLoading,o=this.options.chunkInterval,r=this.options.chunkProgress,j=h.length,k=0,q=true,g;if(this._map){var s=(new Date()).getTime();var f=L.bind(function(){var u=(new Date()).getTime();for(;k<j;k++){if(p&&k%200===0){var l=(new Date()).getTime()-u;if(l>o){break}}g=h[k];if(g instanceof L.LayerGroup){if(q){h=h.slice();q=false}this._extractNonGroupLayers(g,h);j=h.length;continue}if(!g.getLatLng){n.addLayer(g);continue}if(this.hasLayer(g)){continue}this._addLayer(g,this._maxZoom);if(g.__parent){if(g.__parent.getChildCount()===2){var t=g.__parent.getAllChildMarkers(),m=t[0]===g?t[1]:t[0];e.removeLayer(m)}}}if(r){r(k,j,(new Date()).getTime()-s)}if(k===j){this._topClusterLevel._recalculateBounds();this._featureGroup.eachLayer(function(v){if(v instanceof L.MarkerCluster&&v._iconNeedsUpdate){v._updateIcon()}});this._topClusterLevel._recursivelyAddChildrenToMap(null,this._zoom,this._currentShownBounds)}else{setTimeout(f,this.options.chunkDelay)}},this);f()}else{var d=this._needsClustering;for(;k<j;k++){g=h[k];if(g instanceof L.LayerGroup){if(q){h=h.slice();q=false}this._extractNonGroupLayers(g,h);j=h.length;continue}if(!g.getLatLng){n.addLayer(g);continue}if(this.hasLayer(g)){continue}d.push(g)}}return this},removeLayers:function(g){var j,f,h=g.length,d=this._featureGroup,k=this._nonPointGroup,n=true;if(!this._map){for(j=0;j<h;j++){f=g[j];if(f instanceof L.LayerGroup){if(n){g=g.slice();n=false}this._extractNonGroupLayers(f,g);h=g.length;continue}this._arraySplice(this._needsClustering,f);k.removeLayer(f);if(this.hasLayer(f)){this._needsRemoving.push(f)}}return this}if(this._unspiderfy){this._unspiderfy();var o=g.slice(),e=h;for(j=0;j<e;j++){f=o[j];if(f instanceof L.LayerGroup){this._extractNonGroupLayers(f,o);e=o.length;continue}this._unspiderfyLayer(f)}}for(j=0;j<h;j++){f=g[j];if(f instanceof L.LayerGroup){if(n){g=g.slice();n=false}this._extractNonGroupLayers(f,g);h=g.length;continue}if(!f.__parent){k.removeLayer(f);continue}this._removeLayer(f,true,true);if(d.hasLayer(f)){d.removeLayer(f);if(f.clusterShow){f.clusterShow()}}}this._topClusterLevel._recalculateBounds();this._topClusterLevel._recursivelyAddChildrenToMap(null,this._zoom,this._currentShownBounds);d.eachLayer(function(l){if(l instanceof L.MarkerCluster){l._updateIcon()}});return this},clearLayers:function(){if(!this._map){this._needsClustering=[];delete this._gridClusters;delete this._gridUnclustered}if(this._noanimationUnspiderfy){this._noanimationUnspiderfy()}this._featureGroup.clearLayers();this._nonPointGroup.clearLayers();this.eachLayer(function(d){d.off("move",this._childMarkerMoved,this);delete d.__parent});if(this._map){this._generateInitialClusters()}return this},getBounds:function(){var e=new L.LatLngBounds();if(this._topClusterLevel){e.extend(this._topClusterLevel._bounds)}for(var d=this._needsClustering.length-1;d>=0;d--){e.extend(this._needsClustering[d].getLatLng())}e.extend(this._nonPointGroup.getBounds());return e},eachLayer:function(h,f){var g=this._needsClustering.slice(),d=this._needsRemoving,e;if(this._topClusterLevel){this._topClusterLevel.getAllChildMarkers(g)}for(e=g.length-1;e>=0;e--){if(d.indexOf(g[e])===-1){h.call(f,g[e])}}this._nonPointGroup.eachLayer(h,f)},getLayers:function(){var d=[];this.eachLayer(function(e){d.push(e)});return d},getLayer:function(e){var d=null;e=parseInt(e,10);this.eachLayer(function(f){if(L.stamp(f)===e){d=f}});return d},hasLayer:function(e){if(!e){return false}var d,f=this._needsClustering;for(d=f.length-1;d>=0;d--){if(f[d]===e){return true}}f=this._needsRemoving;for(d=f.length-1;d>=0;d--){if(f[d]===e){return false}}return !!(e.__parent&&e.__parent._group===this)||this._nonPointGroup.hasLayer(e)},zoomToShowLayer:function(e,g){if(typeof g!=="function"){g=function(){}}var f=function(){if((e._icon||e.__parent._icon)&&!this._inZoomAnimation){this._map.off("moveend",f,this);this.off("animationend",f,this);if(e._icon){g()}else{if(e.__parent._icon){this.once("spiderfied",g,this);e.__parent.spiderfy()}}}};if(e._icon&&this._map.getBounds().contains(e.getLatLng())){g()}else{if(e.__parent._zoom<this._map.getZoom()){this._map.on("moveend",f,this);this._map.panTo(e.getLatLng())}else{var d=function(){this._map.off("movestart",d,this);d=null};this._map.on("movestart",d,this);this._map.on("moveend",f,this);this.on("animationend",f,this);e.__parent.zoomToBounds();if(d){f.call(this)}}}},onAdd:function(g){this._map=g;var f,d,e;if(!isFinite(this._map.getMaxZoom())){throw"Map has no maxZoom specified"}this._featureGroup.addTo(g);this._nonPointGroup.addTo(g);if(!this._gridClusters){this._generateInitialClusters()}this._maxLat=g.options.crs.projection.MAX_LATITUDE;for(f=0,d=this._needsRemoving.length;f<d;f++){e=this._needsRemoving[f];this._removeLayer(e,true)}this._needsRemoving=[];this._zoom=this._map.getZoom();this._currentShownBounds=this._getExpandedVisibleBounds();this._map.on("zoomend",this._zoomEnd,this);this._map.on("moveend",this._moveEnd,this);if(this._spiderfierOnAdd){this._spiderfierOnAdd()}this._bindEvents();d=this._needsClustering;this._needsClustering=[];this.addLayers(d)},onRemove:function(d){d.off("zoomend",this._zoomEnd,this);d.off("moveend",this._moveEnd,this);this._unbindEvents();this._map._mapPane.className=this._map._mapPane.className.replace(" leaflet-cluster-anim","");if(this._spiderfierOnRemove){this._spiderfierOnRemove()}delete this._maxLat;this._hideCoverage();this._featureGroup.remove();this._nonPointGroup.remove();this._featureGroup.clearLayers();this._map=null},getVisibleParent:function(d){var e=d;while(e&&!e._icon){e=e.__parent}return e||null},_arraySplice:function(e,f){for(var d=e.length-1;d>=0;d--){if(e[d]===f){e.splice(d,1);return true}}},_removeFromGridUnclustered:function(d,g){var f=this._map,e=this._gridUnclustered;for(;g>=0;g--){if(!e[g].removeObject(d,f.project(d.getLatLng(),g))){break}}},_childMarkerMoved:function(d){if(!this._ignoreMove){d.target._latlng=d.oldLatLng;this.removeLayer(d.target);d.target._latlng=d.latlng;this.addLayer(d.target)}},_removeLayer:function(k,g,l){var h=this._gridClusters,f=this._gridUnclustered,d=this._featureGroup,e=this._map;if(g){this._removeFromGridUnclustered(k,this._maxZoom)}var m=k.__parent,j=m._markers,n;this._arraySplice(j,k);while(m){m._childCount--;m._boundsNeedUpdate=true;if(m._zoom<0){break}else{if(g&&m._childCount<=1){n=m._markers[0]===k?m._markers[1]:m._markers[0];h[m._zoom].removeObject(m,e.project(m._cLatLng,m._zoom));f[m._zoom].addObject(n,e.project(n.getLatLng(),m._zoom));this._arraySplice(m.__parent._childClusters,m);m.__parent._markers.push(n);n.__parent=m.__parent;if(m._icon){d.removeLayer(m);if(!l){d.addLayer(n)}}}else{if(!l||!m._icon){m._updateIcon()}}}m=m.__parent}delete k.__parent},_isOrIsParent:function(e,d){while(d){if(e===d){return true}d=d.parentNode}return false},fire:function(e,f,d){if(f&&f.layer instanceof L.MarkerCluster){if(f.originalEvent&&this._isOrIsParent(f.layer._icon,f.originalEvent.relatedTarget)){return}e="cluster"+e}L.FeatureGroup.prototype.fire.call(this,e,f,d)},listens:function(e,d){return L.FeatureGroup.prototype.listens.call(this,e,d)||L.FeatureGroup.prototype.listens.call(this,"cluster"+e,d)},_defaultIconCreateFunction:function(d){var e=d.getChildCount();var f=" marker-cluster-";if(e<10){f+="small"}else{if(e<100){f+="medium"}else{f+="large"}}return new L.DivIcon({html:"<div><span>"+e+"</span></div>",className:"marker-cluster"+f,iconSize:new L.Point(40,40)})},_bindEvents:function(){var g=this._map,e=this.options.spiderfyOnMaxZoom,d=this.options.showCoverageOnHover,f=this.options.zoomToBoundsOnClick;if(e||f){this.on("clusterclick",this._zoomOrSpiderfy,this)}if(d){this.on("clustermouseover",this._showCoverage,this);this.on("clustermouseout",this._hideCoverage,this);g.on("zoomend",this._hideCoverage,this)}},_zoomOrSpiderfy:function(g){var d=g.layer,f=d;while(f._childClusters.length===1){f=f._childClusters[0]}if(f._zoom===this._maxZoom&&f._childCount===d._childCount&&this.options.spiderfyOnMaxZoom){d.spiderfy()}else{if(this.options.zoomToBoundsOnClick){d.zoomToBounds()}}if(g.originalEvent&&g.originalEvent.keyCode===13){this._map._container.focus()}},_showCoverage:function(f){var d=this._map;if(this._inZoomAnimation){return}if(this._shownPolygon){d.removeLayer(this._shownPolygon)}if(f.layer.getChildCount()>2&&f.layer!==this._spiderfied){this._shownPolygon=new L.Polygon(f.layer.getConvexHull(),this.options.polygonOptions);d.addLayer(this._shownPolygon)}},_hideCoverage:function(){if(this._shownPolygon){this._map.removeLayer(this._shownPolygon);this._shownPolygon=null}},_unbindEvents:function(){var e=this.options.spiderfyOnMaxZoom,d=this.options.showCoverageOnHover,g=this.options.zoomToBoundsOnClick,f=this._map;if(e||g){this.off("clusterclick",this._zoomOrSpiderfy,this)}if(d){this.off("clustermouseover",this._showCoverage,this);this.off("clustermouseout",this._hideCoverage,this);f.off("zoomend",this._hideCoverage,this)}},_zoomEnd:function(){if(!this._map){return}this._mergeSplitClusters();this._zoom=Math.round(this._map._zoom);this._currentShownBounds=this._getExpandedVisibleBounds()},_moveEnd:function(){if(this._inZoomAnimation){return}var d=this._getExpandedVisibleBounds();this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,this._zoom,d);this._topClusterLevel._recursivelyAddChildrenToMap(null,Math.round(this._map._zoom),d);this._currentShownBounds=d;return},_generateInitialClusters:function(){var e=this._map.getMaxZoom(),d=this.options.maxClusterRadius,f=d;if(typeof d!=="function"){f=function(){return d}}if(this.options.disableClusteringAtZoom){e=this.options.disableClusteringAtZoom-1}this._maxZoom=e;this._gridClusters={};this._gridUnclustered={};for(var g=e;g>=0;g--){this._gridClusters[g]=new L.DistanceGrid(f(g));this._gridUnclustered[g]=new L.DistanceGrid(f(g))}this._topClusterLevel=new this._markerCluster(this,-1)},_addLayer:function(h,n){var f=this._gridClusters,d=this._gridUnclustered,m,j;if(this.options.singleMarkerMode){this._overrideMarkerIcon(h)}h.on("move",this._childMarkerMoved,this);for(;n>=0;n--){m=this._map.project(h.getLatLng(),n);var e=f[n].getNearObject(m);if(e){e._addChild(h);h.__parent=e;return}e=d[n].getNearObject(m);if(e){var k=e.__parent;if(k){this._removeLayer(e,false)}var l=new this._markerCluster(this,n,e,h);f[n].addObject(l,this._map.project(l._cLatLng,n));e.__parent=l;h.__parent=l;var g=l;for(j=n-1;j>k._zoom;j--){g=new this._markerCluster(this,j,g);f[j].addObject(g,this._map.project(e.getLatLng(),j))}k._addChild(g);this._removeFromGridUnclustered(e,n);return}d[n].addObject(h,m)}this._topClusterLevel._addChild(h);h.__parent=this._topClusterLevel;return},_enqueue:function(d){this._queue.push(d);if(!this._queueTimeout){this._queueTimeout=setTimeout(L.bind(this._processQueue,this),300)}},_processQueue:function(){for(var d=0;d<this._queue.length;d++){this._queue[d].call(this)}this._queue.length=0;clearTimeout(this._queueTimeout);this._queueTimeout=null},_mergeSplitClusters:function(){var d=Math.round(this._map._zoom);this._processQueue();if(this._zoom<d&&this._currentShownBounds.intersects(this._getExpandedVisibleBounds())){this._animationStart();this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,this._zoom,this._getExpandedVisibleBounds());this._animationZoomIn(this._zoom,d)}else{if(this._zoom>d){this._animationStart();this._animationZoomOut(this._zoom,d)}else{this._moveEnd()}}},_getExpandedVisibleBounds:function(){if(!this.options.removeOutsideVisibleBounds){return this._mapBoundsInfinite}else{if(L.Browser.mobile){return this._checkBoundsMaxLat(this._map.getBounds())}}return this._checkBoundsMaxLat(this._map.getBounds().pad(1))},_checkBoundsMaxLat:function(d){var e=this._maxLat;if(e!==c){if(d.getNorth()>=e){d._northEast.lat=Infinity}if(d.getSouth()<=-e){d._southWest.lat=-Infinity}}return d},_animationAddLayerNonAnimated:function(d,e){if(e===d){this._featureGroup.addLayer(d)}else{if(e._childCount===2){e._addToMap();var f=e.getAllChildMarkers();this._featureGroup.removeLayer(f[0]);this._featureGroup.removeLayer(f[1])}else{e._updateIcon()}}},_extractNonGroupLayers:function(h,d){var g=h.getLayers(),f=0,e;d=d||[];for(;f<g.length;f++){e=g[f];if(e instanceof L.LayerGroup){this._extractNonGroupLayers(e,d);continue}d.push(e)}return d},_overrideMarkerIcon:function(d){var e=d.options.icon=this.options.iconCreateFunction({getChildCount:function(){return 1},getAllChildMarkers:function(){return[d]}});return e}});L.MarkerClusterGroup.include({_mapBoundsInfinite:new L.LatLngBounds(new L.LatLng(-Infinity,-Infinity),new L.LatLng(Infinity,Infinity))});L.MarkerClusterGroup.include({_noAnimation:{_animationStart:function(){},_animationZoomIn:function(e,d){this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,e);this._topClusterLevel._recursivelyAddChildrenToMap(null,d,this._getExpandedVisibleBounds());this.fire("animationend")},_animationZoomOut:function(e,d){this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,e);this._topClusterLevel._recursivelyAddChildrenToMap(null,d,this._getExpandedVisibleBounds());this.fire("animationend")},_animationAddLayer:function(d,e){this._animationAddLayerNonAnimated(d,e)}},_withAnimation:{_animationStart:function(){this._map._mapPane.className+=" leaflet-cluster-anim";this._inZoomAnimation++},_animationZoomIn:function(h,f){var g=this._getExpandedVisibleBounds(),d=this._featureGroup,e;this._ignoreMove=true;this._topClusterLevel._recursively(g,h,0,function(n){var k=n._latlng,l=n._markers,j;if(!g.contains(k)){k=null}if(n._isSingleParent()&&h+1===f){d.removeLayer(n);n._recursivelyAddChildrenToMap(null,f,g)}else{n.clusterHide();n._recursivelyAddChildrenToMap(k,f,g)}for(e=l.length-1;e>=0;e--){j=l[e];if(!g.contains(j._latlng)){d.removeLayer(j)}}});this._forceLayout();this._topClusterLevel._recursivelyBecomeVisible(g,f);d.eachLayer(function(j){if(!(j instanceof L.MarkerCluster)&&j._icon){j.clusterShow()}});this._topClusterLevel._recursively(g,h,f,function(j){j._recursivelyRestoreChildPositions(f)});this._ignoreMove=false;this._enqueue(function(){this._topClusterLevel._recursively(g,h,0,function(j){d.removeLayer(j);j.clusterShow()});this._animationEnd()})},_animationZoomOut:function(e,d){this._animationZoomOutSingle(this._topClusterLevel,e-1,d);this._topClusterLevel._recursivelyAddChildrenToMap(null,d,this._getExpandedVisibleBounds());this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,e,this._getExpandedVisibleBounds())},_animationAddLayer:function(e,g){var f=this,d=this._featureGroup;d.addLayer(e);if(g!==e){if(g._childCount>2){g._updateIcon();this._forceLayout();this._animationStart();e._setPos(this._map.latLngToLayerPoint(g.getLatLng()));e.clusterHide();this._enqueue(function(){d.removeLayer(e);e.clusterShow();f._animationEnd()})}else{this._forceLayout();f._animationStart();f._animationZoomOutSingle(g,this._map.getMaxZoom(),this._map.getZoom())}}}},_animationZoomOutSingle:function(d,h,e){var g=this._getExpandedVisibleBounds();d._recursivelyAnimateChildrenInAndAddSelfToMap(g,h+1,e);var f=this;this._forceLayout();d._recursivelyBecomeVisible(g,e);this._enqueue(function(){if(d._childCount===1){var j=d._markers[0];this._ignoreMove=true;j.setLatLng(j.getLatLng());this._ignoreMove=false;if(j.clusterShow){j.clusterShow()}}else{d._recursively(g,e,0,function(k){k._recursivelyRemoveChildrenFromMap(g,h+1)})}f._animationEnd()})},_animationEnd:function(){if(this._map){this._map._mapPane.className=this._map._mapPane.className.replace(" leaflet-cluster-anim","")}this._inZoomAnimation--;this.fire("animationend")},_forceLayout:function(){L.Util.falseFn(a.body.offsetWidth)}});L.markerClusterGroup=function(d){return new L.MarkerClusterGroup(d)};L.MarkerCluster=L.Marker.extend({initialize:function(g,f,e,d){L.Marker.prototype.initialize.call(this,e?(e._cLatLng||e.getLatLng()):new L.LatLng(0,0),{icon:this});this._group=g;this._zoom=f;this._markers=[];this._childClusters=[];this._childCount=0;this._iconNeedsUpdate=true;this._boundsNeedUpdate=true;this._bounds=new L.LatLngBounds();if(e){this._addChild(e)}if(d){this._addChild(d)}},getAllChildMarkers:function(f){f=f||[];for(var e=this._childClusters.length-1;e>=0;e--){this._childClusters[e].getAllChildMarkers(f)}for(var d=this._markers.length-1;d>=0;d--){f.push(this._markers[d])}return f},getChildCount:function(){return this._childCount},zoomToBounds:function(){var g=this._childClusters.slice(),k=this._group._map,j=k.getBoundsZoom(this._bounds),f=this._zoom+1,h=k.getZoom(),e;while(g.length>0&&j>f){f++;var d=[];for(e=0;e<g.length;e++){d=d.concat(g[e]._childClusters)}g=d}if(j>f){this._group._map.setView(this._latlng,f)}else{if(j<=h){this._group._map.setView(this._latlng,h+1)}else{this._group._map.fitBounds(this._bounds)}}},getBounds:function(){var d=new L.LatLngBounds();d.extend(this._bounds);return d},_updateIcon:function(){this._iconNeedsUpdate=true;if(this._icon){this.setIcon(this)}},createIcon:function(){if(this._iconNeedsUpdate){this._iconObj=this._group.options.iconCreateFunction(this);this._iconNeedsUpdate=false}return this._iconObj.createIcon()},createShadow:function(){return this._iconObj.createShadow()},_addChild:function(d,e){this._iconNeedsUpdate=true;this._boundsNeedUpdate=true;this._setClusterCenter(d);if(d instanceof L.MarkerCluster){if(!e){this._childClusters.push(d);d.__parent=this}this._childCount+=d._childCount}else{if(!e){this._markers.push(d)}this._childCount++}if(this.__parent){this.__parent._addChild(d,true)}},_setClusterCenter:function(d){if(!this._cLatLng){this._cLatLng=d._cLatLng||d._latlng}},_resetBounds:function(){var d=this._bounds;if(d._southWest){d._southWest.lat=Infinity;d._southWest.lng=Infinity}if(d._northEast){d._northEast.lat=-Infinity;d._northEast.lng=-Infinity}},_recalculateBounds:function(){var h=this._markers,l=this._childClusters,d=0,f=0,m=this._childCount,j,e,k,g;if(m===0){return}this._resetBounds();for(j=0;j<h.length;j++){k=h[j]._latlng;this._bounds.extend(k);d+=k.lat;f+=k.lng}for(j=0;j<l.length;j++){e=l[j];if(e._boundsNeedUpdate){e._recalculateBounds()}this._bounds.extend(e._bounds);k=e._wLatLng;g=e._childCount;d+=k.lat*g;f+=k.lng*g}this._latlng=this._wLatLng=new L.LatLng(d/m,f/m);this._boundsNeedUpdate=false},_addToMap:function(d){if(d){this._backupLatlng=this._latlng;this.setLatLng(d)}this._group._featureGroup.addLayer(this)},_recursivelyAnimateChildrenIn:function(f,d,e){this._recursively(f,0,e-1,function(k){var j=k._markers,h,g;for(h=j.length-1;h>=0;h--){g=j[h];if(g._icon){g._setPos(d);g.clusterHide()}}},function(l){var k=l._childClusters,h,g;for(h=k.length-1;h>=0;h--){g=k[h];if(g._icon){g._setPos(d);g.clusterHide()}}})},_recursivelyAnimateChildrenInAndAddSelfToMap:function(f,e,d){this._recursively(f,d,0,function(g){g._recursivelyAnimateChildrenIn(f,g._group._map.latLngToLayerPoint(g.getLatLng()).round(),e);if(g._isSingleParent()&&e-1===d){g.clusterShow();g._recursivelyRemoveChildrenFromMap(f,e)}else{g.clusterHide()}g._addToMap()})},_recursivelyBecomeVisible:function(d,e){this._recursively(d,0,e,null,function(f){f.clusterShow()})},_recursivelyAddChildrenToMap:function(d,f,e){this._recursively(e,-1,f,function(j){if(f===j._zoom){return}for(var h=j._markers.length-1;h>=0;h--){var g=j._markers[h];if(!e.contains(g._latlng)){continue}if(d){g._backupLatlng=g.getLatLng();g.setLatLng(d);if(g.clusterHide){g.clusterHide()}}j._group._featureGroup.addLayer(g)}},function(g){g._addToMap(d)})},_recursivelyRestoreChildPositions:function(h){for(var g=this._markers.length-1;g>=0;g--){var d=this._markers[g];if(d._backupLatlng){d.setLatLng(d._backupLatlng);delete d._backupLatlng}}if(h-1===this._zoom){for(var f=this._childClusters.length-1;f>=0;f--){this._childClusters[f]._restorePosition()}}else{for(var e=this._childClusters.length-1;e>=0;e--){this._childClusters[e]._recursivelyRestoreChildPositions(h)}}},_restorePosition:function(){if(this._backupLatlng){this.setLatLng(this._backupLatlng);delete this._backupLatlng}},_recursivelyRemoveChildrenFromMap:function(e,h,g){var d,f;this._recursively(e,-1,h-1,function(j){for(f=j._markers.length-1;f>=0;f--){d=j._markers[f];if(!g||!g.contains(d._latlng)){j._group._featureGroup.removeLayer(d);if(d.clusterShow){d.clusterShow()}}}},function(j){for(f=j._childClusters.length-1;f>=0;f--){d=j._childClusters[f];if(!g||!g.contains(d._latlng)){j._group._featureGroup.removeLayer(d);if(d.clusterShow){d.clusterShow()}}}})},_recursively:function(k,j,f,d,g){var h=this._childClusters,m=this._zoom,e,l;if(j>m){for(e=h.length-1;e>=0;e--){l=h[e];if(k.intersects(l._bounds)){l._recursively(k,j,f,d,g)}}}else{if(d){d(this)}if(g&&this._zoom===f){g(this)}if(f>m){for(e=h.length-1;e>=0;e--){l=h[e];if(k.intersects(l._bounds)){l._recursively(k,j,f,d,g)}}}}},_isSingleParent:function(){return this._childClusters.length>0&&this._childClusters[0]._childCount===this._childCount}});L.Marker.include({clusterHide:function(){this.options.opacityWhenUnclustered=this.options.opacity||1;return this.setOpacity(0)},clusterShow:function(){var d=this.setOpacity(this.options.opacity||this.options.opacityWhenUnclustered);delete this.options.opacityWhenUnclustered;return d}});L.DistanceGrid=function(d){this._cellSize=d;this._sqCellSize=d*d;this._grid={};this._objectPoint={}};L.DistanceGrid.prototype={addObject:function(j,f){var e=this._getCoord(f.x),l=this._getCoord(f.y),h=this._grid,k=h[l]=h[l]||{},d=k[e]=k[e]||[],g=L.Util.stamp(j);this._objectPoint[g]=f;d.push(j)},updateObject:function(e,d){this.removeObject(e);this.addObject(e,d)},removeObject:function(e,k){var j=this._getCoord(k.x),h=this._getCoord(k.y),d=this._grid,m=d[h]=d[h]||{},l=m[j]=m[j]||[],f,g;delete this._objectPoint[L.Util.stamp(e)];for(f=0,g=l.length;f<g;f++){if(l[f]===e){l.splice(f,1);if(g===1){delete m[j]}return true}}},eachObject:function(n,e){var h,g,f,m,p,o,l,d=this._grid;for(h in d){p=d[h];for(g in p){o=p[g];for(f=0,m=o.length;f<m;f++){l=n.call(e,o[f]);if(l){f--;m--}}}}},getNearObject:function(q){var p=this._getCoord(q.x),o=this._getCoord(q.y),h,f,e,t,s,l,g,n,r=this._objectPoint,m=this._sqCellSize,d=null;for(h=o-1;h<=o+1;h++){t=this._grid[h];if(t){for(f=p-1;f<=p+1;f++){s=t[f];if(s){for(e=0,l=s.length;e<l;e++){g=s[e];n=this._sqDist(r[L.Util.stamp(g)],q);if(n<m){m=n;d=g}}}}}}return d},_getCoord:function(d){return Math.floor(d/this._cellSize)},_sqDist:function(g,f){var e=f.x-g.x,d=f.y-g.y;return e*e+d*d}};(function(){L.QuickHull={getDistant:function(f,g){var d=g[1].lat-g[0].lat,e=g[0].lng-g[1].lng;return(e*(f.lat-g[0].lat)+d*(f.lng-g[0].lng))},findMostDistantPointFromBaseLine:function(f,l){var j=0,e=null,h=[],g,k,m;for(g=l.length-1;g>=0;g--){k=l[g];m=this.getDistant(k,f);if(m>0){h.push(k)}else{continue}if(m>j){j=m;e=k}}return{maxPoint:e,newPoints:h}},buildConvexHull:function(d,g){var f=[],e=this.findMostDistantPointFromBaseLine(d,g);if(e.maxPoint){f=f.concat(this.buildConvexHull([d[0],e.maxPoint],e.newPoints));f=f.concat(this.buildConvexHull([e.maxPoint,d[1]],e.newPoints));return f}else{return[d[0]]}},getConvexHull:function(j){var o=false,g=false,p=false,k=false,l=null,q=null,f=null,h=null,n=null,e=null,m;for(m=j.length-1;m>=0;m--){var r=j[m];if(o===false||r.lat>o){l=r;o=r.lat}if(g===false||r.lat<g){q=r;g=r.lat}if(p===false||r.lng>p){f=r;p=r.lng}if(k===false||r.lng<k){h=r;k=r.lng}}if(g!==o){e=q;n=l}else{e=h;n=f}var d=[].concat(this.buildConvexHull([e,n],j),this.buildConvexHull([n,e],j));return d}}}());L.MarkerCluster.include({getConvexHull:function(){var g=this.getAllChildMarkers(),e=[],f,d;for(d=g.length-1;d>=0;d--){f=g[d].getLatLng();e.push(f)}return L.QuickHull.getConvexHull(e)}});L.MarkerCluster.include({_2PI:Math.PI*2,_circleFootSeparation:25,_circleStartAngle:Math.PI/6,_spiralFootSeparation:28,_spiralLengthStart:11,_spiralLengthFactor:5,_circleSpiralSwitchover:9,spiderfy:function(){if(this._group._spiderfied===this||this._group._inZoomAnimation){return}var h=this.getAllChildMarkers(),g=this._group,f=g._map,d=f.latLngToLayerPoint(this._latlng),e;this._group._unspiderfy();this._group._spiderfied=this;if(h.length>=this._circleSpiralSwitchover){e=this._generatePointsSpiral(h.length,d)}else{d.y+=10;e=this._generatePointsCircle(h.length,d)}this._animationSpiderfy(h,e)},unspiderfy:function(d){if(this._group._inZoomAnimation){return}this._animationUnspiderfy(d);this._group._spiderfied=null},_generatePointsCircle:function(h,l){var d=this._group.options.spiderfyDistanceMultiplier*this._circleFootSeparation*(2+h),j=d/this._2PI,g=this._2PI/h,f=[],e,k;f.length=h;for(e=h-1;e>=0;e--){k=this._circleStartAngle+e*g;f[e]=new L.Point(l.x+j*Math.cos(k),l.y+j*Math.sin(k))._round()}return f},_generatePointsSpiral:function(j,d){var m=this._group.options.spiderfyDistanceMultiplier,l=m*this._spiralLengthStart,f=m*this._spiralFootSeparation,g=m*this._spiralLengthFactor*this._2PI,e=0,k=[],h;k.length=j;for(h=j-1;h>=0;h--){e+=f/l+h*0.0005;k[h]=new L.Point(d.x+l*Math.cos(e),d.y+l*Math.sin(e))._round();l+=g/e}return k},_noanimationUnspiderfy:function(){var j=this._group,h=j._map,e=j._featureGroup,g=this.getAllChildMarkers(),d,f;j._ignoreMove=true;this.setOpacity(1);for(f=g.length-1;f>=0;f--){d=g[f];e.removeLayer(d);if(d._preSpiderfyLatlng){d.setLatLng(d._preSpiderfyLatlng);delete d._preSpiderfyLatlng}if(d.setZIndexOffset){d.setZIndexOffset(0)}if(d._spiderLeg){h.removeLayer(d._spiderLeg);delete d._spiderLeg}}j.fire("unspiderfied",{cluster:this,markers:g});j._ignoreMove=false;j._spiderfied=null}});L.MarkerClusterNonAnimated=L.MarkerCluster.extend({_animationSpiderfy:function(g,k){var o=this._group,e=o._map,d=o._featureGroup,f=this._group.options.spiderLegPolylineOptions,j,h,n,l;o._ignoreMove=true;for(j=0;j<g.length;j++){l=e.layerPointToLatLng(k[j]);h=g[j];n=new L.Polyline([this._latlng,l],f);e.addLayer(n);h._spiderLeg=n;h._preSpiderfyLatlng=h._latlng;h.setLatLng(l);if(h.setZIndexOffset){h.setZIndexOffset(1000000)}d.addLayer(h)}this.setOpacity(0.3);o._ignoreMove=false;o.fire("spiderfied",{cluster:this,markers:g})},_animationUnspiderfy:function(){this._noanimationUnspiderfy()}});L.MarkerCluster.include({_animationSpiderfy:function(l,o){var s=this,v=this._group,g=v._map,d=v._featureGroup,j=this._latlng,q=g.latLngToLayerPoint(j),p=L.Path.SVG,f=L.extend({},this._group.options.spiderLegPolylineOptions),h=f.opacity,n,k,u,e,t,r;if(h===c){h=L.MarkerClusterGroup.prototype.options.spiderLegPolylineOptions.opacity}if(p){f.opacity=0;f.className=(f.className||"")+" leaflet-cluster-spider-leg"}else{f.opacity=h}v._ignoreMove=true;for(n=0;n<l.length;n++){k=l[n];r=g.layerPointToLatLng(o[n]);u=new L.Polyline([j,r],f);g.addLayer(u);k._spiderLeg=u;if(p){e=u._path;t=e.getTotalLength()+0.1;e.style.strokeDasharray=t;e.style.strokeDashoffset=t}if(k.setZIndexOffset){k.setZIndexOffset(1000000)}if(k.clusterHide){k.clusterHide()}d.addLayer(k);if(k._setPos){k._setPos(q)}}v._forceLayout();v._animationStart();for(n=l.length-1;n>=0;n--){r=g.layerPointToLatLng(o[n]);k=l[n];k._preSpiderfyLatlng=k._latlng;k.setLatLng(r);if(k.clusterShow){k.clusterShow()}if(p){u=k._spiderLeg;e=u._path;e.style.strokeDashoffset=0;u.setStyle({opacity:h})}}this.setOpacity(0.3);v._ignoreMove=false;setTimeout(function(){v._animationEnd();v.fire("spiderfied",{cluster:s,markers:l})},200)},_animationUnspiderfy:function(s){var o=this,r=this._group,f=r._map,d=r._featureGroup,n=s?f._latLngToNewLayerPoint(this._latlng,s.zoom,s.center):f.latLngToLayerPoint(this._latlng),h=this.getAllChildMarkers(),l=L.Path.SVG,g,k,q,e,p,j;r._ignoreMove=true;r._animationStart();this.setOpacity(1);for(k=h.length-1;k>=0;k--){g=h[k];if(!g._preSpiderfyLatlng){continue}g.setLatLng(g._preSpiderfyLatlng);delete g._preSpiderfyLatlng;j=true;if(g._setPos){g._setPos(n);j=false}if(g.clusterHide){g.clusterHide();j=false}if(j){d.removeLayer(g)}if(l){q=g._spiderLeg;e=q._path;p=e.getTotalLength()+0.1;e.style.strokeDashoffset=p;q.setStyle({opacity:0})}}r._ignoreMove=false;setTimeout(function(){var m=0;for(k=h.length-1;k>=0;k--){g=h[k];if(g._spiderLeg){m++}}for(k=h.length-1;k>=0;k--){g=h[k];if(!g._spiderLeg){continue}if(g.clusterShow){g.clusterShow()}if(g.setZIndexOffset){g.setZIndexOffset(0)}if(m>1){d.removeLayer(g)}f.removeLayer(g._spiderLeg);delete g._spiderLeg}r._animationEnd();r.fire("unspiderfied",{cluster:o,markers:h})},200)}});L.MarkerClusterGroup.include({_spiderfied:null,unspiderfy:function(){this._unspiderfy.apply(this,arguments)},_spiderfierOnAdd:function(){this._map.on("click",this._unspiderfyWrapper,this);if(this._map.options.zoomAnimation){this._map.on("zoomstart",this._unspiderfyZoomStart,this)}this._map.on("zoomend",this._noanimationUnspiderfy,this);if(!L.Browser.touch){this._map.getRenderer(this)}},_spiderfierOnRemove:function(){this._map.off("click",this._unspiderfyWrapper,this);this._map.off("zoomstart",this._unspiderfyZoomStart,this);this._map.off("zoomanim",this._unspiderfyZoomAnim,this);this._map.off("zoomend",this._noanimationUnspiderfy,this);this._noanimationUnspiderfy()},_unspiderfyZoomStart:function(){if(!this._map){return}this._map.on("zoomanim",this._unspiderfyZoomAnim,this)},_unspiderfyZoomAnim:function(d){if(L.DomUtil.hasClass(this._map._mapPane,"leaflet-touching")){return}this._map.off("zoomanim",this._unspiderfyZoomAnim,this);this._unspiderfy(d)},_unspiderfyWrapper:function(){this._unspiderfy()},_unspiderfy:function(d){if(this._spiderfied){this._spiderfied.unspiderfy(d)}},_noanimationUnspiderfy:function(){if(this._spiderfied){this._spiderfied._noanimationUnspiderfy()}},_unspiderfyLayer:function(d){if(d._spiderLeg){this._featureGroup.removeLayer(d);if(d.clusterShow){d.clusterShow()}if(d.setZIndexOffset){d.setZIndexOffset(0)}this._map.removeLayer(d._spiderLeg);delete d._spiderLeg}}});L.MarkerClusterGroup.include({refreshClusters:function(d){if(!d){d=this._topClusterLevel.getAllChildMarkers()}else{if(d instanceof L.MarkerClusterGroup){d=d._topClusterLevel.getAllChildMarkers()}else{if(d instanceof L.LayerGroup){d=d._layers}else{if(d instanceof L.MarkerCluster){d=d.getAllChildMarkers()}else{if(d instanceof L.Marker){d=[d]}}}}}this._flagParentsIconsNeedUpdate(d);this._refreshClustersIcons();if(this.options.singleMarkerMode){this._refreshSingleMarkerModeMarkers(d)}return this},_flagParentsIconsNeedUpdate:function(e){var f,d;for(f in e){d=e[f].__parent;while(d){d._iconNeedsUpdate=true;d=d.__parent}}},_refreshClustersIcons:function(){this._featureGroup.eachLayer(function(d){if(d instanceof L.MarkerCluster&&d._iconNeedsUpdate){d._updateIcon()}})},_refreshSingleMarkerModeMarkers:function(e){var f,d;for(f in e){d=e[f];if(this.hasLayer(d)){d.setIcon(this._overrideMarkerIcon(d))}}}});L.Marker.include({refreshIconOptions:function(e,d){var f=this.options.icon;L.setOptions(f,e);this.setIcon(f);if(d&&this.__parent){this.__parent._group.refreshClusters(this)}return this}})}(window,document));L.NonTiledLayer=L.Layer.extend({includes:L.Mixin.Events,options:{attribution:"",opacity:1,zIndex:undefined,minZoom:0,maxZoom:18,pointerEvents:null,errorImageUrl:"data:image/gif;base64,R0lGODlhAQABAHAAACH5BAUAAAAALAAAAAABAAEAAAICRAEAOw==",bounds:L.latLngBounds([-85.05,-180],[85.05,180])},url:"",initialize:function(a){L.setOptions(this,a)},onAdd:function(a){this._map=a;if(!this._div){this._div=L.DomUtil.create("div","leaflet-image-layer");if(this.options.pointerEvents){this._div.style["pointer-events"]=this.options.pointerEvents}if(this.options.zIndex!==undefined){this._div.style.zIndex=this.options.zIndex}if(this.options.opacity!==undefined){this._div.style.opacity=this.options.opacity}}this.getPane().appendChild(this._div);this._bufferImage=this._initImage();this._currentImage=this._initImage();this._update()},onRemove:function(a){this.getPane().removeChild(this._div);this._div.removeChild(this._bufferImage);this._div.removeChild(this._currentImage)},addTo:function(a){a.addLayer(this);return this},getEvents:function(){var a={moveend:this._update,zoom:this._viewreset};if(this._zoomAnimated){a.zoomanim=this._animateZoom}return a},getElement:function(){return this._div},setOpacity:function(a){this.options.opacity=a;if(this._div){L.DomUtil.setOpacity(this._div,this.options.opacity)}return this},setZIndex:function(a){if(a){this.options.zIndex=a;if(this._div){this._div.style.zIndex=a}}return this},bringToFront:function(){if(this._div){this._pane.appendChild(this._div)}return this},bringToBack:function(){if(this._div){this._pane.insertBefore(this._div,this._pane.firstChild)}return this},getAttribution:function(){return this.options.attribution},_initImage:function(a){var a=L.DomUtil.create("img","leaflet-image-layer");this._div.appendChild(a);if(this._map.options.zoomAnimation&&L.Browser.any3d){L.DomUtil.addClass(a,"leaflet-zoom-animated")}else{L.DomUtil.addClass(a,"leaflet-zoom-hide")}L.extend(a,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.bind(this._onImageLoad,this),onerror:L.bind(this._onImageError,this)});return a},redraw:function(){if(this._map){this._update()}return this},_animateZoom:function(a){if(this._currentImage._bounds){this._animateImage(this._currentImage,a)}if(this._bufferImage._bounds){this._animateImage(this._bufferImage,a)}},_animateImage:function(b,a){var d=this._map.getZoomScale(a.zoom),c=this._map._latLngToNewLayerPoint(b._bounds.getNorthWest(),a.zoom,a.center);L.DomUtil.setTransform(b,c,d)},_resetImage:function(c){var b=new L.Bounds(this._map.latLngToLayerPoint(c._bounds.getNorthWest()),this._map.latLngToLayerPoint(c._bounds.getSouthEast())),a=b.getSize();L.DomUtil.setPosition(c,b.min);c.style.width=a.x+"px";c.style.height=a.y+"px"},_getClippedBounds:function(){var b=this._map.getBounds();var l=b.getSouth();var f=b.getNorth();var j=b.getWest();var d=b.getEast();var c=this.options.bounds.getSouth();var a=this.options.bounds.getNorth();var k=this.options.bounds.getWest();var h=this.options.bounds.getEast();if(l<c){l=c}if(f>a){f=a}if(j<k){j=k}if(d>h){d=h}var g=new L.LatLng(f,j);var e=new L.LatLng(l,d);return new L.LatLngBounds(g,e)},_viewreset:function(){if(this._bufferImage._bounds){this._resetImage(this._bufferImage)}if(this._currentImage._bounds){this._resetImage(this._currentImage)}},_update:function(){if(this._map.getZoom()<this.options.minZoom||this._map.getZoom()>this.options.maxZoom){this._div.style.visibility="hidden";return}else{this._div.style.visibility="visible"}if(this._bufferImage._bounds){this._resetImage(this._bufferImage)}var f=this._getClippedBounds();var e=this._map.latLngToContainerPoint(f.getNorthWest());var d=this._map.latLngToContainerPoint(f.getSouthEast());var c=d.x-e.x;var a=d.y-e.y;if(c<32||a<32){return}this._currentImage._bounds=f;this._resetImage(this._currentImage);var b=this._currentImage;if(this.getImageUrl){b.src=this.getImageUrl(f.getNorthWest(),f.getSouthEast(),c,a)}else{this.getImageUrlAsync(f.getNorthWest(),f.getSouthEast(),c,a,function(h,g){b.src=h;b.tag=g})}this.url=b.src;L.DomUtil.setOpacity(this._currentImage,0)},_onImageError:function(a){this.fire("error",a);L.DomUtil.addClass(a.target,"invalid");if(a.target.src!==this.options.errorImageUrl){a.target.src=this.options.errorImageUrl;this._onImageDone(false,a)}},_onImageLoad:function(a){if(a.target.src!==this.options.errorImageUrl){L.DomUtil.removeClass(a.target,"invalid");if(a.target.src!==this.url){return}this._onImageDone(true,a)}},_onImageDone:function(c,b){L.DomUtil.setOpacity(this._currentImage,1);L.DomUtil.setOpacity(this._bufferImage,0);if(this._addInteraction){this._addInteraction(this._currentImage.tag)}var a=this._bufferImage;this._bufferImage=this._currentImage;this._currentImage=a;this.fire("load",b)}});L.nonTiledLayer=function(){return new L.NonTiledLayer()};L.NonTiledLayer.WMS=L.NonTiledLayer.extend({defaultWmsParams:{service:"WMS",request:"GetMap",version:"1.1.1",layers:"",styles:"",format:"image/jpeg",transparent:false},options:{crs:null,uppercase:false},initialize:function(c,b){this._wmsUrl=c;var a=L.extend({},this.defaultWmsParams);for(var d in b){if(!L.NonTiledLayer.prototype.options.hasOwnProperty(d)&&!L.Layer.prototype.options.hasOwnProperty(d)){a[d]=b[d]}}this.wmsParams=a;L.setOptions(this,b)},onAdd:function(a){this._crs=this.options.crs||a.options.crs;this._wmsVersion=parseFloat(this.wmsParams.version);var b=this._wmsVersion>=1.3?"crs":"srs";this.wmsParams[b]=this._crs.code;L.NonTiledLayer.prototype.onAdd.call(this,a)},getImageUrl:function(f,e,b,j){var g=this.wmsParams;g.width=b;g.height=j;var c=this._crs.project(f);var d=this._crs.project(e);var a=this._wmsUrl;var h=h=(this._wmsVersion>=1.3&&this._crs===L.CRS.EPSG4326?[d.y,c.x,c.y,d.x]:[c.x,d.y,d.x,c.y]).join(",");return a+L.Util.getParamString(this.wmsParams,a,this.options.uppercase)+(this.options.uppercase?"&BBOX=":"&bbox=")+h},setParams:function(b,a){L.extend(this.wmsParams,b);if(!a){this.redraw()}return this}});L.nonTiledLayer.wms=function(b,a){return new L.NonTiledLayer.WMS(b,a)};GV.Buttons.baselayers=function(a,b){if(GV.globals.SMALL_SCREEN){return null}return L.control.baseLayersSwitcher(b.baseLayers,[],{position:a.position}).addTo(b)};GV.Buttons.fullscreen=function(a,b){return L.control.fullscreen(a)};GV.Buttons.geocoder=function(a,b){return new L.Control.Geocoder(a)};GV.Buttons.legend=function(b,c){if(b.show&&!GV.globals.SMALL_SCREEN&&!GV.Util.isTouch()){$("#gv-legend").css({display:"block"})}else{$("#gv-legend").css({display:"none"})}var a=_.extend(b,{leafletClasses:true,states:[{stateName:"print",onClick:function(d,e){$("#gv-legend").css({display:"block"})},title:"Legenda",icon:"ms ms-layers"}]});return L.easyButton(a)};GV.Buttons.locate=function(a,b){return new L.Control.Locate(a)};GV.Buttons.navbar=function(a,b){if(GV.Util.isTouch()){return null}return L.control.navbar(a)};GV.Buttons.print=function(b,c){if(GV.globals.SMALL_SCREEN){return null}var a=_.extend(b,{leafletClasses:true,states:[{stateName:"print",onClick:function(d,e){console.log("print")},title:"Stampa",icon:"fa-print"}]});return L.easyButton(a)};GV.Buttons.search=function(a,c){var b=[];_.each(a.layers,function(d){b.push(c.getLayerByName(d))});a.layer=L.layerGroup(b);return new L.Control.Search(a)};GV.Buttons.zoom=function(a,b){if(GV.Util.isTouch()){return null}return L.control.zoom(a)};GV.config={debug:false,idMap:null,application:{},baseLayers:[{type:"ESRI_IMAGERY",visible:true}],maps:[],lastZIndex:21,getAllLayersConfig:function(){var a=[];_.each(this.maps,function(b){_.each(b.layers,function(c){a.push(c)})});return a},setLayerAttribute:function(b,c,d){var a=null;_.each(this.maps,function(f){var e=f.layers;_.each(e,function(g){if(g.name===b){g[c]=d}})})},addMapConfig:function(a){_.each(a.layers,function(b){if(b.minScale===0){b.minScale=591657550}b.zIndex=GV.config.lastZIndex++;if(GV.map){b.inRange=GV.map.layerInRange(b)}else{b.inRange=true}});a.layers.reverse();this.maps.unshift(a)},getLayerConfig:function(b){var a=null;_.each(this.maps,function(d){var c=d.layers;a=_.find(c,function(e){return e.name===b})});if(a){return a}}};L.Control.BaseLayersSwitcher=L.Control.extend({options:{collapsed:true,position:"topright",autoZIndex:true,hideSingleBase:false},initialize:function(d,c,a){L.setOptions(this,a);this._layers=[];this._lastZIndex=0;this._handlingClick=false;for(var b in d){this._addLayer(d[b],b)}for(b in c){this._addLayer(c[b],b,true)}},onAdd:function(a){this._initLayout();this._update();this._map=a;a.on("zoomend",this._checkDisabledLayers,this);return this._container},onRemove:function(){this._map.off("zoomend",this._checkDisabledLayers,this);for(var a=0;a<this._layers.length;a++){this._layers[a].layer.off("add remove",this._onLayerChange,this)}},addBaseLayer:function(b,a){this._addLayer(b,a);return(this._map)?this._update():this},addOverlay:function(b,a){this._addLayer(b,a,true);return(this._map)?this._update():this},removeLayer:function(a){a.off("add remove",this._onLayerChange,this);var b=this._getLayer(L.stamp(a));if(b){this._layers.splice(this._layers.indexOf(b),1)}return(this._map)?this._update():this},expand:function(){L.DomUtil.addClass(this._container,"leaflet-control-layers-expanded");this._form.style.height=null;var a=this._map.getSize().y-(this._container.offsetTop+50);if(a<this._form.clientHeight){L.DomUtil.addClass(this._form,"leaflet-control-layers-scrollbar");this._form.style.height=a+"px"}else{L.DomUtil.removeClass(this._form,"leaflet-control-layers-scrollbar")}this._checkDisabledLayers();return this},collapse:function(){L.DomUtil.removeClass(this._container,"leaflet-control-layers-expanded");return this},_initLayout:function(){var b="leaflet-control-layers",a=this._container=L.DomUtil.create("div",b);a.setAttribute("aria-haspopup",true);L.DomEvent.disableClickPropagation(a);if(!L.Browser.touch){L.DomEvent.disableScrollPropagation(a)}var d=this._form=L.DomUtil.create("form",b+"-list");if(this.options.collapsed){if(!L.Browser.android){L.DomEvent.on(a,{mouseenter:this.expand,mouseleave:this.collapse},this)}var c=this._layersLink=L.DomUtil.create("a","ms ms-globe "+b+"-toggle",a);c.href="#";c.title="Layers";if(L.Browser.touch){L.DomEvent.on(c,"click",L.DomEvent.stop).on(c,"click",this.expand,this)}else{L.DomEvent.on(c,"focus",this.expand,this)}L.DomEvent.on(d,"click",function(){setTimeout(L.bind(this._onInputClick,this),0)},this);this._map.on("click",this.collapse,this)}else{this.expand()}this._baseLayersList=L.DomUtil.create("div",b+"-base",d);this._separator=L.DomUtil.create("div",b+"-separator",d);this._overlaysList=L.DomUtil.create("div",b+"-overlays",d);a.appendChild(d)},_getLayer:function(b){for(var a=0;a<this._layers.length;a++){if(this._layers[a]&&L.stamp(this._layers[a].layer)===b){return this._layers[a]}}},_addLayer:function(c,b,a){c.on("add remove",this._onLayerChange,this);this._layers.push({layer:c,name:b,overlay:a});if(this.options.autoZIndex&&c.setZIndex){this._lastZIndex++;c.setZIndex(this._lastZIndex)}},_update:function(){if(!this._container){return this}L.DomUtil.empty(this._baseLayersList);L.DomUtil.empty(this._overlaysList);var a,d,c,e,b=0;for(c=0;c<this._layers.length;c++){e=this._layers[c];this._addItem(e);d=d||e.overlay;a=a||!e.overlay;b+=!e.overlay?1:0}if(this.options.hideSingleBase){a=a&&b>1;this._baseLayersList.style.display=a?"":"none"}this._separator.style.display=d&&a?"":"none";return this},_onLayerChange:function(c){if(!this._handlingClick){this._update()}var b=this._getLayer(L.stamp(c.target));var a=b.overlay?(c.type==="add"?"overlayadd":"overlayremove"):(c.type==="add"?"baselayerchange":null);if(a){this._map.fire(a,b)}},_createRadioElement:function(a,d){var c='<input type="radio" class="leaflet-control-layers-selector" name="'+a+'"'+(d?' checked="checked"':"")+"/>";var b=document.createElement("div");b.innerHTML=c;return b.firstChild},_addItem:function(g){var d=document.createElement("label"),f=this._map.hasLayer(g.layer),b;if(g.overlay){b=document.createElement("input");b.type="checkbox";b.className="leaflet-control-layers-selector";b.defaultChecked=f}else{b=this._createRadioElement("leaflet-base-layers",f)}b.layerId=L.stamp(g.layer);L.DomEvent.on(b,"click",this._onInputClick,this);var c=document.createElement("span");c.innerHTML="&nbsp;&nbsp"+g.name;var e=document.createElement("div");d.appendChild(e);e.appendChild(b);e.appendChild(c);var a=g.overlay?this._overlaysList:this._baseLayersList;a.appendChild(d);this._checkDisabledLayers();return d},_onInputClick:function(){var b=this._form.getElementsByTagName("input"),c,g,a;var e=[],d=[];this._handlingClick=true;for(var f=b.length-1;f>=0;f--){c=b[f];g=this._getLayer(c.layerId).layer;a=this._map.hasLayer(g);if(c.checked&&!a){e.push(g)}else{if(!c.checked&&a){d.push(g)}}}for(f=0;f<d.length;f++){this._map.removeLayer(d[f])}for(f=0;f<e.length;f++){this._map.addLayer(e[f])}this._handlingClick=false;this._refocusOnMap()},_checkDisabledLayers:function(){var a=this._form.getElementsByTagName("input"),b,d,e=this._map.getZoom();for(var c=a.length-1;c>=0;c--){b=a[c];d=this._getLayer(b.layerId).layer;b.disabled=(d.options.minZoom!==undefined&&e<d.options.minZoom)||(d.options.maxZoom!==undefined&&e>d.options.maxZoom)}},_expand:function(){return this.expand()},_collapse:function(){return this.collapse()}});L.control.baseLayersSwitcher=function(c,b,a){return new L.Control.BaseLayersSwitcher(c,b,a)};(function(){L.Control.EasyBar=L.Control.extend({options:{position:"topleft",id:null,leafletClasses:true},initialize:function(e,c){if(c){L.Util.setOptions(this,c)}this._buildContainer();this._buttons=[];for(var d=0;d<e.length;d++){e[d]._bar=this;e[d]._container=e[d].button;this._buttons.push(e[d]);this.container.appendChild(e[d].button)}},_buildContainer:function(){this._container=this.container=L.DomUtil.create("div","");this.options.leafletClasses&&L.DomUtil.addClass(this.container,"leaflet-bar easy-button-container leaflet-control");this.options.id&&(this.container.id=this.options.id)},enable:function(){L.DomUtil.addClass(this.container,"enabled");L.DomUtil.removeClass(this.container,"disabled");this.container.setAttribute("aria-hidden","false");return this},disable:function(){L.DomUtil.addClass(this.container,"disabled");L.DomUtil.removeClass(this.container,"enabled");this.container.setAttribute("aria-hidden","true");return this},onAdd:function(){return this.container},addTo:function(f){this._map=f;for(var d=0;d<this._buttons.length;d++){this._buttons[d]._map=f}var c=this._container=this.onAdd(f),g=this.getPosition(),e=f._controlCorners[g];L.DomUtil.addClass(c,"leaflet-control");if(g.indexOf("bottom")!==-1){e.insertBefore(c,e.firstChild)}else{e.appendChild(c)}return this}});L.easyBar=function(){var c=[L.Control.EasyBar];for(var d=0;d<arguments.length;d++){c.push(arguments[d])}return new (Function.prototype.bind.apply(L.Control.EasyBar,c))};L.Control.EasyButton=L.Control.extend({options:{position:"topleft",id:null,type:"replace",states:[],leafletClasses:true,tagName:"button"},initialize:function(d,f,e,g){this.options.states=[];if(g!=null){this.options.id=g}this.storage={};if(typeof arguments[arguments.length-1]==="object"){L.Util.setOptions(this,arguments[arguments.length-1])}if(this.options.states.length===0&&typeof d==="string"&&typeof f==="function"){this.options.states.push({icon:d,onClick:f,title:typeof e==="string"?e:""})}this._states=[];for(var c=0;c<this.options.states.length;c++){this._states.push(new b(this.options.states[c],this))}this._buildButton();this._activateState(this._states[0])},_buildButton:function(){this.button=L.DomUtil.create(this.options.tagName,"");if(this.tagName==="button"){this.button.type="button"}if(this.options.id){this.button.id=this.options.id}if(this.options.leafletClasses){L.DomUtil.addClass(this.button,"leaflet-bar-part leaflet-interactive easy-button gv-bgcolor")}L.DomEvent.addListener(this.button,"dblclick",L.DomEvent.stop);L.DomEvent.addListener(this.button,"mousedown",L.DomEvent.stop);L.DomEvent.addListener(this.button,"click",function(d){L.DomEvent.stop(d);this._currentState.onClick(this,this._map?this._map:null);this._map.getContainer().focus()},this);if(this.options.type=="replace"){this.button.appendChild(this._currentState.icon)}else{for(var c=0;c<this._states.length;c++){this.button.appendChild(this._states[c].icon)}}},_currentState:{stateName:"unnamed",icon:(function(){return document.createElement("span")})()},_states:null,state:function(c){if(typeof c=="string"){this._activateStateNamed(c)}else{if(typeof c=="number"){this._activateState(this._states[c])}}return this},_activateStateNamed:function(d){for(var c=0;c<this._states.length;c++){if(this._states[c].stateName==d){this._activateState(this._states[c])}}},_activateState:function(d){if(d===this._currentState){return}else{if(this.options.type=="replace"){this.button.appendChild(d.icon);this.button.removeChild(this._currentState.icon)}if(d.title){this.button.title=d.title}else{this.button.removeAttribute("title")}for(var c=0;c<this._states.length;c++){L.DomUtil.removeClass(this._states[c].icon,this._currentState.stateName+"-active");L.DomUtil.addClass(this._states[c].icon,d.stateName+"-active")}L.DomUtil.removeClass(this.button,this._currentState.stateName+"-active");L.DomUtil.addClass(this.button,d.stateName+"-active");this._currentState=d}},enable:function(){L.DomUtil.addClass(this.button,"enabled");L.DomUtil.removeClass(this.button,"disabled");this.button.setAttribute("aria-hidden","false");return this},disable:function(){L.DomUtil.addClass(this.button,"disabled");L.DomUtil.removeClass(this.button,"enabled");this.button.setAttribute("aria-hidden","true");return this},removeFrom:function(c){this._container.parentNode.removeChild(this._container);this._map=null;return this},onAdd:function(){var c=L.easyBar([this],{position:this.options.position,leafletClasses:this.options.leafletClasses});this._container=c.container;return this._container}});L.easyButton=function(){var c=Array.prototype.concat.apply([L.Control.EasyButton],arguments);return new (Function.prototype.bind.apply(L.Control.EasyButton,c))};function b(c,d){this.title=c.title;this.stateName=c.stateName?c.stateName:"unnamed-state";this.icon=L.DomUtil.create("span","");L.DomUtil.addClass(this.icon,"button-state state-"+this.stateName.replace(/(^\s*|\s*$)/g,""));this.icon.innerHTML=a(c.icon);this.onClick=L.Util.bind(c.onClick?c.onClick:function(){},d)}function a(d){var c;if(d.match(/[&;=<>"']/)){c=d}else{d=d.replace(/(^\s*|\s*$)/g,"");c=L.DomUtil.create("span","");if(d.indexOf("fa-")===0){L.DomUtil.addClass(c,"fa "+d)}else{if(d.indexOf("glyphicon-")===0){L.DomUtil.addClass(c,"glyphicon "+d)}else{L.DomUtil.addClass(c,d)}}c=c.outerHTML}return c}})();L.Control.Fullscreen=L.Control.extend({options:{position:"topleft",title:{"false":"Schermo intero","true":"Esci da Schermo intero"}},onAdd:function(b){var a=L.DomUtil.create("div","leaflet-control-fullscreen leaflet-bar leaflet-control");this.link=L.DomUtil.create("a","ms ms-max-extent",a);this.link.href="#";this._map=b;this._map.on("fullscreenchange",this._toggleTitle,this);this._toggleTitle();L.DomEvent.on(this.link,"click",this._click,this);return a},_click:function(a){L.DomEvent.stopPropagation(a);L.DomEvent.preventDefault(a);this._map.toggleFullscreen(this.options)},_toggleTitle:function(){this.link.title=this.options.title[this._map.isFullscreen()]}});L.Map.include({isFullscreen:function(){return this._isFullscreen||false},toggleFullscreen:function(b){var a=this.getContainer();if(this.isFullscreen()){if(b&&b.pseudoFullscreen){this._disablePseudoFullscreen(a)}else{if(document.exitFullscreen){document.exitFullscreen()}else{if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else{if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}else{if(document.msExitFullscreen){document.msExitFullscreen()}else{this._disablePseudoFullscreen(a)}}}}}}else{if(b&&b.pseudoFullscreen){this._enablePseudoFullscreen(a)}else{if(a.requestFullscreen){a.requestFullscreen()}else{if(a.mozRequestFullScreen){a.mozRequestFullScreen()}else{if(a.webkitRequestFullscreen){a.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}else{if(a.msRequestFullscreen){a.msRequestFullscreen()}else{this._enablePseudoFullscreen(a)}}}}}}},_enablePseudoFullscreen:function(a){L.DomUtil.addClass(a,"leaflet-pseudo-fullscreen");this._setFullscreen(true);this.invalidateSize();this.fire("fullscreenchange")},_disablePseudoFullscreen:function(a){L.DomUtil.removeClass(a,"leaflet-pseudo-fullscreen");this._setFullscreen(false);this.invalidateSize();this.fire("fullscreenchange")},_setFullscreen:function(b){this._isFullscreen=b;var a=this.getContainer();if(b){L.DomUtil.addClass(a,"leaflet-fullscreen-on")}else{L.DomUtil.removeClass(a,"leaflet-fullscreen-on")}},_onFullscreenChange:function(b){var a=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement;if(a===this.getContainer()&&!this._isFullscreen){this._setFullscreen(true);this.fire("fullscreenchange")}else{if(a!==this.getContainer()&&this._isFullscreen){this._setFullscreen(false);this.fire("fullscreenchange")}}}});L.Map.mergeOptions({fullscreenControl:false});L.Map.addInitHook(function(){if(this.options.fullscreenControl){this.fullscreenControl=new L.Control.Fullscreen(this.options.fullscreenControl);this.addControl(this.fullscreenControl)}var b;if("onfullscreenchange" in document){b="fullscreenchange"}else{if("onmozfullscreenchange" in document){b="mozfullscreenchange"}else{if("onwebkitfullscreenchange" in document){b="webkitfullscreenchange"}else{if("onmsfullscreenchange" in document){b="MSFullscreenChange"}}}}if(b){var a=L.bind(this._onFullscreenChange,this);this.whenReady(function(){L.DomEvent.on(document,b,a)});this.on("unload",function(){L.DomEvent.off(document,b,a)})}});L.control.fullscreen=function(a){return new L.Control.Fullscreen(a)};(function(){L.Control.Geocoder=L.Control.extend({options:{showResultIcons:false,collapsed:true,expand:"click",position:"topright",placeholder:"Ricerca Indirizzo...",errorMessage:"Non trovato."},_callbackId:0,initialize:function(a){L.Util.setOptions(this,a);if(!this.options.geocoder){this.options.geocoder=new L.Control.Geocoder.Nominatim()}},onAdd:function(f){var d="leaflet-control-geocoder",a=L.DomUtil.create("div",d+" leaflet-bar"),c=L.DomUtil.create("a","ms ms-zoom",a),e=this._form=L.DomUtil.create("form",d+"-form",a),b;c.innerHTML="";c.href="javascript:void(0);";this._map=f;this._container=a;b=this._input=L.DomUtil.create("input");b.type="text";b.placeholder=this.options.placeholder;L.DomEvent.addListener(b,"keydown",this._keydown,this);this._errorElement=document.createElement("div");this._errorElement.className=d+"-form-no-error";this._errorElement.innerHTML=this.options.errorMessage;this._alts=L.DomUtil.create("ul",d+"-alternatives leaflet-control-geocoder-alternatives-minimized");e.appendChild(b);this._container.appendChild(this._errorElement);a.appendChild(this._alts);L.DomEvent.addListener(e,"submit",this._geocode,this);if(this.options.collapsed){if(this.options.expand==="click"){L.DomEvent.addListener(c,"click",function(g){if(g.button===0&&g.detail!==2){this._toggle()}},this)}else{L.DomEvent.addListener(c,"mouseover",this._expand,this);L.DomEvent.addListener(c,"mouseout",this._collapse,this);this._map.on("movestart",this._collapse,this)}}else{L.DomEvent.addListener(c,"click",function(g){this._geocode(g)},this);this._expand()}L.DomEvent.disableClickPropagation(a);return a},_geocodeResult:function(b){L.DomUtil.removeClass(this._container,"leaflet-control-geocoder-throbber");if(b.length===1){this._geocodeResultSelected(b[0])}else{if(b.length>0){this._alts.innerHTML="";this._results=b;L.DomUtil.removeClass(this._alts,"leaflet-control-geocoder-alternatives-minimized");for(var a=0;a<b.length;a++){this._alts.appendChild(this._createAlt(b[a],a))}}else{L.DomUtil.addClass(this._errorElement,"leaflet-control-geocoder-error")}}},markGeocode:function(a){this._map.fitBounds(a.bbox);this._map.setZoom(16);if(this._geocodeMarker){this._map.removeLayer(this._geocodeMarker)}this._geocodeMarker=new L.Marker(a.center).bindPopup(a.html||a.name).addTo(this._map).openPopup();return this},_geocode:function(a){L.DomEvent.preventDefault(a);L.DomUtil.addClass(this._container,"leaflet-control-geocoder-throbber");this._clearResults();this.options.geocoder.geocode(this._input.value,this._geocodeResult,this);return false},_geocodeResultSelected:function(a){if(this.options.collapsed){this._collapse()}else{this._clearResults()}this.markGeocode(a)},_toggle:function(){if(this._container.className.indexOf("leaflet-control-geocoder-expanded")>=0){this._collapse()}else{this._expand()}},_expand:function(){L.DomUtil.addClass(this._container,"leaflet-control-geocoder-expanded");this._input.select()},_collapse:function(){this._container.className=this._container.className.replace(" leaflet-control-geocoder-expanded","");L.DomUtil.addClass(this._alts,"leaflet-control-geocoder-alternatives-minimized");L.DomUtil.removeClass(this._errorElement,"leaflet-control-geocoder-error")},_clearResults:function(){L.DomUtil.addClass(this._alts,"leaflet-control-geocoder-alternatives-minimized");this._selection=null;L.DomUtil.removeClass(this._errorElement,"leaflet-control-geocoder-error")},_createAlt:function(c,e){var b=L.DomUtil.create("li",""),d=L.DomUtil.create("a","",b),f=this.options.showResultIcons&&c.icon?L.DomUtil.create("img","",d):null,g=c.html?undefined:document.createTextNode(c.name),h=function h(a){L.DomEvent.preventDefault(a);this._geocodeResultSelected(c)};if(f){f.src=c.icon}b.setAttribute("data-result-index",e);if(c.html){d.innerHTML=c.html}else{d.appendChild(g)}L.DomEvent.addListener(b,"click",h,this);return b},_keydown:function(c){var d=this,a=function a(e){if(d._selection){L.DomUtil.removeClass(d._selection,"leaflet-control-geocoder-selected");d._selection=d._selection[e>0?"nextSibling":"previousSibling"]}if(!d._selection){d._selection=d._alts[e>0?"firstChild":"lastChild"]}if(d._selection){L.DomUtil.addClass(d._selection,"leaflet-control-geocoder-selected")}};switch(c.keyCode){case 27:if(this.options.collapsed){this._collapse()}break;case 38:a(-1);L.DomEvent.preventDefault(c);break;case 40:a(1);L.DomEvent.preventDefault(c);break;case 13:if(this._selection){var b=parseInt(this._selection.getAttribute("data-result-index"),10);this._geocodeResultSelected(this._results[b]);this._clearResults();L.DomEvent.preventDefault(c)}}return true}});L.Control.geocoder=function(a){return new L.Control.Geocoder(a)};L.Control.Geocoder.callbackId=0;L.Control.Geocoder.jsonp=function(b,f,g,c,d){var e="_l_geocoder_"+(L.Control.Geocoder.callbackId++);f[d||"callback"]=e;window[e]=L.Util.bind(g,c);var a=document.createElement("script");a.type="text/javascript";a.src=b+L.Util.getParamString(f);a.id=e;document.getElementsByTagName("head")[0].appendChild(a)};L.Control.Geocoder.getJSON=function(b,c,d){var a=new XMLHttpRequest();a.onreadystatechange=function(){if(a.readyState!=4){return}if(a.status!=200&&a.status!=304){d("");return}d(JSON.parse(a.response))};a.open("GET",b+L.Util.getParamString(c),true);a.setRequestHeader("Accept","application/json");a.send(null)};L.Control.Geocoder.template=function(c,a,b){return c.replace(/\{ *([\w_]+) *\}/g,function(f,d){var e=a[d];if(e===undefined){e=""}else{if(typeof e==="function"){e=e(a)}}return L.Control.Geocoder.htmlEscape(e)})};L.Control.Geocoder.htmlEscape=(function(){var d=/[&<>"'`]/g;var b=/[&<>"'`]/;var c={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"};function a(e){return c[e]}return function(e){if(e==null){return""}else{if(!e){return e+""}}e=""+e;if(!b.test(e)){return e}return e.replace(d,a)}})();L.Control.Geocoder.Nominatim=L.Class.extend({options:{serviceUrl:"//nominatim.openstreetmap.org/",geocodingQueryParams:{countrycodes:"it",viewbox:"7.49958,44.791951,10.06312,43.730645",bounded:1},reverseQueryParams:{},htmlTemplate:function(a){var b=a.display_name.replace("Genoa,","").replace("Italia","").replace("Liguria,","");return L.Control.Geocoder.template(b.split(",").join("<br/>"),a.address,true)}},initialize:function(a){L.Util.setOptions(this,a)},geocode:function(c,a,b){L.Control.Geocoder.jsonp(this.options.serviceUrl+"search/",L.extend({q:c+" Liguria",limit:10,format:"json",addressdetails:1},this.options.geocodingQueryParams),function(g){var f=[];for(var e=g.length-1;e>=0;e--){var h=g[e].boundingbox;for(var d=0;d<4;d++){h[d]=parseFloat(h[d])}f[e]={icon:g[e].icon,name:g[e].display_name,html:this.options.htmlTemplate?this.options.htmlTemplate(g[e]):undefined,bbox:L.latLngBounds([h[0],h[2]],[h[1],h[3]]),center:L.latLng(g[e].lat,g[e].lon),properties:g[e]}}a.call(b,f)},this,"json_callback")},reverse:function(b,d,a,c){L.Control.Geocoder.jsonp(this.options.serviceUrl+"reverse/",L.extend({lat:b.lat,lon:b.lng,zoom:Math.round(Math.log(d/256)/Math.log(2)),addressdetails:1,format:"json"},this.options.reverseQueryParams),function(f){var e=[],g;if(f&&f.lat&&f.lon){g=L.latLng(f.lat,f.lon);e.push({name:f.display_name,html:this.options.htmlTemplate?this.options.htmlTemplate(f):undefined,center:g,bounds:L.latLngBounds(g,g),properties:f})}a.call(c,e)},this,"json_callback")}});L.Control.Geocoder.Google=L.Class.extend({options:{service_url:"https://maps.googleapis.com/maps/api/geocode/json"},initialize:function(a){this._key=a},geocode:function(c,a,b){var d={address:c};if(this._key&&this._key.length){d.key=this._key}L.Control.Geocoder.getJSON(this.options.service_url,d,function(h){var f=[],k,g,j;if(h.results&&h.results.length){for(var e=0;e<=h.results.length-1;e++){k=h.results[e];g=L.latLng(k.geometry.location);j=L.latLngBounds(L.latLng(k.geometry.viewport.northeast),L.latLng(k.geometry.viewport.southwest));f[e]={name:k.formatted_address,bbox:j,center:g}}}a.call(b,f)})},reverse:function(b,e,a,c){var d={latlng:encodeURIComponent(b.lat)+","+encodeURIComponent(b.lng)};if(this._key&&this._key.length){d.key=this._key}L.Control.Geocoder.getJSON(this.options.service_url,d,function(j){var g=[],l,h,k;if(j.results&&j.results.length){for(var f=0;f<=j.results.length-1;f++){l=j.results[f];h=L.latLng(l.geometry.location);k=L.latLngBounds(L.latLng(l.geometry.viewport.northeast),L.latLng(l.geometry.viewport.southwest));g[f]={name:l.formatted_address,bbox:k,center:h}}}a.call(c,g)})}});return L.Control.Geocoder})();
/*
 Copyright (c) 2016 Dominik Moritz

 This file is part of the leaflet locate control. It is licensed under the MIT license.
 You can find the project at: https://github.com/domoritz/leaflet-locatecontrol
 */
(function(a,b){if(typeof define==="function"&&define.amd){define(["leaflet"],a)}else{if(typeof exports==="object"){if(typeof b!=="undefined"&&b.L){module.exports=a(L)}else{module.exports=a(require("leaflet"))}}}if(typeof b!=="undefined"&&b.L){b.L.Control.Locate=a(L)}}(function(a){var b=a.Control.extend({options:{position:"topleft",layer:undefined,setView:"untilPan",keepCurrentZoomLevel:false,clickBehavior:{inView:"stop",outOfView:"setView",},drawCircle:true,drawMarker:true,markerClass:a.CircleMarker,circleStyle:{color:"#136AEC",fillColor:"#136AEC",fillOpacity:0.15,weight:2,opacity:0.5},markerStyle:{color:"#136AEC",fillColor:"#2A93EE",fillOpacity:0.7,weight:2,opacity:0.9,radius:5},followCircleStyle:{},followMarkerStyle:{},icon:"fa fa-map-marker",iconLoading:"fa fa-spinner fa-spin",iconElementTag:"span",circlePadding:[0,0],metric:true,onLocationError:function(c,d){alert(c.message)},onLocationOutsideMapBounds:function(c){c.stop();alert(c.options.strings.outsideMapBoundsMsg)},showPopup:true,strings:{title:"Show me where I am",metersUnit:"meters",feetUnit:"feet",popup:"You are within {distance} {unit} from this point",outsideMapBoundsMsg:"You seem located outside the boundaries of the map"},locateOptions:{maxZoom:Infinity,watch:true,setView:false}},initialize:function(c){for(var d in c){if(typeof this.options[d]==="object"){a.extend(this.options[d],c[d])}else{this.options[d]=c[d]}}this.options.followMarkerStyle=a.extend({},this.options.markerStyle,this.options.followMarkerStyle);this.options.followCircleStyle=a.extend({},this.options.circleStyle,this.options.followCircleStyle)},onAdd:function(d){var c=a.DomUtil.create("div","leaflet-control-locate leaflet-bar leaflet-control");this._layer=this.options.layer||new a.LayerGroup();this._layer.addTo(d);this._event=undefined;this._link=a.DomUtil.create("a","leaflet-bar-part leaflet-bar-part-single",c);this._link.href="#";this._link.title=this.options.strings.title;this._icon=a.DomUtil.create(this.options.iconElementTag,this.options.icon,this._link);a.DomEvent.on(this._link,"click",a.DomEvent.stopPropagation).on(this._link,"click",a.DomEvent.preventDefault).on(this._link,"click",this._onClick,this).on(this._link,"dblclick",a.DomEvent.stopPropagation);this._resetVariables();this._map.on("unload",this._unload,this);return c},_onClick:function(){this._justClicked=true;this._userPanned=false;if(this._active&&!this._event){this.stop()}else{if(this._active&&this._event!==undefined){var c=this._map.getBounds().contains(this._event.latlng)?this.options.clickBehavior.inView:this.options.clickBehavior.outOfView;switch(c){case"setView":this.setView();break;case"stop":this.stop();break}}else{this.start()}}this._updateContainerStyle()},start:function(){this._activate();if(this._event){this._drawMarker(this._map);if(this.options.setView){this.setView()}}this._updateContainerStyle()},stop:function(){this._deactivate();this._cleanClasses();this._resetVariables();this._removeMarker()},_activate:function(){if(!this._active){this._map.locate(this.options.locateOptions);this._active=true;this._map.on("locationfound",this._onLocationFound,this);this._map.on("locationerror",this._onLocationError,this);this._map.on("dragstart",this._onDrag,this)}},_deactivate:function(){this._map.stopLocate();this._active=false;this._map.off("locationfound",this._onLocationFound,this);this._map.off("locationerror",this._onLocationError,this);this._map.off("dragstart",this._onDrag,this)},setView:function(){if(this._isOutsideMapBounds()){this.options.onLocationOutsideMapBounds(this)}else{if(this.options.keepCurrentZoomLevel){this._map.panTo([this._event.latitude,this._event.longitude])}else{this._map.fitBounds(this._event.bounds,{padding:this.options.circlePadding,maxZoom:this.options.locateOptions.maxZoom})}}this._drawMarker()},_drawMarker:function(){if(this._event.accuracy===undefined){this._event.accuracy=0}var c=this._event.accuracy;var j=this._event.latlng;if(this.options.drawCircle){var f=this._isFollowing()?this.options.followCircleStyle:this.options.circleStyle;if(!this._circle){this._circle=a.circle(j,c,f).addTo(this._layer)}else{this._circle.setLatLng(j).setRadius(c).setStyle(f)}}var h,g;if(this.options.metric){h=c.toFixed(0);g=this.options.strings.metersUnit}else{h=(c*3.2808399).toFixed(0);g=this.options.strings.feetUnit}if(this.options.drawMarker){var d=this._isFollowing()?this.options.followMarkerStyle:this.options.markerStyle;if(!this._marker){this._marker=new this.options.markerClass(j,d).addTo(this._layer)}else{this._marker.setLatLng(j).setStyle(d)}}var e=this.options.strings.popup;if(this.options.showPopup&&e&&this._marker){this._marker.bindPopup(a.Util.template(e,{distance:h,unit:g}))._popup.setLatLng(j)}},_removeMarker:function(){this._layer.clearLayers();this._marker=undefined;this._circle=undefined},_unload:function(){this.stop();this._map.off("unload",this._unload,this)},_onLocationError:function(c){if(c.code==3&&this.options.locateOptions.watch){return}this.stop();this.options.onLocationError(c,this)},_onLocationFound:function(c){if(this._event&&(this._event.latlng.lat===c.latlng.lat&&this._event.latlng.lng===c.latlng.lng&&this._event.accuracy===c.accuracy)){return}if(!this._active){return}this._event=c;this._drawMarker();this._updateContainerStyle();switch(this.options.setView){case"once":if(this._justClicked){this.setView()}break;case"untilPan":if(!this._userPanned){this.setView()}break;case"always":this.setView();break;case false:break}this._justClicked=false},_onDrag:function(){if(this._event){this._userPanned=true;this._updateContainerStyle();this._drawMarker()}},_isFollowing:function(){if(!this._active){return false}if(this.options.setView==="always"){return true}else{if(this.options.setView==="untilPan"){return !this._userPanned}}},_isOutsideMapBounds:function(){if(this._event===undefined){return false}return this._map.options.maxBounds&&!this._map.options.maxBounds.contains(this._event.latlng)},_updateContainerStyle:function(){if(!this._container){return}if(this._active&&!this._event){this._setClasses("requesting")}else{if(this._isFollowing()){this._setClasses("following")}else{if(this._active){this._setClasses("active")}else{this._cleanClasses()}}}},_setClasses:function(c){if(c=="requesting"){a.DomUtil.removeClasses(this._container,"active following");a.DomUtil.addClasses(this._container,"requesting");a.DomUtil.removeClasses(this._icon,this.options.icon);a.DomUtil.addClasses(this._icon,this.options.iconLoading)}else{if(c=="active"){a.DomUtil.removeClasses(this._container,"requesting following");a.DomUtil.addClasses(this._container,"active");a.DomUtil.removeClasses(this._icon,this.options.iconLoading);a.DomUtil.addClasses(this._icon,this.options.icon)}else{if(c=="following"){a.DomUtil.removeClasses(this._container,"requesting");a.DomUtil.addClasses(this._container,"active following");a.DomUtil.removeClasses(this._icon,this.options.iconLoading);a.DomUtil.addClasses(this._icon,this.options.icon)}}}},_cleanClasses:function(){a.DomUtil.removeClass(this._container,"requesting");a.DomUtil.removeClass(this._container,"active");a.DomUtil.removeClass(this._container,"following");a.DomUtil.removeClasses(this._icon,this.options.iconLoading);a.DomUtil.addClasses(this._icon,this.options.icon)},_resetVariables:function(){this._active=false;this._justClicked=false;this._userPanned=false}});a.control.locate=function(c){return new a.Control.Locate(c)};(function(){var c=function(f,d,e){e=e.split(" ");e.forEach(function(g){a.DomUtil[f].call(this,d,g)})};a.DomUtil.addClasses=function(d,e){c("addClass",d,e)};a.DomUtil.removeClasses=function(d,e){c("removeClass",d,e)}})();return b},window));(function(){L.Control.NavBar=L.Control.extend({options:{position:"topleft",forwardTitle:"Vai avanti",backTitle:"Via indietro",homeTitle:"Vai alla estensione iniziale"},onAdd:function(c){if(!this.options.center){this.options.center=c.getCenter()}if(!this.options.zoom){this.options.zoom=c.getZoom()}options=this.options;var b="leaflet-control-navbar",a=L.DomUtil.create("div",b+" leaflet-bar");this._homeButton=this._createButton(options.homeTitle,"fa fa-home",a,this._goHome);this._fwdButton=this._createButton(options.forwardTitle,"fa fa-caret-right",a,this._goFwd);this._backButton=this._createButton(options.backTitle,"fa fa-caret-left",a,this._goBack);this._viewHistory=[{center:this.options.center,zoom:this.options.zoom}];this._curIndx=0;this._updateDisabled();c.once("moveend",function(){this._map.on("moveend",this._updateHistory,this)},this);c.setView(options.center,options.zoom);return a},onRemove:function(a){a.off("moveend",this._updateHistory,this)},_goHome:function(){if(this.options.bbox){try{this._map.fitBounds(this.options.bbox)}catch(a){this._map.setView(this.options.center,this.options.zoom)}}this._map.setView(this.options.center,this.options.zoom)},_goBack:function(){if(this._curIndx!==0){this._map.off("moveend",this._updateHistory,this);this._map.once("moveend",function(){this._map.on("moveend",this._updateHistory,this)},this);this._curIndx--;this._updateDisabled();var a=this._viewHistory[this._curIndx];this._map.setView(a.center,a.zoom)}},_goFwd:function(){if(this._curIndx!=this._viewHistory.length-1){this._map.off("moveend",this._updateHistory,this);this._map.once("moveend",function(){this._map.on("moveend",this._updateHistory,this)},this);this._curIndx++;this._updateDisabled();var a=this._viewHistory[this._curIndx];this._map.setView(a.center,a.zoom)}},_createButton:function(e,c,a,b){var d=L.DomUtil.create("a",c,a);d.href="#";d.title=e;L.DomEvent.on(d,"mousedown dblclick",L.DomEvent.stopPropagation).on(d,"click",L.DomEvent.stop).on(d,"click",b,this).on(d,"click",this._refocusOnMap,this);return d},_updateHistory:function(){var b={center:this._map.getCenter(),zoom:this._map.getZoom()};var a=this._curIndx+1;this._viewHistory.splice(a,this._viewHistory.length-a,b);this._curIndx++;this._updateDisabled()},_setFwdEnabled:function(b){var a="leaflet-disabled";var c="leaflet-control-navbar-fwd-disabled";if(b===true){L.DomUtil.removeClass(this._fwdButton,c);L.DomUtil.removeClass(this._fwdButton,a)}else{L.DomUtil.addClass(this._fwdButton,c);L.DomUtil.addClass(this._fwdButton,a)}},_setBackEnabled:function(c){var b="leaflet-disabled";var a="leaflet-control-navbar-back-disabled";if(c===true){L.DomUtil.removeClass(this._backButton,a);L.DomUtil.removeClass(this._backButton,b)}else{L.DomUtil.addClass(this._backButton,a);L.DomUtil.addClass(this._backButton,b)}},_updateDisabled:function(){if(this._curIndx==(this._viewHistory.length-1)){this._setFwdEnabled(false)}else{this._setFwdEnabled(true)}if(this._curIndx<=0){this._setBackEnabled(false)}else{this._setBackEnabled(true)}}});L.control.navbar=function(a){return new L.Control.NavBar(a)}})();(function(a){if(typeof define==="function"&&define.amd){define(["leaflet"],a)}else{if(typeof module!=="undefined"){module.exports=a(require("leaflet"))}else{if(typeof window.L==="undefined"){throw"Leaflet must be loaded first"}a(window.L)}}})(function(b){function a(h,k){var g=k.split("."),f=g.pop(),d=g.length,j=g[0],e=1;if(d>0){while((h=h[j])&&e<d){j=g[e++]}}if(h){return h[f]}}function c(d){return Object.prototype.toString.call(d)==="[object Object]"}b.Control.Search=b.Control.extend({includes:b.Mixin.Events,options:{url:"",layer:null,sourceData:null,jsonpParam:null,propertyLoc:"loc",propertyName:"title",formatData:null,filterData:null,moveToLocation:null,buildTip:null,container:"",zoom:null,minLength:1,initial:false,casesensitive:false,autoType:true,delayType:400,tooltipLimit:-1,tipAutoSubmit:true,firstTipSubmit:false,autoResize:true,collapsed:true,autoCollapse:false,autoCollapseTime:1200,textErr:"Non trovato",textCancel:"Cancel",textPlaceholder:"Ricerca...",position:"topleft",hideMarkerOnCollapse:false,marker:{icon:false,animate:true,circle:{radius:10,weight:3,color:"#e70",stroke:true,fillColor:"#e70",fillOpacity:0.4,fill:true}}},initialize:function(d){b.Util.setOptions(this,d||{});this._inputMinSize=this.options.textPlaceholder?this.options.textPlaceholder.length:10;this._layer=this.options.layer||new b.LayerGroup();this._filterData=this.options.filterData||this._defaultFilterData;this._formatData=this.options.formatData||this._defaultFormatData;this._moveToLocation=this.options.moveToLocation||this._defaultMoveToLocation;this._autoTypeTmp=this.options.autoType;this._countertips=0;this._recordsCache={};this._curReq=null},onAdd:function(d){this._map=d;this._container=b.DomUtil.create("div","leaflet-control-search");this._input=this._createInput(this.options.textPlaceholder,"search-input");this._tooltip=this._createTooltip("search-tooltip");this._cancel=this._createCancel(this.options.textCancel,"search-cancel");this._button=this._createButton(this.options.textPlaceholder,"search-button ms ms-zoom");this._alert=this._createAlert("search-alert");if(this.options.collapsed===false){this.expand(this.options.collapsed)}if(this.options.marker){if(this.options.marker instanceof b.Marker||this.options.marker instanceof b.CircleMarker){this._markerSearch=this.options.marker}else{if(c(this.options.marker)){this._markerSearch=new b.Control.Search.Marker([0,0],this.options.marker)}}this._markerSearch._isMarkerSearch=true}this.setLayer(this._layer);d.on({resize:this._handleAutoresize},this);return this._container},addTo:function(d){if(this.options.container){this._container=this.onAdd(d);this._wrapper=b.DomUtil.get(this.options.container);this._wrapper.style.position="relative";this._wrapper.appendChild(this._container)}else{b.Control.prototype.addTo.call(this,d)}return this},onRemove:function(d){this._recordsCache={}},setLayer:function(d){this._layer=d;this._layer.addTo(this._map);return this},showAlert:function(e){e=e||this.options.textErr;this._alert.style.display="block";this._alert.innerHTML=e;clearTimeout(this.timerAlert);var d=this;this.timerAlert=setTimeout(function(){d.hideAlert()},this.options.autoCollapseTime);return this},hideAlert:function(){this._alert.style.display="none";return this},cancel:function(){this._input.value="";this._handleKeypress({keyCode:8});this._input.size=this._inputMinSize;this._input.focus();this._cancel.style.display="none";this._hideTooltip();return this},expand:function(d){d=typeof d==="boolean"?d:true;this._input.style.display="block";b.DomUtil.addClass(this._container,"search-exp");if(d!==false){this._input.focus();this._map.on("dragstart click",this.collapse,this)}this.fire("search:expanded");return this},collapse:function(){this._hideTooltip();this.cancel();this._alert.style.display="none";this._input.blur();if(this.options.collapsed){this._input.style.display="none";this._cancel.style.display="none";b.DomUtil.removeClass(this._container,"search-exp");if(this.options.hideMarkerOnCollapse){this._map.removeLayer(this._markerSearch)}this._map.off("dragstart click",this.collapse,this)}this.fire("search:collapsed");return this},collapseDelayed:function(){if(!this.options.autoCollapse){return this}var d=this;clearTimeout(this.timerCollapse);this.timerCollapse=setTimeout(function(){d.collapse()},this.options.autoCollapseTime);return this},collapseDelayedStop:function(){clearTimeout(this.timerCollapse);return this},_createAlert:function(d){var e=b.DomUtil.create("div",d,this._container);e.style.display="none";b.DomEvent.on(e,"click",b.DomEvent.stop,this).on(e,"click",this.hideAlert,this);return e},_createInput:function(g,f){var e=b.DomUtil.create("label",f,this._container);var d=b.DomUtil.create("input",f,this._container);d.type="text";d.size=this._inputMinSize;d.value="";d.autocomplete="off";d.autocorrect="off";d.autocapitalize="off";d.placeholder=g;d.style.display="none";d.role="search";d.id=d.role+d.type+d.size;e.htmlFor=d.id;e.style.display="none";e.value=g;b.DomEvent.disableClickPropagation(d).on(d,"keydown",this._handleKeypress,this).on(d,"blur",this.collapseDelayed,this).on(d,"focus",this.collapseDelayedStop,this);return d},_createCancel:function(f,d){var e=b.DomUtil.create("a",d,this._container);e.href="#";e.title=f;e.style.display="none";e.innerHTML="<span>&otimes;</span>";b.DomEvent.on(e,"click",b.DomEvent.stop,this).on(e,"click",this.cancel,this);return e},_createButton:function(f,e){var d=b.DomUtil.create("a",e,this._container);d.href="#";d.title=f;b.DomEvent.on(d,"click",b.DomEvent.stop,this).on(d,"click",this._handleSubmit,this).on(d,"focus",this.collapseDelayedStop,this).on(d,"blur",this.collapseDelayed,this);return d},_createTooltip:function(e){var d=b.DomUtil.create("ul",e,this._container);d.style.display="none";var f=this;b.DomEvent.disableClickPropagation(d).on(d,"blur",this.collapseDelayed,this).on(d,"mousewheel",function(g){f.collapseDelayedStop();b.DomEvent.stopPropagation(g)},this).on(d,"mouseover",function(g){f.collapseDelayedStop()},this);return d},_createTip:function(g,f){var e;if(this.options.buildTip){e=this.options.buildTip.call(this,g,f);if(typeof e==="string"){var d=b.DomUtil.create("div");d.innerHTML=e;e=d.firstChild}}else{e=b.DomUtil.create("li","");e.innerHTML=g}b.DomUtil.addClass(e,"search-tip");e._text=g;if(this.options.tipAutoSubmit){b.DomEvent.disableClickPropagation(e).on(e,"click",b.DomEvent.stop,this).on(e,"click",function(h){this._input.value=g;this._handleAutoresize();this._input.focus();this._hideTooltip();this._handleSubmit()},this)}return e},_getUrl:function(d){return(typeof this.options.url==="function")?this.options.url(d):this.options.url},_defaultFilterData:function(k,e){var f,h,d,j={};k=k.replace(/[.*+?^${}()|[\]\\]/g,"");if(k===""){return[]}f=this.options.initial?"^":"";h=!this.options.casesensitive?"i":undefined;d=new RegExp(f+k,h);for(var g in e){if(d.test(g)){j[g]=e[g]}}return j},showTooltip:function(d){var f;this._countertips=0;this._tooltip.innerHTML="";this._tooltip.currentSelection=-1;for(var e in d){if(++this._countertips==this.options.tooltipLimit){break}f=this._createTip(e,d[e]);this._tooltip.appendChild(f)}if(this._countertips>0){this._tooltip.style.display="block";if(this._autoTypeTmp){this._autoType()}this._autoTypeTmp=this.options.autoType}else{this._hideTooltip()}this._tooltip.scrollTop=0;return this._countertips},_hideTooltip:function(){this._tooltip.style.display="none";this._tooltip.innerHTML="";return 0},_defaultFormatData:function(f){var g=this.options.propertyName,d=this.options.propertyLoc,e,h={};if(b.Util.isArray(d)){for(e in f){h[a(f[e],g)]=b.latLng(f[e][d[0]],f[e][d[1]])}}else{for(e in f){h[a(f[e],g)]=b.latLng(a(f[e],d))}}return h},_recordsFromJsonp:function(g,d){b.Control.Search.callJsonp=d;var e=b.DomUtil.create("script","leaflet-search-jsonp",document.getElementsByTagName("body")[0]),f=b.Util.template(this._getUrl(g)+"&"+this.options.jsonpParam+"=L.Control.Search.callJsonp",{s:g});e.type="text/javascript";e.src=f;return{abort:function(){e.parentNode.removeChild(e)}}},_recordsFromAjax:function(j,e){if(window.XMLHttpRequest===undefined){window.XMLHttpRequest=function(){try{return new ActiveXObject("Microsoft.XMLHTTP.6.0")}catch(l){try{return new ActiveXObject("Microsoft.XMLHTTP.3.0")}catch(k){throw new Error("XMLHttpRequest is not supported")}}}}var d=(b.Browser.ie&&!window.atob&&document.querySelector),h=d?new XDomainRequest():new XMLHttpRequest(),f=b.Util.template(this._getUrl(j),{s:j});h.open("GET",f);var g=this;h.onload=function(){e(JSON.parse(h.responseText))};h.onreadystatechange=function(){if(h.readyState===4&&h.status===200){this.onload()}};h.send();return h},_recordsFromLayer:function(){var e=this,d={},f=this.options.propertyName,g;this._layer.eachLayer(function(h){if(h.hasOwnProperty("_isMarkerSearch")){return}if(h instanceof b.Marker||h instanceof b.CircleMarker){try{if(a(h.options,f)){g=h.getLatLng();g.layer=h;d[a(h.options,f)]=g}else{if(a(h.feature.properties,f)){g=h.getLatLng();g.layer=h;d[a(h.feature.properties,f)]=g}else{throw new Error("propertyName '"+f+"' not found in marker")}}}catch(j){if(console){console.warn(j)}}}else{if(h.hasOwnProperty("feature")){try{if(h.feature.properties.hasOwnProperty(f)){g=h.getBounds().getCenter();g.layer=h;d[h.feature.properties[f]]=g}else{throw new Error("propertyName '"+f+"' not found in feature")}}catch(j){if(console){console.warn(j)}}}else{if(h instanceof b.LayerGroup){h.eachLayer(function(k){g=k.getLatLng();g.layer=k;d[k.feature.properties[f]]=g})}}}},this);return d},_autoType:function(){var g=this._input.value.length,f=this._tooltip.firstChild._text,e=f.length;if(f.indexOf(this._input.value)===0){this._input.value=f;this._handleAutoresize();if(this._input.createTextRange){var d=this._input.createTextRange();d.collapse(true);d.moveStart("character",g);d.moveEnd("character",e);d.select()}else{if(this._input.setSelectionRange){this._input.setSelectionRange(g,e)}else{if(this._input.selectionStart){this._input.selectionStart=g;this._input.selectionEnd=e}}}}},_hideAutoType:function(){var e;if((e=this._input.selection)&&e.empty){e.empty()}else{if(this._input.createTextRange){e=this._input.createTextRange();e.collapse(true);var d=this._input.value.length;e.moveStart("character",d);e.moveEnd("character",d);e.select()}else{if(this._input.getSelection){this._input.getSelection().removeAllRanges()}this._input.selectionStart=this._input.selectionEnd}}},_handleKeypress:function(f){switch(f.keyCode){case 27:this.collapse();break;case 13:if(this._countertips==1||(this.options.firstTipSubmit&&this._countertips>0)){this._handleArrowSelect(1)}this._handleSubmit();break;case 38:this._handleArrowSelect(-1);break;case 40:this._handleArrowSelect(1);break;case 8:case 45:case 46:this._autoTypeTmp=false;break;case 37:case 39:case 16:case 17:case 35:case 36:break;default:if(this._input.value.length){this._cancel.style.display="block"}else{this._cancel.style.display="none"}if(this._input.value.length>=this.options.minLength){var d=this;clearTimeout(this.timerKeypress);this.timerKeypress=setTimeout(function(){d._fillRecordsCache()},this.options.delayType)}else{this._hideTooltip()}}this._handleAutoresize()},searchText:function(e){var d=e.charCodeAt(e.length);this._input.value=e;this._input.style.display="block";b.DomUtil.addClass(this._container,"search-exp");this._autoTypeTmp=false;this._handleKeypress({keyCode:d})},_fillRecordsCache:function(){var f=this._input.value,e=this,d;if(this._curReq&&this._curReq.abort){this._curReq.abort()}b.DomUtil.addClass(this._container,"search-load");if(this.options.layer){this._recordsCache=this._recordsFromLayer();d=this._filterData(this._input.value,this._recordsCache);this.showTooltip(d);b.DomUtil.removeClass(this._container,"search-load")}else{if(this.options.sourceData){this._retrieveData=this.options.sourceData}else{if(this.options.url){this._retrieveData=this.options.jsonpParam?this._recordsFromJsonp:this._recordsFromAjax}}this._curReq=this._retrieveData.call(this,f,function(g){e._recordsCache=e._formatData(g);if(e.options.sourceData){d=e._filterData(e._input.value,e._recordsCache)}else{d=e._recordsCache}e.showTooltip(d);b.DomUtil.removeClass(e._container,"search-load")})}},_handleAutoresize:function(){if(this._input.style.maxWidth!=this._map._container.offsetWidth){this._input.style.maxWidth=b.DomUtil.getStyle(this._map._container,"width")}if(this.options.autoResize&&(this._container.offsetWidth+45<this._map._container.offsetWidth)){this._input.size=this._input.value.length<this._inputMinSize?this._inputMinSize:this._input.value.length}},_handleArrowSelect:function(d){var f=this._tooltip.hasChildNodes()?this._tooltip.childNodes:[];for(i=0;i<f.length;i++){b.DomUtil.removeClass(f[i],"search-tip-select")}if((d==1)&&(this._tooltip.currentSelection>=(f.length-1))){b.DomUtil.addClass(f[this._tooltip.currentSelection],"search-tip-select")}else{if((d==-1)&&(this._tooltip.currentSelection<=0)){this._tooltip.currentSelection=-1}else{if(this._tooltip.style.display!="none"){this._tooltip.currentSelection+=d;b.DomUtil.addClass(f[this._tooltip.currentSelection],"search-tip-select");this._input.value=f[this._tooltip.currentSelection]._text;var e=f[this._tooltip.currentSelection].offsetTop;if(e+f[this._tooltip.currentSelection].clientHeight>=this._tooltip.scrollTop+this._tooltip.clientHeight){this._tooltip.scrollTop=e-this._tooltip.clientHeight+f[this._tooltip.currentSelection].clientHeight}else{if(e<=this._tooltip.scrollTop){this._tooltip.scrollTop=e}}}}}},_handleSubmit:function(){this._hideAutoType();this.hideAlert();this._hideTooltip();if(this._input.style.display=="none"){this.expand()}else{if(this._input.value===""){this.collapse()}else{var d=this._getLocation(this._input.value);if(d===false){this.showAlert()}else{this.showLocation(d,this._input.value);this.fire("search:locationfound",{latlng:d,text:this._input.value,layer:d.layer?d.layer:null})}}}},_getLocation:function(d){if(this._recordsCache.hasOwnProperty(d)){return this._recordsCache[d]}else{return false}},_defaultMoveToLocation:function(f,e,d){if(this.options.zoom){this._map.setView(f,this.options.zoom)}else{this._map.panTo(f)}},showLocation:function(f,e){var d=this;d._map.once("moveend zoomend",function(g){if(d._markerSearch){d._markerSearch.addTo(d._map).setLatLng(f)}});d._moveToLocation(f,e,d._map);if(d.options.autoCollapse){d.collapse()}return d}});b.Control.Search.Marker=b.Marker.extend({includes:b.Mixin.Events,options:{icon:new b.Icon.Default(),animate:true,circle:{radius:10,weight:3,color:"#e03",stroke:true,fill:false}},initialize:function(e,d){b.setOptions(this,d);if(d.icon===true){d.icon=new b.Icon.Default()}b.Marker.prototype.initialize.call(this,e,d);if(c(this.options.circle)){this._circleLoc=new b.CircleMarker(e,this.options.circle)}},onAdd:function(d){b.Marker.prototype.onAdd.call(this,d);if(this._circleLoc){d.addLayer(this._circleLoc);if(this.options.animate){this.animate()}}},onRemove:function(d){b.Marker.prototype.onRemove.call(this,d);if(this._circleLoc){d.removeLayer(this._circleLoc)}},setLatLng:function(d){b.Marker.prototype.setLatLng.call(this,d);if(this._circleLoc){this._circleLoc.setLatLng(d)}return this},_initIcon:function(){if(this.options.icon){b.Marker.prototype._initIcon.call(this)}},_removeIcon:function(){if(this.options.icon){b.Marker.prototype._removeIcon.call(this)}},animate:function(){if(this._circleLoc){var j=this._circleLoc,d=200,f=5,e=parseInt(j._radius/f),h=this.options.circle.radius,k=j._radius*2,g=0;j._timerAnimLoc=setInterval(function(){g+=0.5;e+=g;k-=e;j.setRadius(k);if(k<h){clearInterval(j._timerAnimLoc);j.setRadius(h)}},d)}return this}});b.Map.addInitHook(function(){if(this.options.searchControl){this.searchControl=b.control.search(this.options.searchControl);this.addControl(this.searchControl)}});b.control.search=function(d){return new b.Control.Search(d)};return b.Control.Search});GV.infoWmsManager=(function(){var d=0,g=0,e=[];function c(j){GV.Util.log("start info request: "+new Date());d=0;g=0;e=[];var h=function(l,p,m){var q=GV.map.latLngToContainerPoint(m,GV.map.getZoom()),s=GV.map.getSize(),k=GV.map.getBounds(),r=GV.map.options.crs.project(k.getSouthWest()),o=GV.map.options.crs.project(k.getNorthEast());var n={request:"GetFeatureInfo",service:"WMS",crs:"EPSG:3857",styles:"",version:"1.1.0",format:"application/json",bbox:r.x+","+r.y+","+o.x+","+o.y,height:s.y,width:s.x,layers:p,query_layers:p,FEATURE_COUNT:100,buffer:10,info_format:"application/json"};_.extend(n,{});n[n.version==="1.3.0"?"i":"x"]=q.x;n[n.version==="1.3.0"?"j":"y"]=q.y;return GV.config.application.proxy+l+GV.Util.getParamString(n,l,true)};_.each(GV.config.maps,function(o){var k=null,m=[];_.each(o.layers,function(p){if(p.idMap===o.id&&p.type==="WMS"&&p.queryable&&p.visible&&GV.map.layerInRange(p)){k=p.wmsParams.url;m.push(p.wmsParams.name)}});var n=m.join(",");if(k&&m.length>0){var l=h(k,n,j.latlng);g++;GV.map._container.style.cursor="progress";$.ajax({url:l,dataType:"json"}).done(function(p){b(p.features)})}})}function b(l){d++;_.each(l,function(o){var n=o.id.split(".")[0];o.layerName=n;o.layer=GV.map.getLayerByName(n);o.label=m(n,o.properties);o.infoOptions=o.layer.config.infoOptions});Array.prototype.push.apply(e,l);if(d===g){GV.map._container.style.cursor="default";if(e.length===0){GV.Util.log("Nessun elemento trovata");return}var k=new Vue({template:'<gv-wms-info-list v-draggable :cls="cls" visible="true" :items="items"></gv-wms-info-list>',data:{items:e,cls:"gv-info-wms"},created:function(){$("#gv-container").append("<div id='gv-info-wms-list'></div>")}});k.$mount("#gv-info-wms-list");if(e.length===1){f(e[0])}GV.Util.log("end info request: "+new Date())}function m(p,n){var o,q;o=j(p,"infoLabelAttr");q=j(p,"infoIdAttr");if(o&&n[o]){return n[o]}if(q&&n[q]){return n[q]}return n[h(n)]}function j(o,q){try{var n=GV.map.getLayerByName(o).config;if(n&&n.infoOptions&&n.infoOptions[q]){return n.infoOptions[q]}else{return null}}catch(p){GV.Util.log(p,2);return null}}function h(n){for(var o in n){if(n.hasOwnProperty(o)&&typeof(o)!=="function"){return o}}return null}}function f(n){var o=n.infoOptions,m=o.infoUrl;if((m.substr(m.length-4)===".xsl")||(m.substr(m.length-5)===".xslt")){k(o,n)}else{if(!o.infoTarget||o.infoTarget==="panel"){p(m,null,o)}else{h(m,null,o)}}function k(v,u){var t=r(u);var s={url:"/geoservices/REST/config/xsl_info_service?",data:{xslUrl:v.infoUrl,ambiente:null,idLayer:u.layerName.replace("L",""),featureAttributes:u.properties}};GV.Util.getXML(s,function(x){$(x).find("td").each(function(){if(this.id==="Titolo"){this.textContent=u.layer.legend.label;this.text=u.layer.legend.label}});var w=q(t,x);w=w.replace(new RegExp("%0A","g"),"").replace(new RegExp("%09","g"),"").replace(new RegExp("%20","g"),"");if(!v.infoTarget||v.infoTarget==="panel"){p(w,null,v)}else{h(w,null,v)}});function r(H){try{var G='<?xml version="1.0" encoding="ISO-8859-1"?><msGMLOutput xmlns:gml="http://www.opengis.net/gml" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"></msGMLOutput>',F=GV.Util.parseXML(G),z=H.layerName+"_layer",A=F.createElement(z),E=H.layerName+"_feature",w=F.createElement(E),y=H.properties;for(var C in y){if(y.hasOwnProperty(C)){var D=null;if(y[C]){D=F.createTextNode(y[C])}else{D=F.createTextNode("")}var B=F.createElement(C);B.appendChild(D);w.appendChild(B)}}A.appendChild(w);F.documentElement.appendChild(A);return F}catch(x){GV.Util.log(x,2)}}function q(z,A){try{if(window.XSLTProcessor){var w=new XSLTProcessor();w.importStylesheet(A);var y=w.transformToDocument(z);return(new XMLSerializer()).serializeToString(y)}else{return z.transformNode(A)}}catch(x){GV.Util.log(x,2)}}}function j(s,r){var u=r.infoWidth||400,q=r.infoHeight||300;var t=new Vue({template:'<gv-iframe-panel v-draggable visible="true" :src="src" :html="html" :height="height" :width="width" :cls="cls" :title="title"></gv-iframe-panel>',data:{title:"Risultato Info",src:null,html:s,width:u,height:q,cls:"gv-info-wms-html"},created:function(){$("#gv-container").append("<div id='gv-info-wms-html'></div>")}});t.$mount("#gv-info-wms-html")}function p(s,r,q){if(s){j(s,q)}else{}}function h(u,t,s){var v=s.infoWidth||400,q=s.infoHeight||500,r=window.open(t,null,"status=yes, toolbar=yes, menubar=no, width="+v+", height="+q+", resizable=yes, scrollbars=yes");r.document.open();r.document.write(u);r.document.close();r.focus()}var l=a(n);$.ajax({url:l,dataType:"json"}).done(function(q){var r=GV.map.getLayerByName("InfoWmsHilite");if(q.features&&q.features[0]&&q.features[0].geometry){r.clearLayers();r.addData(q.features[0].geometry);GV.map.fitBounds(r.getBounds(),{maxZoom:15});$(".leaflet-interactive").css({cursor:"default"})}})}function a(h){var j="M"+h.layer.config.idMap;var l=h.layer.config.wfsParams.url.replace("/"+j,"");var m=h.layer.config.infoOptions.infoIdAttr;var k=GV.globals.DEFAULT_PROXY;k+=l+"service=WFS&version=2.0.0&request=GetFeature&srsName=EPSG%3A4326&outputFormat=application%2Fjson";k+="&typeName="+j+":"+h.layer.config.wfsParams.typeName+"&cql_filter="+m+"="+h.properties[m]+"";return k}return{activate:function(){GV.Util.log("GV.app.infoWmsManager.activate");GV.map.loadLayers([{name:"InfoWmsHilite",type:"JSON",style:{color:"#ffcc00",fillOpacity:0,weight:6,opacity:0.6},pointToLayer:function(h,j){return L.circleMarker(j,{radius:8,color:"#ffcc00",fillColor:"#ffcc00",fill:true,fillOpacity:0.6,weight:6,opacity:0.6})},visible:true}]);GV.map.on("click",c)},deactivate:function(){GV.map.off("click")},showFeatureInfo:f}}());GV.init=function(a){return new GV.App(a)};GV.layerFactory=(function(){var a='<a href="http://www.esri.com/">Esri</a>';return{createPane:function(c,f,d){var b=d.getPane("tilePane");var e=d.createPane(c,b);e.style.zIndex=f;return e},create:function(b,d){if(this[b.type]){var c=this[b.type](b,d);c.legend=b.legend;c.config=b;return c}else{GV.Util.log("Layer di tipo "+b.type+" non gestito",2);return null}},BLANK:function(b,c){b.legend={label:"Sfondo Bianco"};return L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{opacity:0})},OSM:function(b,c){b.legend={label:"OpenStreetMap"};return L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'})},STAMEN_TERRAIN:function(b,c){b.legend={label:"Stamen Terrain"};return L.tileLayer("http://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.{ext}",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:"abcd",minZoom:0,maxZoom:18,ext:"png"})},STAMEN_TONER_LIGHT:function(b,c){b.legend={label:"Stamen Toner Light"};return L.tileLayer("http://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.{ext}",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:"abcd",minZoom:0,maxZoom:20,ext:"png"})},CARTODB_POSITRON:function(b,c){b.legend={label:"CartoDb Positron"};return L.tileLayer("http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',subdomains:"abcd",maxZoom:19})},CARTODB_DARKMATTER:function(b,c){b.legend={label:"CartoDb DarkMatter"};return L.tileLayer("http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',subdomains:"abcd",maxZoom:19})},OPENMAPSURFER_ROADS:function(b,c){b.legend={label:"OpenMapSurfer Roads"};return L.tileLayer("http://korona.geog.uni-heidelberg.de/tiles/roads/x={x}&y={y}&z={z}",{maxZoom:20,attribution:'Imagery from <a href="http://giscience.uni-hd.de/">GIScience Research Group @ University of Heidelberg</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'})},MAPBOX_STREETS:function(b,c){b.legend={label:"Mapbox Streets"};return L.tileLayer("http://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoic3RlZmFub3Bhcm9kaSIsImEiOiJjaXRma2VzeWgwMGVmMnh0bzJzMmVjcGVtIn0.2lTBdEwBI6_2QBzboizE5g",{attribution:'Imagery from <a href="http://mapbox.com/about/maps/">MapBox</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:"abcd",id:"mapbox.streets",accessToken:"pk.eyJ1Ijoic3RlZmFub3Bhcm9kaSIsImEiOiJjaXRma2VzeWgwMGVmMnh0bzJzMmVjcGVtIn0.2lTBdEwBI6_2QBzboizE5g"})},MAPBOX_SATELLITE:function(b,c){b.legend={label:"Mapbox Satellite"};return L.tileLayer("http://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoic3RlZmFub3Bhcm9kaSIsImEiOiJjaXRma2VzeWgwMGVmMnh0bzJzMmVjcGVtIn0.2lTBdEwBI6_2QBzboizE5g",{attribution:'Imagery from <a href="http://mapbox.com/about/maps/">MapBox</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:"abcd",id:"mapbox.satellite",accessToken:"pk.eyJ1Ijoic3RlZmFub3Bhcm9kaSIsImEiOiJjaXRma2VzeWgwMGVmMnh0bzJzMmVjcGVtIn0.2lTBdEwBI6_2QBzboizE5g"})},MAPBOX_OUTDOOR:function(b,c){b.legend={label:"Mapox Outdoor"};return L.tileLayer("http://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoic3RlZmFub3Bhcm9kaSIsImEiOiJjaXRma2VzeWgwMGVmMnh0bzJzMmVjcGVtIn0.2lTBdEwBI6_2QBzboizE5g",{attribution:'Imagery from <a href="http://mapbox.com/about/maps/">MapBox</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:"abcd",id:"mapbox.outdoors",accessToken:"pk.eyJ1Ijoic3RlZmFub3Bhcm9kaSIsImEiOiJjaXRma2VzeWgwMGVmMnh0bzJzMmVjcGVtIn0.2lTBdEwBI6_2QBzboizE5g"})},MAPBOX_LIGHT:function(b,c){b.legend={label:"Mapox Light"};return L.tileLayer("http://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoic3RlZmFub3Bhcm9kaSIsImEiOiJjaXRma2VzeWgwMGVmMnh0bzJzMmVjcGVtIn0.2lTBdEwBI6_2QBzboizE5g",{attribution:'Imagery from <a href="http://mapbox.com/about/maps/">MapBox</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:"abcd",id:"mapbox.light",accessToken:"pk.eyJ1Ijoic3RlZmFub3Bhcm9kaSIsImEiOiJjaXRma2VzeWgwMGVmMnh0bzJzMmVjcGVtIn0.2lTBdEwBI6_2QBzboizE5g"})},HYDDA:function(b,c){b.legend={label:"Hydda"};return L.tileLayer("http://{s}.tile.openstreetmap.se/hydda/full/{z}/{x}/{y}.png",{attribution:'Tiles courtesy of <a href="http://openstreetmap.se/" target="_blank">OpenStreetMap Sweden</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'})},ESRI_IMAGERY:function(c,d){c.legend={label:"ESRI Imagery"};c.name=c.type;var b="DigitalGlobe, GeoEye, i-cubed, USDA, USGS, AEX, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community";return L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; "+a+", "+b,maxZoom:19})},ESRI_STREETS:function(c,d){c.legend={label:"ESRI Streets"};c.name=c.type;var b="USGS, NOAA";return L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; "+a+", "+b,maxZoom:19})},ESRI_TOPOGRAPHIC:function(c,d){c.legend={label:"ESRI Topographic"};c.name=c.type;var b="USGS, NOAA";return L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; "+a+", "+b,maxZoom:19})},ESRI_GRAY:function(c,d){c.legend={label:"ESRI Gray"};c.name=c.type;var b="HERE, DeLorme, MapmyIndia, OpenStreetMap contributors";return L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; "+a+", "+b,maxZoom:16})},ESRI_DARKGRAY:function(c,d){c.legend={label:"ESRI Dark Gray"};c.name=c.type;var b="HERE, DeLorme, MapmyIndia, OpenStreetMap contributors";return L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; "+a+", "+b,maxZoom:16})},WMS:function(k,c){GV.Util.log("GV.layerFactory - Creazione Layer WMS: "+k.name);var j=(k.geomType==="VECTOR")?"image/png8":(k.cacheMinZoomLevel)?"image/jpeg":"image/png",b=(k.minScale)?GV.Util.getZoomFromScaleDenom(k.minScale):8,h=(k.maxScale)?GV.Util.getZoomFromScaleDenom(k.maxScale):20,d=k.wmsParams.url,e=k.name,g=k.opacity||1;if(!k.flagGeoserver){k.cacheMinZoomLevel=null;j=(k.geomType==="VECTOR")?"image/png":"image/jpeg"}var l={transparent:true,FORMAT_OPTIONS:"antialias:text",layers:e,format:j,opacity:g,minZoom:b,maxZoom:h,bounds:GV.globals.MAX_BOUNDS};var f;if(k.cacheMinZoomLevel){_.extend(l,{tiled:true,TILESORIGIN:"-20037508,-20037508",tileSize:256});f=L.tileLayer.wms(d,l)}else{_.extend(l,{tiled:false,pane:"tilePane"});f=L.nonTiledLayer.wms(d,l)}f.setZIndex(k.zIndex);f.type="WMS";f.name=e;return f},JSON:function(d,q){var s=d.data,h=d.url,t=d.name,c=d.wfsParams,o=d.esParams,p=d.classes,n=d.style,f=d.pointToLayer,g=d.tooltip,b=d.popup,l=d.dataType||"jsonp",m=d.cluster,k=null;var e={};if(p&&p.length>0){if(d.geomSubType==="POINT"){e.pointToLayer=function(u,x){var w;_.each(p,function(y){if(y.filter&&y.filter.key&&y.filter.value){if(u.properties[y.filter.key]===y.filter.value){w=y.style}}else{w=y.style}});if(w.iconUrl){var v;switch(w.iconUrl){case"default":v=L.icon({iconUrl:"http://geoportale.regione.liguria.it/geoviewer2/images/legend/marker-icon.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[0,-41]});break;case"default-small":v=L.icon({iconUrl:"http://geoportale.regione.liguria.it/geoviewer2/images/legend/marker-icon.png",iconSize:[12,20],iconAnchor:[6,10],popupAnchor:[0,-20]});break;default:v=L.icon({iconUrl:w.iconUrl,iconSize:w.iconSize,iconAnchor:w.iconAnchor,popupAnchor:w.popupAnchor})}return L.marker(x,{icon:v})}else{return L.circleMarker(x,w)}}}else{e.style=function(u){var v;_.each(p,function(w){if(w.filter&&w.filter.key&&w.filter.value){if(u.properties[w.filter.key]===w.filter.value){v=w.style}}else{v=w.style}});return v}}e.filter=function(v,u){var w=false;_.each(p,function(x){if(!x.filter){w=true}else{if(x.filter.key&&x.filter.value){if(v.properties[x.filter.key]==x.filter.value){w=true}}}});return w}}if(n){e.style=n}if(f){e.pointToLayer=f}if(g||b){e.onEachFeature=function(v,u){if(g){u.options.title=GV.Util.template(g,v.properties)}if(b){u.bindPopup(GV.Util.template(b,v.properties))}}}var r=L.geoJson(s,e);r.name=t;r.setFilter=function(u){r.filter=u;if(u){r.eachLayer(function(v){var w=0;_.each(u,function(x){if(v.feature.properties[x.key]==x.value){w=r.config.opacity||1}});v.setOpacity(w)})}else{r.eachLayer(function(v){var w=r.config.opacity||1;v.setOpacity(w)})}};if(c&&c.typeName&&c.url){var j={service:"WFS",version:"2.0.0",request:"GetFeature",srsName:"EPSG:4326",outputFormat:"text/javascript",format_options:"callback: getJson",typeName:c.typeName};h=c.url+GV.Util.getParamString(j);l="jsonp"}if(o){var j={};if(o.field){j.q=o.field+":";if(o.query){j.q+=o.query}else{j.q+="*"}}else{if(o.query){j.q=o.query}}j.pretty="true";j.size=100000;h=GV.config.application.proxy+o.url+GV.Util.getParamString(j);l="json"}if(h){$.ajax({url:h,dataType:l,jsonpCallback:"getJson",success:function(x){var u=x;if(o){var v=o.geomField||"location";var w=x.hits.hits;u={type:"FeatureCollection",totalFeatures:x.hits.total,features:[],crs:{type:"name",properties:{name:"urn:ogc:def:crs:EPSG::4326"}}};_.each(w,function(y){var z=y._source[v];u.features.push({type:"Feature",id:y._id,geometry:{type:"Point",coordinates:z},geometry_name:"GEOMETRY",properties:y._source})})}r.addData(u);if(m){k.addLayer(r)}}})}if(m){var e={showCoverageOnHover:false};if(m.options){_.extend(e,m.options)}k=L.markerClusterGroup(e);return k}return r}}}());