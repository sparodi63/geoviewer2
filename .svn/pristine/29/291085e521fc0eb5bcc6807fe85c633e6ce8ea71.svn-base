/**
 * Created by parodi on 02/08/2016.
 */



GV.App = Marionette.Application.extend({

    initialize: function (options) {
        'use strict';
        var self = this;

        // Creo variabile globale GV.app
        GV.app = this;


        GV.debug = options.debug;
        this.proxy = options.proxy || GV.Globals.DEFAULT_PROXY;

        GV.Util.log('GV.App.initialize');
        GV.Util.log(options);

        if (!options) {
            GV.debug = true;
            GV.Util.log('GV.App: Mancano opzioni di configurazione', 2);
            return;
        }

        //GV.Util.setUnderscoreTemplate();

        // inizializzo collection rlMaps
        GV.rlMaps = new GV.Models.RlMaps();

        // inizializzo layerFactory
        GV.layerFactory = new GV.LayerFactory();

        //istanzio Layout Base
        this.layout = new GV.Views.Layout(options);
        this.map = this.layout.map;
        this.layout.render(options);

        // Gestione caricamento mappe/livelli da configurazione (options.config.maps)
        if (options.config && options.config.maps && options.config.maps.length > 0) {
            _.each(options.config.maps, function (mapConfig) {
                GV.rlMaps.add(new GV.Models.RlMap(mapConfig));
            });
        }

        // Gestione caricamento mappe RL da servizio
        if (options.idMap) {
            this.addRlMap(options.idMap, options);
        } else {
            if (options && options.callback) {
                options.callback(self);
            }
        }

        // avvio automatico applicazione
        this.start(options);
    },

    addRlMap: function (idMap, options) {
        'use strict';
        var self = this;
        $.ajax({
            url: GV.Globals.RL_MAP_CONFIG_SERVICE + idMap,
            dataType: 'jsonp'
        }).done(function (response) {
            var mapConfig = response.data;
            GV.rlMaps.add(new GV.Models.RlMap(mapConfig));
            if (options && options.callback) {
                options.callback(self);
            }
            //gestione extent
            if (mapConfig.extent_3857) {
                self.map.setInitialExtent(mapConfig.extent_3857);
            }
            //gestione titolo
            //TODO non su schermi piccoli
            if (options.setMapTitle) {
                $('#gv-container').append("<div id='gv-title'>" + mapConfig.name + "</div>");
            }
            //TODO: gestione find
        });
    }

});

/*
// funzione factory crea una variabile GV.app per accedere alla applicazione
GV.app = function (options) {
    'use strict';
    this.app = new GV.App(options);
    return this.app;
};
*/
