var GV=GV||{};GV.Models={};GV.Buttons={};GV.Views={};GV.Util=function(){return{getUrlParam:function(b){var a=new RegExp("[\\?&]"+b+"=([^&#]*)").exec(window.location.href);GV.Util.log("GV.Util.getUrlParam");return a?decodeURIComponent(a[1]):null},getUrlParamFromString:function(a,c){var b=new RegExp("[\\?&]"+c+"=([^&#]*)").exec(a);if(!b){return 0}return b[1]||0},log:function(a,d){var b="log";if(!GV.debug){return}switch(d){case 0:b="warn";break;case 1:case 2:b="error";break;default:b="info";break}try{console[b](a)}catch(c){}},msgBox:function(a){window.alert(a)},setUnderscoreTemplate:function(){if(_){_.templateSettings={interpolate:/\{\{(.+?)\}\}/g}}},ajax:function(b,c){var a={jsonpCallback:"getJson",type:"GET"};GV.Util.log("GV.Util.ajax");$.ajax(_.extend(a,b)).done(function(e){try{if(c){c(e)}}catch(d){console.error(d.message)}}).fail(function(d,f,e){if(d.statusText!=="OK"){console.error("GV.Util.ajax - Non sono riuscito a caricare la url:\n"+url+"\nErrore: "+d.status+" - "+f+" - "+e)}})},parseXML:function(c){GV.Util.log("GV.Util.parseXML");try{var b=null;if(window.DOMParser&&window.XSLTProcessor){var d=new DOMParser();b=d.parseFromString(c,"text/xml")}else{b=new ActiveXObject("Msxml2.DOMDocument.3.0");b.async=false;b.loadXML(c)}return b}catch(a){throw {name:"xmlTransformation",message:"GV.Util.parseXml: errore parsing xml - "+a.message,level:1}}},isPointInLig:function(b,f){GV.Util.log("GV.Util.isPointInLig");if(!b||!f){return false}var a=7.4,e=43.7,d=10.1,c=44.8;return(b>a)&&(b<d)&&(f>e)&&(f<c)},toArray:function(a){return Array.prototype.slice.call(a)},bind:function(b,a){return function(){return a.apply(b,GV.Util.toArray(arguments))}},getArrayElementByAttribute:function(e,c,d){if(!e){return null}var b,a=e.length;for(b=0;b<a;b++){if(e[b][c]===d){return e[b]}}return null},geoCode:function(a,b,d){var c=new google.maps.Geocoder();c.geocode({address:a},function(h,f){if(f===google.maps.GeocoderStatus.OK){var e=h[0].geometry.location.lng();var j=h[0].geometry.location.lat();var g={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Point",coordinates:[e,j]},properties:{address:a}}]};if(b){for(var i in b){if(b.hasOwnProperty(i)){g.features[0].properties[i]=b[i]}}}d(g)}else{if(f===google.maps.GeocoderStatus.ZERO_RESULTS){GV.Util.msgBox("Indirizzo '"+a+"' non trovato")}else{console.error("Errore di geocoding: "+f)}}})},getParamString:function(d,a,b){var e=[];for(var c in d){e.push(encodeURIComponent(b?c.toUpperCase():c)+"="+encodeURIComponent(d[c]))}return((!a||a.indexOf("?")===-1)?"?":"&")+e.join("&")},template:function(b,a){var c=/\{ *([\w_\-]+) *\}/g;return b.replace(c,function(f,d){var e=a[d];if(e===undefined){throw new Error("No value provided for variable "+f)}else{if(typeof e==="function"){e=e(a)}}return e})},getZoomFromScaleDenom:function(a){return _.findIndex(GV.Globals.BASE_SCALES,function(b){return a>b})},getScaleLabelsFromZoom:function(a){return GV.Globals.BASE_SCALE_LABELS[a]},getScaleFromZoom:function(a){return GV.Globals.BASE_SCALES[a]}}}();GV.App=Marionette.Application.extend({initialize:function(b){var a=this;GV.app=this;GV.debug=b.debug;this.proxy=b.proxy||GV.Globals.DEFAULT_PROXY;GV.Util.log("GV.App.initialize");GV.Util.log(b);if(!b){GV.debug=true;GV.Util.log("GV.App: Mancano opzioni di configurazione",2);return}GV.rlMaps=new GV.Models.RlMaps();GV.layerFactory=new GV.LayerFactory();this.layout=new GV.Views.Layout(b);this.map=this.layout.map;this.layout.render(b);if(b.config&&b.config.maps&&b.config.maps.length>0){_.each(b.config.maps,function(c){GV.rlMaps.add(new GV.Models.RlMap(c))})}if(b.idMap){this.addRlMap(b.idMap,b)}else{if(b&&b.callback){b.callback(a)}}this.start(b)},addRlMap:function(c,b){var a=this;$.ajax({url:GV.Globals.RL_MAP_CONFIG_SERVICE+c,dataType:"jsonp"}).done(function(d){var e=d.data;GV.rlMaps.add(new GV.Models.RlMap(e));if(b&&b.callback){b.callback(a)}if(e.extent_3857){a.map.setInitialExtent(e.extent_3857)}if(b.setMapTitle){$("#gv-container").append("<div id='gv-title'>"+e.name+"</div>")}})}});var GV=GV||{};GV.Models={};GV.Buttons={};GV.Views={};GV.Globals={DEFAULT_PROXY:"/geoservices/proxy/proxy.jsp?url=",RL_MAP_CONFIG_SERVICE:"http://geoportale.regione.liguria.it/geoservices/REST/config/map/",RL_CREATE_SLD_SERVICE:"http://geoportale.regione.liguria.it/geoservices/REST/config/create_sld/",RL_METADATA_URL:"/geoservices/REST/metadata/scheda_xml/",INFO_WMS_MAX_FEATURES:10,BASE_SCALES:[591657550.5,295828775.3,147914387.6,73957193.82,36978596.91,18489298.45,9244649.227,4622324.614,2311162.307,1155581.153,577790.5767,288895.2884,144447.6442,72223.82209,36111.91104,18055.95552,9027.977761,4513.98888,2256.99444,1128.49722],BASE_SCALE_LABELS:{8:"1:1.600.000",9:"1:800.000",10:"1:400.000",11:"1:200.000",12:"1:100.000",13:"1:50.000",14:"1:25.000",15:"1:12.500",16:"1:6.250",17:"1:3.125",18:"1:1.560",19:"1:800",20:"1:400"}};GV.InfoWmsManager=function(){return{_requestCount:0,_numRequests:0,_features:[],activate:function(a){GV.Util.log("GV.infoWmsManager.activate");this.map=a;a.on("click",GV.infoWmsManager.request)},buildWMSOptions:function(b,f,c){var g=GV.app.map.latLngToContainerPoint(c,GV.app.map.getZoom()),i=GV.app.map.getSize(),a=GV.app.map.getBounds(),h=GV.app.map.options.crs.project(a.getSouthWest()),e=GV.app.map.options.crs.project(a.getNorthEast());var d={request:"GetFeatureInfo",service:"WMS",crs:"EPSG:3857",styles:"",version:"1.1.0",format:"application/json",bbox:h.x+","+h.y+","+e.x+","+e.y,height:i.y,width:i.x,layers:f,query_layers:f,FEATURE_COUNT:100,buffer:10,info_format:"application/json"};_.extend(d,{});d[d.version==="1.3.0"?"i":"x"]=g.x;d[d.version==="1.3.0"?"j":"y"]=g.y;return GV.app.proxy+b+GV.Util.getParamString(d,b,true)},handleResponse:function(a){GV.infoWmsManager._requestCount++;_.each(a,function(b){b.layer=b.id.split(".")[0]});Array.prototype.push.apply(GV.infoWmsManager._features,a);if(GV.infoWmsManager._requestCount===GV.infoWmsManager._numRequests){this.map._container.style.cursor="default";console.log(GV.infoWmsManager._features)}},showWaiting:function(){if(!this.map){return}this.map._container.style.cursor="progress"},request:function(b){GV.infoWmsManager._requestCount=0;GV.infoWmsManager._numRequests=0;GV.infoWmsManager._features=[];var a=GV.rlMaps.toJSON();_.each(a,function(c){var d=null,f=[];_.each(c.layers,function(h){if(h.idMap===c.id&&h.type==="WMS"&&h.queryable&&h.visible&&GV.app.map.layerInRange(h)){d=h.wmsParams.url;f.push(h.wmsParams.name)}});var g=f.join(",");if(d&&f.length>0){var e=GV.infoWmsManager.buildWMSOptions(d,g,b.latlng);GV.infoWmsManager._numRequests++;this._container.style.cursor="progress";$.ajax({url:e,dataType:"json"}).done(function(h){GV.infoWmsManager.handleResponse(h.features)})}},this)}}};GV.LayerFactory=function(){var a='<a href="http://www.esri.com/">Esri</a>';return{lastZIndex:11,createPane:function(c,f,d){var b=d.getPane("tilePane");var e=d.createPane(c,b);e.style.zIndex=f;return e},create:function(b,d){if(this[b.type]){var c=this[b.type](b,d);c.legend=b.legend;c.config=b;return c}else{console.log("Layer di tipo "+b.type+" non gestito");return null}},BLANK:function(b,c){b.legend={label:"Sfondo Bianco"};return L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{opacity:0})},OSM:function(b,c){b.legend={label:"OpenStreetMap"};return L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'})},STAMEN_TERRAIN:function(b,c){b.legend={label:"Stamen Terrain"};return L.tileLayer("http://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.{ext}",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:"abcd",minZoom:0,maxZoom:18,ext:"png"})},STAMEN_TONER_LIGHT:function(b,c){b.legend={label:"Stamen Toner Light"};return L.tileLayer("http://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.{ext}",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:"abcd",minZoom:0,maxZoom:20,ext:"png"})},CARTODB_POSITRON:function(b,c){b.legend={label:"CartoDb Positron"};return L.tileLayer("http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',subdomains:"abcd",maxZoom:19})},CARTODB_DARKMATTER:function(b,c){b.legend={label:"CartoDb DarkMatter"};return L.tileLayer("http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',subdomains:"abcd",maxZoom:19})},OPENMAPSURFER_ROADS:function(b,c){b.legend={label:"OpenMapSurfer Roads"};return L.tileLayer("http://korona.geog.uni-heidelberg.de/tiles/roads/x={x}&y={y}&z={z}",{maxZoom:20,attribution:'Imagery from <a href="http://giscience.uni-hd.de/">GIScience Research Group @ University of Heidelberg</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'})},MAPBOX_STREETS:function(b,c){b.legend={label:"Mapbox Streets"};return L.tileLayer("http://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoic3RlZmFub3Bhcm9kaSIsImEiOiJjaXRma2VzeWgwMGVmMnh0bzJzMmVjcGVtIn0.2lTBdEwBI6_2QBzboizE5g",{attribution:'Imagery from <a href="http://mapbox.com/about/maps/">MapBox</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:"abcd",id:"mapbox.streets",accessToken:"pk.eyJ1Ijoic3RlZmFub3Bhcm9kaSIsImEiOiJjaXRma2VzeWgwMGVmMnh0bzJzMmVjcGVtIn0.2lTBdEwBI6_2QBzboizE5g"})},MAPBOX_SATELLITE:function(b,c){b.legend={label:"Mapbox Satellite"};return L.tileLayer("http://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoic3RlZmFub3Bhcm9kaSIsImEiOiJjaXRma2VzeWgwMGVmMnh0bzJzMmVjcGVtIn0.2lTBdEwBI6_2QBzboizE5g",{attribution:'Imagery from <a href="http://mapbox.com/about/maps/">MapBox</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:"abcd",id:"mapbox.satellite",accessToken:"pk.eyJ1Ijoic3RlZmFub3Bhcm9kaSIsImEiOiJjaXRma2VzeWgwMGVmMnh0bzJzMmVjcGVtIn0.2lTBdEwBI6_2QBzboizE5g"})},MAPBOX_OUTDOOR:function(b,c){b.legend={label:"Mapox Outdoor"};return L.tileLayer("http://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoic3RlZmFub3Bhcm9kaSIsImEiOiJjaXRma2VzeWgwMGVmMnh0bzJzMmVjcGVtIn0.2lTBdEwBI6_2QBzboizE5g",{attribution:'Imagery from <a href="http://mapbox.com/about/maps/">MapBox</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:"abcd",id:"mapbox.outdoors",accessToken:"pk.eyJ1Ijoic3RlZmFub3Bhcm9kaSIsImEiOiJjaXRma2VzeWgwMGVmMnh0bzJzMmVjcGVtIn0.2lTBdEwBI6_2QBzboizE5g"})},MAPBOX_LIGHT:function(b,c){b.legend={label:"Mapox Light"};return L.tileLayer("http://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoic3RlZmFub3Bhcm9kaSIsImEiOiJjaXRma2VzeWgwMGVmMnh0bzJzMmVjcGVtIn0.2lTBdEwBI6_2QBzboizE5g",{attribution:'Imagery from <a href="http://mapbox.com/about/maps/">MapBox</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:"abcd",id:"mapbox.light",accessToken:"pk.eyJ1Ijoic3RlZmFub3Bhcm9kaSIsImEiOiJjaXRma2VzeWgwMGVmMnh0bzJzMmVjcGVtIn0.2lTBdEwBI6_2QBzboizE5g"})},HYDDA:function(b,c){b.legend={label:"Hydda"};return L.tileLayer("http://{s}.tile.openstreetmap.se/hydda/full/{z}/{x}/{y}.png",{attribution:'Tiles courtesy of <a href="http://openstreetmap.se/" target="_blank">OpenStreetMap Sweden</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'})},ESRI_IMAGERY:function(c,d){c.legend={label:"ESRI Imagery"};c.name=c.type;var b="DigitalGlobe, GeoEye, i-cubed, USDA, USGS, AEX, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community";return L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; "+a+", "+b,maxZoom:19})},ESRI_STREETS:function(c,d){c.legend={label:"ESRI Streets"};c.name=c.type;var b="USGS, NOAA";return L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; "+a+", "+b,maxZoom:19})},ESRI_TOPOGRAPHIC:function(c,d){c.legend={label:"ESRI Topographic"};c.name=c.type;var b="USGS, NOAA";return L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; "+a+", "+b,maxZoom:19})},ESRI_GRAY:function(c,d){c.legend={label:"ESRI Gray"};c.name=c.type;var b="HERE, DeLorme, MapmyIndia, OpenStreetMap contributors";return L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; "+a+", "+b,maxZoom:16})},ESRI_DARKGRAY:function(c,d){c.legend={label:"ESRI Dark Gray"};c.name=c.type;var b="HERE, DeLorme, MapmyIndia, OpenStreetMap contributors";return L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; "+a+", "+b,maxZoom:16})},WMS:function(j,c){GV.Util.log("GV.layerFactory - Creazione Layer WMS: "+j.name);GV.Util.log(j);var i=(j.geomType==="VECTOR")?"image/png8":(j.cacheMinZoomLevel)?"image/jpeg":"image/png",b=(j.minScale)?GV.Util.getZoomFromScaleDenom(j.minScale):8,h=(j.maxScale)?GV.Util.getZoomFromScaleDenom(j.maxScale):20,d=j.wmsParams.url,e=j.name,g=j.opacity||1;if(!j.flagGeoserver){j.cacheMinZoomLevel=null;i=(j.geomType==="VECTOR")?"image/png":"image/jpeg"}var k={transparent:true,FORMAT_OPTIONS:"antialias:text",layers:e,format:i,opacity:g,minZoom:b,maxZoom:h};var f;if(j.cacheMinZoomLevel){_.extend(k,{tiled:true,TILESORIGIN:"-20037508,-20037508",tileSize:256});f=L.tileLayer.wms(d,k)}else{_.extend(k,{tiled:false,pane:"tilePane"});f=L.nonTiledLayer.wms(d,k)}f.setZIndex(j.zIndex);f.type="WMS";f.name=e;return f},JSON:function(n,c){var i=n.data,d=n.url,e=n.name,f=n.wfsParams,k=n.esParams,g=n.classes,q=n.tooltip,b=n.popup,l=n.dataType||"jsonp",m=n.cluster,h=null;var p={};if(g&&g.length>0){if(n.geomSubType==="POINT"){p.pointToLayer=function(r,u){var t;_.each(g,function(v){if(v.filter&&v.filter.key&&v.filter.value){if(r.properties[v.filter.key]===v.filter.value){t=v.style}}else{t=v.style}});if(t.iconUrl){var s;switch(t.iconUrl){case"default":s=L.icon({iconUrl:"http://geoportale.regione.liguria.it/geoviewer2/images/legend/marker-icon.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[0,-41]});break;case"default-small":s=L.icon({iconUrl:"http://geoportale.regione.liguria.it/geoviewer2/images/legend/marker-icon.png",iconSize:[12,20],iconAnchor:[6,10],popupAnchor:[0,-20]});break;default:s=L.icon({iconUrl:t.iconUrl,iconSize:t.iconSize,iconAnchor:t.iconAnchor,popupAnchor:t.popupAnchor})}return L.marker(u,{icon:s})}else{return L.circleMarker(u,t)}}}else{p.style=function(r){var s;_.each(g,function(t){if(t.filter&&t.filter.key&&t.filter.value){if(r.properties[t.filter.key]===t.filter.value){s=t.style}}else{s=t.style}});return s}}p.filter=function(s,r){var t=false;_.each(g,function(u){if(!u.filter){t=true}else{if(u.filter.key&&u.filter.value){if(s.properties[u.filter.key]==u.filter.value){t=true}}}});return t}}if(q||b){p.onEachFeature=function(s,r){if(q){r.options.title=GV.Util.template(q,s.properties)}if(b){r.bindPopup(GV.Util.template(b,s.properties))}}}var j=L.geoJson(i,p);j.name=e;j.setFilter=function(r){j.filter=r;if(r){j.eachLayer(function(s){var t=0;_.each(r,function(u){if(s.feature.properties[u.key]==u.value){t=j.config.opacity||1}});s.setOpacity(t)})}else{j.eachLayer(function(s){var t=j.config.opacity||1;s.setOpacity(t)})}};if(f&&f.typeName&&f.url){var o={service:"WFS",version:"2.0.0",request:"GetFeature",srsName:"EPSG:4326",outputFormat:"text/javascript",format_options:"callback: getJson",typeName:f.typeName};d=f.url+GV.Util.getParamString(o);l="jsonp"}if(k){var o={};if(k.field){o.q=k.field+":";if(k.query){o.q+=k.query}else{o.q+="*"}}else{if(k.query){o.q=k.query}}o.pretty="true";o.size=100000;d=GV.app.proxy+k.url+GV.Util.getParamString(o);l="json"}if(d){$.ajax({url:d,dataType:l,jsonpCallback:"getJson",success:function(u){var r=u;if(k){var s=k.geomField||"location";var t=u.hits.hits;r={type:"FeatureCollection",totalFeatures:u.hits.total,features:[],crs:{type:"name",properties:{name:"urn:ogc:def:crs:EPSG::4326"}}};_.each(t,function(v){var w=v._source[s];r.features.push({type:"Feature",id:v._id,geometry:{type:"Point",coordinates:w},geometry_name:"GEOMETRY",properties:v._source})})}j.addData(r);if(m){h.addLayer(j)}}})}if(m){var p={showCoverageOnHover:false};if(m.options){_.extend(p,m.options)}h=L.markerClusterGroup(p);return h}return j}}};GV.Map=L.Map.extend({rlMaps:[],layers:[],baseLayers:[],initialExtent:[],mapOptions:{zoomControl:false},initialize:function(a){this.setMapOptions(a);L.Map.prototype.initialize.call(this,"gv-map",_.extend(L.Map.prototype.options,this.mapOptions));this.setInitialExtent();this.setInfoWms(a);this.setLayersInRange()},setMapOptions:function(a){if(a.config.application&&a.config.application.layout&&a.config.application.mapOptions){_.extend(this.mapOptions,a.config.application.mapOptions)}},setInitialExtent:function(){var b=this.mapOptions.initialExtent||"830036,5402959,1123018,5597635";var d=b.split(",");var c=L.point(d[0],d[1]);var f=L.point(d[2],d[3]);var a=L.Projection.SphericalMercator.unproject(c);var e=L.Projection.SphericalMercator.unproject(f);this.initialExtent=L.latLngBounds(a,e);this.fitBounds(this.initialExtent)},setInfoWms:function(a){if(this.mapOptions.infoWms){GV.infoWmsManager=new GV.InfoWmsManager();GV.infoWmsManager.activate(this,a.config)}},setLayersInRange:function(){this.on("zoom",function(){var a=GV.rlMaps.getAllLayersConfig();_.each(a,function(b){GV.rlMaps.setLayerAttribute(b.name,"inRange",this.layerInRange(b))},this)})},setLayerVisible:function(a,b){if(b){this.loadLayers([a])}else{this.removeLayer(this.getLayerByName(a.name))}},layerInRange:function(a){return(this.getScale()<a.minScale&&this.getScale()>a.maxScale)},loadControls:function(b){if(b.config.application&&b.config.application.layout&&b.config.application.layout.controls){var a=b.config.application.layout.controls;var c;this.controls={};_.each(a,function(d){switch(d.name){case"scaleControl":c=L.control.scale({imperial:false}).addTo(this);this.controls[d]=c;break}},this)}},loadBaseLayers:function(a){_.each(a,function(b){var c=GV.layerFactory.create(b,this);this.baseLayers[c.config.legend.label]=c;if(c&&b.visible){c.addTo(this)}},this)},loadLayers:function(a){_.each(a,function(b){if(!this.getLayerByName(b.name)){var c=GV.layerFactory.create(b,this);if(c&&b.visible&&!this.getLayerByName(b.name)){c.addTo(this)}}},this)},getLayerByName:function(b){var a=null;this.eachLayer(function(c){if(c.config&&c.config.name&&c.config.name===b){a=c}});return a},getScaleLabel:function(){return GV.Util.getScaleLabelsFromZoom(this._zoom)},getScale:function(){return GV.Util.getScaleFromZoom(this._zoom)}});(function(b,a,c){L.MarkerClusterGroup=L.FeatureGroup.extend({options:{maxClusterRadius:80,iconCreateFunction:null,spiderfyOnMaxZoom:true,showCoverageOnHover:true,zoomToBoundsOnClick:true,singleMarkerMode:false,disableClusteringAtZoom:null,removeOutsideVisibleBounds:true,animate:true,animateAddingMarkers:false,spiderfyDistanceMultiplier:1,spiderLegPolylineOptions:{weight:1.5,color:"#222",opacity:0.5},chunkedLoading:false,chunkInterval:200,chunkDelay:50,chunkProgress:null,polygonOptions:{}},initialize:function(e){L.Util.setOptions(this,e);if(!this.options.iconCreateFunction){this.options.iconCreateFunction=this._defaultIconCreateFunction}this._featureGroup=L.featureGroup();this._featureGroup.addEventParent(this);this._nonPointGroup=L.featureGroup();this._nonPointGroup.addEventParent(this);this._inZoomAnimation=0;this._needsClustering=[];this._needsRemoving=[];this._currentShownBounds=null;this._queue=[];var d=L.DomUtil.TRANSITION&&this.options.animate;L.extend(this,d?this._withAnimation:this._noAnimation);this._markerCluster=d?L.MarkerCluster:L.MarkerClusterNonAnimated},addLayer:function(f){if(f instanceof L.LayerGroup){return this.addLayers([f])}if(!f.getLatLng){this._nonPointGroup.addLayer(f);return this}if(!this._map){this._needsClustering.push(f);return this}if(this.hasLayer(f)){return this}if(this._unspiderfy){this._unspiderfy()}this._addLayer(f,this._maxZoom);this._topClusterLevel._recalculateBounds();var d=f,e=this._map.getZoom();if(f.__parent){while(d.__parent._zoom>=e){d=d.__parent}}if(this._currentShownBounds.contains(d.getLatLng())){if(this.options.animateAddingMarkers){this._animationAddLayer(f,d)}else{this._animationAddLayerNonAnimated(f,d)}}return this},removeLayer:function(d){if(d instanceof L.LayerGroup){return this.removeLayers([d])}if(!d.getLatLng){this._nonPointGroup.removeLayer(d);return this}if(!this._map){if(!this._arraySplice(this._needsClustering,d)&&this.hasLayer(d)){this._needsRemoving.push(d)}return this}if(!d.__parent){return this}if(this._unspiderfy){this._unspiderfy();this._unspiderfyLayer(d)}this._removeLayer(d,true);this._topClusterLevel._recalculateBounds();d.off("move",this._childMarkerMoved,this);if(this._featureGroup.hasLayer(d)){this._featureGroup.removeLayer(d);if(d.clusterShow){d.clusterShow()}}return this},addLayers:function(h){if(!L.Util.isArray(h)){return this.addLayer(h)}var e=this._featureGroup,k=this._nonPointGroup,o=this.options.chunkedLoading,n=this.options.chunkInterval,q=this.options.chunkProgress,i=h.length,j=0,p=true,g;if(this._map){var r=(new Date()).getTime();var f=L.bind(function(){var t=(new Date()).getTime();for(;j<i;j++){if(o&&j%200===0){var l=(new Date()).getTime()-t;if(l>n){break}}g=h[j];if(g instanceof L.LayerGroup){if(p){h=h.slice();p=false}this._extractNonGroupLayers(g,h);i=h.length;continue}if(!g.getLatLng){k.addLayer(g);continue}if(this.hasLayer(g)){continue}this._addLayer(g,this._maxZoom);if(g.__parent){if(g.__parent.getChildCount()===2){var s=g.__parent.getAllChildMarkers(),m=s[0]===g?s[1]:s[0];e.removeLayer(m)}}}if(q){q(j,i,(new Date()).getTime()-r)}if(j===i){this._topClusterLevel._recalculateBounds();this._featureGroup.eachLayer(function(u){if(u instanceof L.MarkerCluster&&u._iconNeedsUpdate){u._updateIcon()}});this._topClusterLevel._recursivelyAddChildrenToMap(null,this._zoom,this._currentShownBounds)}else{setTimeout(f,this.options.chunkDelay)}},this);f()}else{var d=this._needsClustering;for(;j<i;j++){g=h[j];if(g instanceof L.LayerGroup){if(p){h=h.slice();p=false}this._extractNonGroupLayers(g,h);i=h.length;continue}if(!g.getLatLng){k.addLayer(g);continue}if(this.hasLayer(g)){continue}d.push(g)}}return this},removeLayers:function(g){var j,f,h=g.length,d=this._featureGroup,k=this._nonPointGroup,n=true;if(!this._map){for(j=0;j<h;j++){f=g[j];if(f instanceof L.LayerGroup){if(n){g=g.slice();n=false}this._extractNonGroupLayers(f,g);h=g.length;continue}this._arraySplice(this._needsClustering,f);k.removeLayer(f);if(this.hasLayer(f)){this._needsRemoving.push(f)}}return this}if(this._unspiderfy){this._unspiderfy();var o=g.slice(),e=h;for(j=0;j<e;j++){f=o[j];if(f instanceof L.LayerGroup){this._extractNonGroupLayers(f,o);e=o.length;continue}this._unspiderfyLayer(f)}}for(j=0;j<h;j++){f=g[j];if(f instanceof L.LayerGroup){if(n){g=g.slice();n=false}this._extractNonGroupLayers(f,g);h=g.length;continue}if(!f.__parent){k.removeLayer(f);continue}this._removeLayer(f,true,true);if(d.hasLayer(f)){d.removeLayer(f);if(f.clusterShow){f.clusterShow()}}}this._topClusterLevel._recalculateBounds();this._topClusterLevel._recursivelyAddChildrenToMap(null,this._zoom,this._currentShownBounds);d.eachLayer(function(i){if(i instanceof L.MarkerCluster){i._updateIcon()}});return this},clearLayers:function(){if(!this._map){this._needsClustering=[];delete this._gridClusters;delete this._gridUnclustered}if(this._noanimationUnspiderfy){this._noanimationUnspiderfy()}this._featureGroup.clearLayers();this._nonPointGroup.clearLayers();this.eachLayer(function(d){d.off("move",this._childMarkerMoved,this);delete d.__parent});if(this._map){this._generateInitialClusters()}return this},getBounds:function(){var e=new L.LatLngBounds();if(this._topClusterLevel){e.extend(this._topClusterLevel._bounds)}for(var d=this._needsClustering.length-1;d>=0;d--){e.extend(this._needsClustering[d].getLatLng())}e.extend(this._nonPointGroup.getBounds());return e},eachLayer:function(h,f){var g=this._needsClustering.slice(),d=this._needsRemoving,e;if(this._topClusterLevel){this._topClusterLevel.getAllChildMarkers(g)}for(e=g.length-1;e>=0;e--){if(d.indexOf(g[e])===-1){h.call(f,g[e])}}this._nonPointGroup.eachLayer(h,f)},getLayers:function(){var d=[];this.eachLayer(function(e){d.push(e)});return d},getLayer:function(e){var d=null;e=parseInt(e,10);this.eachLayer(function(f){if(L.stamp(f)===e){d=f}});return d},hasLayer:function(e){if(!e){return false}var d,f=this._needsClustering;for(d=f.length-1;d>=0;d--){if(f[d]===e){return true}}f=this._needsRemoving;for(d=f.length-1;d>=0;d--){if(f[d]===e){return false}}return !!(e.__parent&&e.__parent._group===this)||this._nonPointGroup.hasLayer(e)},zoomToShowLayer:function(e,g){if(typeof g!=="function"){g=function(){}}var f=function(){if((e._icon||e.__parent._icon)&&!this._inZoomAnimation){this._map.off("moveend",f,this);this.off("animationend",f,this);if(e._icon){g()}else{if(e.__parent._icon){this.once("spiderfied",g,this);e.__parent.spiderfy()}}}};if(e._icon&&this._map.getBounds().contains(e.getLatLng())){g()}else{if(e.__parent._zoom<this._map.getZoom()){this._map.on("moveend",f,this);this._map.panTo(e.getLatLng())}else{var d=function(){this._map.off("movestart",d,this);d=null};this._map.on("movestart",d,this);this._map.on("moveend",f,this);this.on("animationend",f,this);e.__parent.zoomToBounds();if(d){f.call(this)}}}},onAdd:function(g){this._map=g;var f,d,e;if(!isFinite(this._map.getMaxZoom())){throw"Map has no maxZoom specified"}this._featureGroup.addTo(g);this._nonPointGroup.addTo(g);if(!this._gridClusters){this._generateInitialClusters()}this._maxLat=g.options.crs.projection.MAX_LATITUDE;for(f=0,d=this._needsRemoving.length;f<d;f++){e=this._needsRemoving[f];this._removeLayer(e,true)}this._needsRemoving=[];this._zoom=this._map.getZoom();this._currentShownBounds=this._getExpandedVisibleBounds();this._map.on("zoomend",this._zoomEnd,this);this._map.on("moveend",this._moveEnd,this);if(this._spiderfierOnAdd){this._spiderfierOnAdd()}this._bindEvents();d=this._needsClustering;this._needsClustering=[];this.addLayers(d)},onRemove:function(d){d.off("zoomend",this._zoomEnd,this);d.off("moveend",this._moveEnd,this);this._unbindEvents();this._map._mapPane.className=this._map._mapPane.className.replace(" leaflet-cluster-anim","");if(this._spiderfierOnRemove){this._spiderfierOnRemove()}delete this._maxLat;this._hideCoverage();this._featureGroup.remove();this._nonPointGroup.remove();this._featureGroup.clearLayers();this._map=null},getVisibleParent:function(d){var e=d;while(e&&!e._icon){e=e.__parent}return e||null},_arraySplice:function(e,f){for(var d=e.length-1;d>=0;d--){if(e[d]===f){e.splice(d,1);return true}}},_removeFromGridUnclustered:function(d,g){var f=this._map,e=this._gridUnclustered;for(;g>=0;g--){if(!e[g].removeObject(d,f.project(d.getLatLng(),g))){break}}},_childMarkerMoved:function(d){if(!this._ignoreMove){d.target._latlng=d.oldLatLng;this.removeLayer(d.target);d.target._latlng=d.latlng;this.addLayer(d.target)}},_removeLayer:function(j,g,k){var h=this._gridClusters,f=this._gridUnclustered,d=this._featureGroup,e=this._map;if(g){this._removeFromGridUnclustered(j,this._maxZoom)}var l=j.__parent,i=l._markers,m;this._arraySplice(i,j);while(l){l._childCount--;l._boundsNeedUpdate=true;if(l._zoom<0){break}else{if(g&&l._childCount<=1){m=l._markers[0]===j?l._markers[1]:l._markers[0];h[l._zoom].removeObject(l,e.project(l._cLatLng,l._zoom));f[l._zoom].addObject(m,e.project(m.getLatLng(),l._zoom));this._arraySplice(l.__parent._childClusters,l);l.__parent._markers.push(m);m.__parent=l.__parent;if(l._icon){d.removeLayer(l);if(!k){d.addLayer(m)}}}else{if(!k||!l._icon){l._updateIcon()}}}l=l.__parent}delete j.__parent},_isOrIsParent:function(e,d){while(d){if(e===d){return true}d=d.parentNode}return false},fire:function(e,f,d){if(f&&f.layer instanceof L.MarkerCluster){if(f.originalEvent&&this._isOrIsParent(f.layer._icon,f.originalEvent.relatedTarget)){return}e="cluster"+e}L.FeatureGroup.prototype.fire.call(this,e,f,d)},listens:function(e,d){return L.FeatureGroup.prototype.listens.call(this,e,d)||L.FeatureGroup.prototype.listens.call(this,"cluster"+e,d)},_defaultIconCreateFunction:function(d){var e=d.getChildCount();var f=" marker-cluster-";if(e<10){f+="small"}else{if(e<100){f+="medium"}else{f+="large"}}return new L.DivIcon({html:"<div><span>"+e+"</span></div>",className:"marker-cluster"+f,iconSize:new L.Point(40,40)})},_bindEvents:function(){var g=this._map,e=this.options.spiderfyOnMaxZoom,d=this.options.showCoverageOnHover,f=this.options.zoomToBoundsOnClick;if(e||f){this.on("clusterclick",this._zoomOrSpiderfy,this)}if(d){this.on("clustermouseover",this._showCoverage,this);this.on("clustermouseout",this._hideCoverage,this);g.on("zoomend",this._hideCoverage,this)}},_zoomOrSpiderfy:function(g){var d=g.layer,f=d;while(f._childClusters.length===1){f=f._childClusters[0]}if(f._zoom===this._maxZoom&&f._childCount===d._childCount&&this.options.spiderfyOnMaxZoom){d.spiderfy()}else{if(this.options.zoomToBoundsOnClick){d.zoomToBounds()}}if(g.originalEvent&&g.originalEvent.keyCode===13){this._map._container.focus()}},_showCoverage:function(f){var d=this._map;if(this._inZoomAnimation){return}if(this._shownPolygon){d.removeLayer(this._shownPolygon)}if(f.layer.getChildCount()>2&&f.layer!==this._spiderfied){this._shownPolygon=new L.Polygon(f.layer.getConvexHull(),this.options.polygonOptions);d.addLayer(this._shownPolygon)}},_hideCoverage:function(){if(this._shownPolygon){this._map.removeLayer(this._shownPolygon);this._shownPolygon=null}},_unbindEvents:function(){var e=this.options.spiderfyOnMaxZoom,d=this.options.showCoverageOnHover,g=this.options.zoomToBoundsOnClick,f=this._map;if(e||g){this.off("clusterclick",this._zoomOrSpiderfy,this)}if(d){this.off("clustermouseover",this._showCoverage,this);this.off("clustermouseout",this._hideCoverage,this);f.off("zoomend",this._hideCoverage,this)}},_zoomEnd:function(){if(!this._map){return}this._mergeSplitClusters();this._zoom=Math.round(this._map._zoom);this._currentShownBounds=this._getExpandedVisibleBounds()},_moveEnd:function(){if(this._inZoomAnimation){return}var d=this._getExpandedVisibleBounds();this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,this._zoom,d);this._topClusterLevel._recursivelyAddChildrenToMap(null,Math.round(this._map._zoom),d);this._currentShownBounds=d;return},_generateInitialClusters:function(){var e=this._map.getMaxZoom(),d=this.options.maxClusterRadius,f=d;if(typeof d!=="function"){f=function(){return d}}if(this.options.disableClusteringAtZoom){e=this.options.disableClusteringAtZoom-1}this._maxZoom=e;this._gridClusters={};this._gridUnclustered={};for(var g=e;g>=0;g--){this._gridClusters[g]=new L.DistanceGrid(f(g));this._gridUnclustered[g]=new L.DistanceGrid(f(g))}this._topClusterLevel=new this._markerCluster(this,-1)},_addLayer:function(h,m){var f=this._gridClusters,d=this._gridUnclustered,l,i;if(this.options.singleMarkerMode){this._overrideMarkerIcon(h)}h.on("move",this._childMarkerMoved,this);for(;m>=0;m--){l=this._map.project(h.getLatLng(),m);var e=f[m].getNearObject(l);if(e){e._addChild(h);h.__parent=e;return}e=d[m].getNearObject(l);if(e){var j=e.__parent;if(j){this._removeLayer(e,false)}var k=new this._markerCluster(this,m,e,h);f[m].addObject(k,this._map.project(k._cLatLng,m));e.__parent=k;h.__parent=k;var g=k;for(i=m-1;i>j._zoom;i--){g=new this._markerCluster(this,i,g);f[i].addObject(g,this._map.project(e.getLatLng(),i))}j._addChild(g);this._removeFromGridUnclustered(e,m);return}d[m].addObject(h,l)}this._topClusterLevel._addChild(h);h.__parent=this._topClusterLevel;return},_enqueue:function(d){this._queue.push(d);if(!this._queueTimeout){this._queueTimeout=setTimeout(L.bind(this._processQueue,this),300)}},_processQueue:function(){for(var d=0;d<this._queue.length;d++){this._queue[d].call(this)}this._queue.length=0;clearTimeout(this._queueTimeout);this._queueTimeout=null},_mergeSplitClusters:function(){var d=Math.round(this._map._zoom);this._processQueue();if(this._zoom<d&&this._currentShownBounds.intersects(this._getExpandedVisibleBounds())){this._animationStart();this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,this._zoom,this._getExpandedVisibleBounds());this._animationZoomIn(this._zoom,d)}else{if(this._zoom>d){this._animationStart();this._animationZoomOut(this._zoom,d)}else{this._moveEnd()}}},_getExpandedVisibleBounds:function(){if(!this.options.removeOutsideVisibleBounds){return this._mapBoundsInfinite}else{if(L.Browser.mobile){return this._checkBoundsMaxLat(this._map.getBounds())}}return this._checkBoundsMaxLat(this._map.getBounds().pad(1))},_checkBoundsMaxLat:function(d){var e=this._maxLat;if(e!==c){if(d.getNorth()>=e){d._northEast.lat=Infinity}if(d.getSouth()<=-e){d._southWest.lat=-Infinity}}return d},_animationAddLayerNonAnimated:function(d,e){if(e===d){this._featureGroup.addLayer(d)}else{if(e._childCount===2){e._addToMap();var f=e.getAllChildMarkers();this._featureGroup.removeLayer(f[0]);this._featureGroup.removeLayer(f[1])}else{e._updateIcon()}}},_extractNonGroupLayers:function(h,d){var g=h.getLayers(),f=0,e;d=d||[];for(;f<g.length;f++){e=g[f];if(e instanceof L.LayerGroup){this._extractNonGroupLayers(e,d);continue}d.push(e)}return d},_overrideMarkerIcon:function(d){var e=d.options.icon=this.options.iconCreateFunction({getChildCount:function(){return 1},getAllChildMarkers:function(){return[d]}});return e}});L.MarkerClusterGroup.include({_mapBoundsInfinite:new L.LatLngBounds(new L.LatLng(-Infinity,-Infinity),new L.LatLng(Infinity,Infinity))});L.MarkerClusterGroup.include({_noAnimation:{_animationStart:function(){},_animationZoomIn:function(e,d){this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,e);this._topClusterLevel._recursivelyAddChildrenToMap(null,d,this._getExpandedVisibleBounds());this.fire("animationend")},_animationZoomOut:function(e,d){this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,e);this._topClusterLevel._recursivelyAddChildrenToMap(null,d,this._getExpandedVisibleBounds());this.fire("animationend")},_animationAddLayer:function(d,e){this._animationAddLayerNonAnimated(d,e)}},_withAnimation:{_animationStart:function(){this._map._mapPane.className+=" leaflet-cluster-anim";this._inZoomAnimation++},_animationZoomIn:function(h,f){var g=this._getExpandedVisibleBounds(),d=this._featureGroup,e;this._ignoreMove=true;this._topClusterLevel._recursively(g,h,0,function(l){var j=l._latlng,k=l._markers,i;if(!g.contains(j)){j=null}if(l._isSingleParent()&&h+1===f){d.removeLayer(l);l._recursivelyAddChildrenToMap(null,f,g)}else{l.clusterHide();l._recursivelyAddChildrenToMap(j,f,g)}for(e=k.length-1;e>=0;e--){i=k[e];if(!g.contains(i._latlng)){d.removeLayer(i)}}});this._forceLayout();this._topClusterLevel._recursivelyBecomeVisible(g,f);d.eachLayer(function(i){if(!(i instanceof L.MarkerCluster)&&i._icon){i.clusterShow()}});this._topClusterLevel._recursively(g,h,f,function(i){i._recursivelyRestoreChildPositions(f)});this._ignoreMove=false;this._enqueue(function(){this._topClusterLevel._recursively(g,h,0,function(i){d.removeLayer(i);i.clusterShow()});this._animationEnd()})},_animationZoomOut:function(e,d){this._animationZoomOutSingle(this._topClusterLevel,e-1,d);this._topClusterLevel._recursivelyAddChildrenToMap(null,d,this._getExpandedVisibleBounds());this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,e,this._getExpandedVisibleBounds())},_animationAddLayer:function(e,g){var f=this,d=this._featureGroup;d.addLayer(e);if(g!==e){if(g._childCount>2){g._updateIcon();this._forceLayout();this._animationStart();e._setPos(this._map.latLngToLayerPoint(g.getLatLng()));e.clusterHide();this._enqueue(function(){d.removeLayer(e);e.clusterShow();f._animationEnd()})}else{this._forceLayout();f._animationStart();f._animationZoomOutSingle(g,this._map.getMaxZoom(),this._map.getZoom())}}}},_animationZoomOutSingle:function(d,h,e){var g=this._getExpandedVisibleBounds();d._recursivelyAnimateChildrenInAndAddSelfToMap(g,h+1,e);var f=this;this._forceLayout();d._recursivelyBecomeVisible(g,e);this._enqueue(function(){if(d._childCount===1){var i=d._markers[0];this._ignoreMove=true;i.setLatLng(i.getLatLng());this._ignoreMove=false;if(i.clusterShow){i.clusterShow()}}else{d._recursively(g,e,0,function(j){j._recursivelyRemoveChildrenFromMap(g,h+1)})}f._animationEnd()})},_animationEnd:function(){if(this._map){this._map._mapPane.className=this._map._mapPane.className.replace(" leaflet-cluster-anim","")}this._inZoomAnimation--;this.fire("animationend")},_forceLayout:function(){L.Util.falseFn(a.body.offsetWidth)}});L.markerClusterGroup=function(d){return new L.MarkerClusterGroup(d)};L.MarkerCluster=L.Marker.extend({initialize:function(g,f,e,d){L.Marker.prototype.initialize.call(this,e?(e._cLatLng||e.getLatLng()):new L.LatLng(0,0),{icon:this});this._group=g;this._zoom=f;this._markers=[];this._childClusters=[];this._childCount=0;this._iconNeedsUpdate=true;this._boundsNeedUpdate=true;this._bounds=new L.LatLngBounds();if(e){this._addChild(e)}if(d){this._addChild(d)}},getAllChildMarkers:function(f){f=f||[];for(var e=this._childClusters.length-1;e>=0;e--){this._childClusters[e].getAllChildMarkers(f)}for(var d=this._markers.length-1;d>=0;d--){f.push(this._markers[d])}return f},getChildCount:function(){return this._childCount},zoomToBounds:function(){var g=this._childClusters.slice(),k=this._group._map,j=k.getBoundsZoom(this._bounds),f=this._zoom+1,h=k.getZoom(),e;while(g.length>0&&j>f){f++;var d=[];for(e=0;e<g.length;e++){d=d.concat(g[e]._childClusters)}g=d}if(j>f){this._group._map.setView(this._latlng,f)}else{if(j<=h){this._group._map.setView(this._latlng,h+1)}else{this._group._map.fitBounds(this._bounds)}}},getBounds:function(){var d=new L.LatLngBounds();d.extend(this._bounds);return d},_updateIcon:function(){this._iconNeedsUpdate=true;if(this._icon){this.setIcon(this)}},createIcon:function(){if(this._iconNeedsUpdate){this._iconObj=this._group.options.iconCreateFunction(this);this._iconNeedsUpdate=false}return this._iconObj.createIcon()},createShadow:function(){return this._iconObj.createShadow()},_addChild:function(d,e){this._iconNeedsUpdate=true;this._boundsNeedUpdate=true;this._setClusterCenter(d);if(d instanceof L.MarkerCluster){if(!e){this._childClusters.push(d);d.__parent=this}this._childCount+=d._childCount}else{if(!e){this._markers.push(d)}this._childCount++}if(this.__parent){this.__parent._addChild(d,true)}},_setClusterCenter:function(d){if(!this._cLatLng){this._cLatLng=d._cLatLng||d._latlng}},_resetBounds:function(){var d=this._bounds;if(d._southWest){d._southWest.lat=Infinity;d._southWest.lng=Infinity}if(d._northEast){d._northEast.lat=-Infinity;d._northEast.lng=-Infinity}},_recalculateBounds:function(){var h=this._markers,l=this._childClusters,d=0,f=0,m=this._childCount,j,e,k,g;if(m===0){return}this._resetBounds();for(j=0;j<h.length;j++){k=h[j]._latlng;this._bounds.extend(k);d+=k.lat;f+=k.lng}for(j=0;j<l.length;j++){e=l[j];if(e._boundsNeedUpdate){e._recalculateBounds()}this._bounds.extend(e._bounds);k=e._wLatLng;g=e._childCount;d+=k.lat*g;f+=k.lng*g}this._latlng=this._wLatLng=new L.LatLng(d/m,f/m);this._boundsNeedUpdate=false},_addToMap:function(d){if(d){this._backupLatlng=this._latlng;this.setLatLng(d)}this._group._featureGroup.addLayer(this)},_recursivelyAnimateChildrenIn:function(f,d,e){this._recursively(f,0,e-1,function(k){var j=k._markers,h,g;for(h=j.length-1;h>=0;h--){g=j[h];if(g._icon){g._setPos(d);g.clusterHide()}}},function(k){var i=k._childClusters,h,g;for(h=i.length-1;h>=0;h--){g=i[h];if(g._icon){g._setPos(d);g.clusterHide()}}})},_recursivelyAnimateChildrenInAndAddSelfToMap:function(f,e,d){this._recursively(f,d,0,function(g){g._recursivelyAnimateChildrenIn(f,g._group._map.latLngToLayerPoint(g.getLatLng()).round(),e);if(g._isSingleParent()&&e-1===d){g.clusterShow();g._recursivelyRemoveChildrenFromMap(f,e)}else{g.clusterHide()}g._addToMap()})},_recursivelyBecomeVisible:function(d,e){this._recursively(d,0,e,null,function(f){f.clusterShow()})},_recursivelyAddChildrenToMap:function(d,f,e){this._recursively(e,-1,f,function(j){if(f===j._zoom){return}for(var h=j._markers.length-1;h>=0;h--){var g=j._markers[h];if(!e.contains(g._latlng)){continue}if(d){g._backupLatlng=g.getLatLng();g.setLatLng(d);if(g.clusterHide){g.clusterHide()}}j._group._featureGroup.addLayer(g)}},function(g){g._addToMap(d)})},_recursivelyRestoreChildPositions:function(h){for(var g=this._markers.length-1;g>=0;g--){var d=this._markers[g];if(d._backupLatlng){d.setLatLng(d._backupLatlng);delete d._backupLatlng}}if(h-1===this._zoom){for(var f=this._childClusters.length-1;f>=0;f--){this._childClusters[f]._restorePosition()}}else{for(var e=this._childClusters.length-1;e>=0;e--){this._childClusters[e]._recursivelyRestoreChildPositions(h)}}},_restorePosition:function(){if(this._backupLatlng){this.setLatLng(this._backupLatlng);delete this._backupLatlng}},_recursivelyRemoveChildrenFromMap:function(e,h,g){var d,f;this._recursively(e,-1,h-1,function(i){for(f=i._markers.length-1;f>=0;f--){d=i._markers[f];if(!g||!g.contains(d._latlng)){i._group._featureGroup.removeLayer(d);if(d.clusterShow){d.clusterShow()}}}},function(i){for(f=i._childClusters.length-1;f>=0;f--){d=i._childClusters[f];if(!g||!g.contains(d._latlng)){i._group._featureGroup.removeLayer(d);if(d.clusterShow){d.clusterShow()}}}})},_recursively:function(k,j,f,d,g){var h=this._childClusters,m=this._zoom,e,l;if(j>m){for(e=h.length-1;e>=0;e--){l=h[e];if(k.intersects(l._bounds)){l._recursively(k,j,f,d,g)}}}else{if(d){d(this)}if(g&&this._zoom===f){g(this)}if(f>m){for(e=h.length-1;e>=0;e--){l=h[e];if(k.intersects(l._bounds)){l._recursively(k,j,f,d,g)}}}}},_isSingleParent:function(){return this._childClusters.length>0&&this._childClusters[0]._childCount===this._childCount}});L.Marker.include({clusterHide:function(){this.options.opacityWhenUnclustered=this.options.opacity||1;return this.setOpacity(0)},clusterShow:function(){var d=this.setOpacity(this.options.opacity||this.options.opacityWhenUnclustered);delete this.options.opacityWhenUnclustered;return d}});L.DistanceGrid=function(d){this._cellSize=d;this._sqCellSize=d*d;this._grid={};this._objectPoint={}};L.DistanceGrid.prototype={addObject:function(i,f){var e=this._getCoord(f.x),k=this._getCoord(f.y),h=this._grid,j=h[k]=h[k]||{},d=j[e]=j[e]||[],g=L.Util.stamp(i);this._objectPoint[g]=f;d.push(i)},updateObject:function(e,d){this.removeObject(e);this.addObject(e,d)},removeObject:function(e,k){var j=this._getCoord(k.x),h=this._getCoord(k.y),d=this._grid,m=d[h]=d[h]||{},l=m[j]=m[j]||[],f,g;delete this._objectPoint[L.Util.stamp(e)];for(f=0,g=l.length;f<g;f++){if(l[f]===e){l.splice(f,1);if(g===1){delete m[j]}return true}}},eachObject:function(n,e){var h,g,f,m,p,o,l,d=this._grid;for(h in d){p=d[h];for(g in p){o=p[g];for(f=0,m=o.length;f<m;f++){l=n.call(e,o[f]);if(l){f--;m--}}}}},getNearObject:function(q){var p=this._getCoord(q.x),o=this._getCoord(q.y),h,f,e,t,s,l,g,n,r=this._objectPoint,m=this._sqCellSize,d=null;for(h=o-1;h<=o+1;h++){t=this._grid[h];if(t){for(f=p-1;f<=p+1;f++){s=t[f];if(s){for(e=0,l=s.length;e<l;e++){g=s[e];n=this._sqDist(r[L.Util.stamp(g)],q);if(n<m){m=n;d=g}}}}}}return d},_getCoord:function(d){return Math.floor(d/this._cellSize)},_sqDist:function(g,f){var e=f.x-g.x,d=f.y-g.y;return e*e+d*d}};(function(){L.QuickHull={getDistant:function(f,g){var d=g[1].lat-g[0].lat,e=g[0].lng-g[1].lng;return(e*(f.lat-g[0].lat)+d*(f.lng-g[0].lng))},findMostDistantPointFromBaseLine:function(f,l){var j=0,e=null,h=[],g,k,m;for(g=l.length-1;g>=0;g--){k=l[g];m=this.getDistant(k,f);if(m>0){h.push(k)}else{continue}if(m>j){j=m;e=k}}return{maxPoint:e,newPoints:h}},buildConvexHull:function(d,g){var f=[],e=this.findMostDistantPointFromBaseLine(d,g);if(e.maxPoint){f=f.concat(this.buildConvexHull([d[0],e.maxPoint],e.newPoints));f=f.concat(this.buildConvexHull([e.maxPoint,d[1]],e.newPoints));return f}else{return[d[0]]}},getConvexHull:function(j){var o=false,g=false,p=false,k=false,l=null,q=null,f=null,h=null,n=null,e=null,m;for(m=j.length-1;m>=0;m--){var r=j[m];if(o===false||r.lat>o){l=r;o=r.lat}if(g===false||r.lat<g){q=r;g=r.lat}if(p===false||r.lng>p){f=r;p=r.lng}if(k===false||r.lng<k){h=r;k=r.lng}}if(g!==o){e=q;n=l}else{e=h;n=f}var d=[].concat(this.buildConvexHull([e,n],j),this.buildConvexHull([n,e],j));return d}}}());L.MarkerCluster.include({getConvexHull:function(){var g=this.getAllChildMarkers(),e=[],f,d;for(d=g.length-1;d>=0;d--){f=g[d].getLatLng();e.push(f)}return L.QuickHull.getConvexHull(e)}});L.MarkerCluster.include({_2PI:Math.PI*2,_circleFootSeparation:25,_circleStartAngle:Math.PI/6,_spiralFootSeparation:28,_spiralLengthStart:11,_spiralLengthFactor:5,_circleSpiralSwitchover:9,spiderfy:function(){if(this._group._spiderfied===this||this._group._inZoomAnimation){return}var h=this.getAllChildMarkers(),g=this._group,f=g._map,d=f.latLngToLayerPoint(this._latlng),e;this._group._unspiderfy();this._group._spiderfied=this;if(h.length>=this._circleSpiralSwitchover){e=this._generatePointsSpiral(h.length,d)}else{d.y+=10;e=this._generatePointsCircle(h.length,d)}this._animationSpiderfy(h,e)},unspiderfy:function(d){if(this._group._inZoomAnimation){return}this._animationUnspiderfy(d);this._group._spiderfied=null},_generatePointsCircle:function(h,l){var d=this._group.options.spiderfyDistanceMultiplier*this._circleFootSeparation*(2+h),j=d/this._2PI,g=this._2PI/h,f=[],e,k;f.length=h;for(e=h-1;e>=0;e--){k=this._circleStartAngle+e*g;f[e]=new L.Point(l.x+j*Math.cos(k),l.y+j*Math.sin(k))._round()}return f},_generatePointsSpiral:function(j,d){var m=this._group.options.spiderfyDistanceMultiplier,l=m*this._spiralLengthStart,f=m*this._spiralFootSeparation,g=m*this._spiralLengthFactor*this._2PI,e=0,k=[],h;k.length=j;for(h=j-1;h>=0;h--){e+=f/l+h*0.0005;k[h]=new L.Point(d.x+l*Math.cos(e),d.y+l*Math.sin(e))._round();l+=g/e}return k},_noanimationUnspiderfy:function(){var j=this._group,h=j._map,e=j._featureGroup,g=this.getAllChildMarkers(),d,f;j._ignoreMove=true;this.setOpacity(1);for(f=g.length-1;f>=0;f--){d=g[f];e.removeLayer(d);if(d._preSpiderfyLatlng){d.setLatLng(d._preSpiderfyLatlng);delete d._preSpiderfyLatlng}if(d.setZIndexOffset){d.setZIndexOffset(0)}if(d._spiderLeg){h.removeLayer(d._spiderLeg);delete d._spiderLeg}}j.fire("unspiderfied",{cluster:this,markers:g});j._ignoreMove=false;j._spiderfied=null}});L.MarkerClusterNonAnimated=L.MarkerCluster.extend({_animationSpiderfy:function(g,k){var o=this._group,e=o._map,d=o._featureGroup,f=this._group.options.spiderLegPolylineOptions,j,h,n,l;o._ignoreMove=true;for(j=0;j<g.length;j++){l=e.layerPointToLatLng(k[j]);h=g[j];n=new L.Polyline([this._latlng,l],f);e.addLayer(n);h._spiderLeg=n;h._preSpiderfyLatlng=h._latlng;h.setLatLng(l);if(h.setZIndexOffset){h.setZIndexOffset(1000000)}d.addLayer(h)}this.setOpacity(0.3);o._ignoreMove=false;o.fire("spiderfied",{cluster:this,markers:g})},_animationUnspiderfy:function(){this._noanimationUnspiderfy()}});L.MarkerCluster.include({_animationSpiderfy:function(l,o){var s=this,v=this._group,g=v._map,d=v._featureGroup,j=this._latlng,q=g.latLngToLayerPoint(j),p=L.Path.SVG,f=L.extend({},this._group.options.spiderLegPolylineOptions),h=f.opacity,n,k,u,e,t,r;if(h===c){h=L.MarkerClusterGroup.prototype.options.spiderLegPolylineOptions.opacity}if(p){f.opacity=0;f.className=(f.className||"")+" leaflet-cluster-spider-leg"}else{f.opacity=h}v._ignoreMove=true;for(n=0;n<l.length;n++){k=l[n];r=g.layerPointToLatLng(o[n]);u=new L.Polyline([j,r],f);g.addLayer(u);k._spiderLeg=u;if(p){e=u._path;t=e.getTotalLength()+0.1;e.style.strokeDasharray=t;e.style.strokeDashoffset=t}if(k.setZIndexOffset){k.setZIndexOffset(1000000)}if(k.clusterHide){k.clusterHide()}d.addLayer(k);if(k._setPos){k._setPos(q)}}v._forceLayout();v._animationStart();for(n=l.length-1;n>=0;n--){r=g.layerPointToLatLng(o[n]);k=l[n];k._preSpiderfyLatlng=k._latlng;k.setLatLng(r);if(k.clusterShow){k.clusterShow()}if(p){u=k._spiderLeg;e=u._path;e.style.strokeDashoffset=0;u.setStyle({opacity:h})}}this.setOpacity(0.3);v._ignoreMove=false;setTimeout(function(){v._animationEnd();v.fire("spiderfied",{cluster:s,markers:l})},200)},_animationUnspiderfy:function(s){var o=this,r=this._group,f=r._map,d=r._featureGroup,n=s?f._latLngToNewLayerPoint(this._latlng,s.zoom,s.center):f.latLngToLayerPoint(this._latlng),h=this.getAllChildMarkers(),l=L.Path.SVG,g,k,q,e,p,j;r._ignoreMove=true;r._animationStart();this.setOpacity(1);for(k=h.length-1;k>=0;k--){g=h[k];if(!g._preSpiderfyLatlng){continue}g.setLatLng(g._preSpiderfyLatlng);delete g._preSpiderfyLatlng;j=true;if(g._setPos){g._setPos(n);j=false}if(g.clusterHide){g.clusterHide();j=false}if(j){d.removeLayer(g)}if(l){q=g._spiderLeg;e=q._path;p=e.getTotalLength()+0.1;e.style.strokeDashoffset=p;q.setStyle({opacity:0})}}r._ignoreMove=false;setTimeout(function(){var i=0;for(k=h.length-1;k>=0;k--){g=h[k];if(g._spiderLeg){i++}}for(k=h.length-1;k>=0;k--){g=h[k];if(!g._spiderLeg){continue}if(g.clusterShow){g.clusterShow()}if(g.setZIndexOffset){g.setZIndexOffset(0)}if(i>1){d.removeLayer(g)}f.removeLayer(g._spiderLeg);delete g._spiderLeg}r._animationEnd();r.fire("unspiderfied",{cluster:o,markers:h})},200)}});L.MarkerClusterGroup.include({_spiderfied:null,unspiderfy:function(){this._unspiderfy.apply(this,arguments)},_spiderfierOnAdd:function(){this._map.on("click",this._unspiderfyWrapper,this);if(this._map.options.zoomAnimation){this._map.on("zoomstart",this._unspiderfyZoomStart,this)}this._map.on("zoomend",this._noanimationUnspiderfy,this);if(!L.Browser.touch){this._map.getRenderer(this)}},_spiderfierOnRemove:function(){this._map.off("click",this._unspiderfyWrapper,this);this._map.off("zoomstart",this._unspiderfyZoomStart,this);this._map.off("zoomanim",this._unspiderfyZoomAnim,this);this._map.off("zoomend",this._noanimationUnspiderfy,this);this._noanimationUnspiderfy()},_unspiderfyZoomStart:function(){if(!this._map){return}this._map.on("zoomanim",this._unspiderfyZoomAnim,this)},_unspiderfyZoomAnim:function(d){if(L.DomUtil.hasClass(this._map._mapPane,"leaflet-touching")){return}this._map.off("zoomanim",this._unspiderfyZoomAnim,this);this._unspiderfy(d)},_unspiderfyWrapper:function(){this._unspiderfy()},_unspiderfy:function(d){if(this._spiderfied){this._spiderfied.unspiderfy(d)}},_noanimationUnspiderfy:function(){if(this._spiderfied){this._spiderfied._noanimationUnspiderfy()}},_unspiderfyLayer:function(d){if(d._spiderLeg){this._featureGroup.removeLayer(d);if(d.clusterShow){d.clusterShow()}if(d.setZIndexOffset){d.setZIndexOffset(0)}this._map.removeLayer(d._spiderLeg);delete d._spiderLeg}}});L.MarkerClusterGroup.include({refreshClusters:function(d){if(!d){d=this._topClusterLevel.getAllChildMarkers()}else{if(d instanceof L.MarkerClusterGroup){d=d._topClusterLevel.getAllChildMarkers()}else{if(d instanceof L.LayerGroup){d=d._layers}else{if(d instanceof L.MarkerCluster){d=d.getAllChildMarkers()}else{if(d instanceof L.Marker){d=[d]}}}}}this._flagParentsIconsNeedUpdate(d);this._refreshClustersIcons();if(this.options.singleMarkerMode){this._refreshSingleMarkerModeMarkers(d)}return this},_flagParentsIconsNeedUpdate:function(e){var f,d;for(f in e){d=e[f].__parent;while(d){d._iconNeedsUpdate=true;d=d.__parent}}},_refreshClustersIcons:function(){this._featureGroup.eachLayer(function(d){if(d instanceof L.MarkerCluster&&d._iconNeedsUpdate){d._updateIcon()}})},_refreshSingleMarkerModeMarkers:function(e){var f,d;for(f in e){d=e[f];if(this.hasLayer(d)){d.setIcon(this._overrideMarkerIcon(d))}}}});L.Marker.include({refreshIconOptions:function(e,d){var f=this.options.icon;L.setOptions(f,e);this.setIcon(f);if(d&&this.__parent){this.__parent._group.refreshClusters(this)}return this}})}(window,document));L.NonTiledLayer=L.Layer.extend({includes:L.Mixin.Events,options:{attribution:"",opacity:1,zIndex:undefined,minZoom:0,maxZoom:18,pointerEvents:null,errorImageUrl:"data:image/gif;base64,R0lGODlhAQABAHAAACH5BAUAAAAALAAAAAABAAEAAAICRAEAOw==",bounds:L.latLngBounds([-85.05,-180],[85.05,180])},url:"",initialize:function(a){L.setOptions(this,a)},onAdd:function(a){this._map=a;if(!this._div){this._div=L.DomUtil.create("div","leaflet-image-layer");if(this.options.pointerEvents){this._div.style["pointer-events"]=this.options.pointerEvents}if(this.options.zIndex!==undefined){this._div.style.zIndex=this.options.zIndex}if(this.options.opacity!==undefined){this._div.style.opacity=this.options.opacity}}this.getPane().appendChild(this._div);this._bufferImage=this._initImage();this._currentImage=this._initImage();this._update()},onRemove:function(a){this.getPane().removeChild(this._div);this._div.removeChild(this._bufferImage);this._div.removeChild(this._currentImage)},addTo:function(a){a.addLayer(this);return this},getEvents:function(){var a={moveend:this._update,zoom:this._viewreset};if(this._zoomAnimated){a.zoomanim=this._animateZoom}return a},getElement:function(){return this._div},setOpacity:function(a){this.options.opacity=a;if(this._div){L.DomUtil.setOpacity(this._div,this.options.opacity)}return this},setZIndex:function(a){if(a){this.options.zIndex=a;if(this._div){this._div.style.zIndex=a}}return this},bringToFront:function(){if(this._div){this._pane.appendChild(this._div)}return this},bringToBack:function(){if(this._div){this._pane.insertBefore(this._div,this._pane.firstChild)}return this},getAttribution:function(){return this.options.attribution},_initImage:function(a){var a=L.DomUtil.create("img","leaflet-image-layer");this._div.appendChild(a);if(this._map.options.zoomAnimation&&L.Browser.any3d){L.DomUtil.addClass(a,"leaflet-zoom-animated")}else{L.DomUtil.addClass(a,"leaflet-zoom-hide")}L.extend(a,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.bind(this._onImageLoad,this),onerror:L.bind(this._onImageError,this)});return a},redraw:function(){if(this._map){this._update()}return this},_animateZoom:function(a){if(this._currentImage._bounds){this._animateImage(this._currentImage,a)}if(this._bufferImage._bounds){this._animateImage(this._bufferImage,a)}},_animateImage:function(b,a){var d=this._map.getZoomScale(a.zoom),c=this._map._latLngToNewLayerPoint(b._bounds.getNorthWest(),a.zoom,a.center);L.DomUtil.setTransform(b,c,d)},_resetImage:function(c){var b=new L.Bounds(this._map.latLngToLayerPoint(c._bounds.getNorthWest()),this._map.latLngToLayerPoint(c._bounds.getSouthEast())),a=b.getSize();L.DomUtil.setPosition(c,b.min);c.style.width=a.x+"px";c.style.height=a.y+"px"},_getClippedBounds:function(){var b=this._map.getBounds();var k=b.getSouth();var f=b.getNorth();var i=b.getWest();var d=b.getEast();var c=this.options.bounds.getSouth();var a=this.options.bounds.getNorth();var j=this.options.bounds.getWest();var h=this.options.bounds.getEast();if(k<c){k=c}if(f>a){f=a}if(i<j){i=j}if(d>h){d=h}var g=new L.LatLng(f,i);var e=new L.LatLng(k,d);return new L.LatLngBounds(g,e)},_viewreset:function(){if(this._bufferImage._bounds){this._resetImage(this._bufferImage)}if(this._currentImage._bounds){this._resetImage(this._currentImage)}},_update:function(){if(this._map.getZoom()<this.options.minZoom||this._map.getZoom()>this.options.maxZoom){this._div.style.visibility="hidden";return}else{this._div.style.visibility="visible"}if(this._bufferImage._bounds){this._resetImage(this._bufferImage)}var f=this._getClippedBounds();var e=this._map.latLngToContainerPoint(f.getNorthWest());var d=this._map.latLngToContainerPoint(f.getSouthEast());var c=d.x-e.x;var a=d.y-e.y;if(c<32||a<32){return}this._currentImage._bounds=f;this._resetImage(this._currentImage);var b=this._currentImage;if(this.getImageUrl){b.src=this.getImageUrl(f.getNorthWest(),f.getSouthEast(),c,a)}else{this.getImageUrlAsync(f.getNorthWest(),f.getSouthEast(),c,a,function(h,g){b.src=h;b.tag=g})}this.url=b.src;L.DomUtil.setOpacity(this._currentImage,0)},_onImageError:function(a){this.fire("error",a);L.DomUtil.addClass(a.target,"invalid");if(a.target.src!==this.options.errorImageUrl){a.target.src=this.options.errorImageUrl;this._onImageDone(false,a)}},_onImageLoad:function(a){if(a.target.src!==this.options.errorImageUrl){L.DomUtil.removeClass(a.target,"invalid");if(a.target.src!==this.url){return}this._onImageDone(true,a)}},_onImageDone:function(c,b){L.DomUtil.setOpacity(this._currentImage,1);L.DomUtil.setOpacity(this._bufferImage,0);if(this._addInteraction){this._addInteraction(this._currentImage.tag)}var a=this._bufferImage;this._bufferImage=this._currentImage;this._currentImage=a;this.fire("load",b)}});L.nonTiledLayer=function(){return new L.NonTiledLayer()};L.NonTiledLayer.WMS=L.NonTiledLayer.extend({defaultWmsParams:{service:"WMS",request:"GetMap",version:"1.1.1",layers:"",styles:"",format:"image/jpeg",transparent:false},options:{crs:null,uppercase:false},initialize:function(c,b){this._wmsUrl=c;var a=L.extend({},this.defaultWmsParams);for(var d in b){if(!L.NonTiledLayer.prototype.options.hasOwnProperty(d)&&!L.Layer.prototype.options.hasOwnProperty(d)){a[d]=b[d]}}this.wmsParams=a;L.setOptions(this,b)},onAdd:function(a){this._crs=this.options.crs||a.options.crs;this._wmsVersion=parseFloat(this.wmsParams.version);var b=this._wmsVersion>=1.3?"crs":"srs";this.wmsParams[b]=this._crs.code;L.NonTiledLayer.prototype.onAdd.call(this,a)},getImageUrl:function(f,e,b,i){var g=this.wmsParams;g.width=b;g.height=i;var c=this._crs.project(f);var d=this._crs.project(e);var a=this._wmsUrl;var h=h=(this._wmsVersion>=1.3&&this._crs===L.CRS.EPSG4326?[d.y,c.x,c.y,d.x]:[c.x,d.y,d.x,c.y]).join(",");return a+L.Util.getParamString(this.wmsParams,a,this.options.uppercase)+(this.options.uppercase?"&BBOX=":"&bbox=")+h},setParams:function(b,a){L.extend(this.wmsParams,b);if(!a){this.redraw()}return this}});L.nonTiledLayer.wms=function(b,a){return new L.NonTiledLayer.WMS(b,a)};GV.Util=function(){return{getUrlParam:function(b){var a=new RegExp("[\\?&]"+b+"=([^&#]*)").exec(window.location.href);GV.Util.log("GV.Util.getUrlParam");return a?decodeURIComponent(a[1]):null},getUrlParamFromString:function(a,c){var b=new RegExp("[\\?&]"+c+"=([^&#]*)").exec(a);if(!b){return 0}return b[1]||0},log:function(a,d){var b="log";if(!GV.debug){return}switch(d){case 0:b="warn";break;case 1:case 2:b="error";break;default:b="info";break}try{console[b](a)}catch(c){}},msgBox:function(a){window.alert(a)},setUnderscoreTemplate:function(){if(_){_.templateSettings={interpolate:/\{\{(.+?)\}\}/g}}},ajax:function(b,c){var a={jsonpCallback:"getJson",type:"GET"};GV.Util.log("GV.Util.ajax");$.ajax(_.extend(a,b)).done(function(e){try{if(c){c(e)}}catch(d){console.error(d.message)}}).fail(function(d,f,e){if(d.statusText!=="OK"){console.error("GV.Util.ajax - Non sono riuscito a caricare la url:\n"+url+"\nErrore: "+d.status+" - "+f+" - "+e)}})},parseXML:function(c){GV.Util.log("GV.Util.parseXML");try{var b=null;if(window.DOMParser&&window.XSLTProcessor){var d=new DOMParser();b=d.parseFromString(c,"text/xml")}else{b=new ActiveXObject("Msxml2.DOMDocument.3.0");b.async=false;b.loadXML(c)}return b}catch(a){throw {name:"xmlTransformation",message:"GV.Util.parseXml: errore parsing xml - "+a.message,level:1}}},isPointInLig:function(b,f){GV.Util.log("GV.Util.isPointInLig");if(!b||!f){return false}var a=7.4,e=43.7,d=10.1,c=44.8;return(b>a)&&(b<d)&&(f>e)&&(f<c)},toArray:function(a){return Array.prototype.slice.call(a)},bind:function(b,a){return function(){return a.apply(b,GV.Util.toArray(arguments))}},getArrayElementByAttribute:function(e,c,d){if(!e){return null}var b,a=e.length;for(b=0;b<a;b++){if(e[b][c]===d){return e[b]}}return null},geoCode:function(a,b,d){var c=new google.maps.Geocoder();c.geocode({address:a},function(h,f){if(f===google.maps.GeocoderStatus.OK){var e=h[0].geometry.location.lng();var j=h[0].geometry.location.lat();var g={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Point",coordinates:[e,j]},properties:{address:a}}]};if(b){for(var i in b){if(b.hasOwnProperty(i)){g.features[0].properties[i]=b[i]}}}d(g)}else{if(f===google.maps.GeocoderStatus.ZERO_RESULTS){GV.Util.msgBox("Indirizzo '"+a+"' non trovato")}else{console.error("Errore di geocoding: "+f)}}})},getParamString:function(d,a,b){var e=[];for(var c in d){e.push(encodeURIComponent(b?c.toUpperCase():c)+"="+encodeURIComponent(d[c]))}return((!a||a.indexOf("?")===-1)?"?":"&")+e.join("&")},template:function(b,a){var c=/\{ *([\w_\-]+) *\}/g;return b.replace(c,function(f,d){var e=a[d];if(e===undefined){throw new Error("No value provided for variable "+f)}else{if(typeof e==="function"){e=e(a)}}return e})},getZoomFromScaleDenom:function(a){return _.findIndex(GV.Globals.BASE_SCALES,function(b){return a>b})},getScaleLabelsFromZoom:function(a){return GV.Globals.BASE_SCALE_LABELS[a]},getScaleFromZoom:function(a){return GV.Globals.BASE_SCALES[a]}}}();GV.Buttons.baselayers=function(a,b){if(L.Browser.touch){return null}return L.control.baseLayersSwitcher(b.baseLayers,[],{position:a.position}).addTo(b)};GV.Buttons.fullscreen=function(a,b){return L.control.fullscreen(a)};GV.Buttons.geocoder=function(a,b){return new L.Control.Geocoder(a)};GV.Buttons.locate=function(a,b){return new L.Control.Locate(a)};GV.Buttons.navbar=function(a,b){if(L.Browser.touch){return null}return L.control.navbar(a)};GV.Buttons.print=function(a,b){if(L.Browser.touch){return null}return L.easyButton({position:a.position,leafletClasses:true,states:[{stateName:"print",onClick:function(c,d){console.log("print")},title:"Zoom alla estensione iniziale",icon:"fa-print"}]})};GV.Buttons.zoom=function(a,b){if(L.Browser.touch){return null}return L.control.zoom(a)};L.Control.BaseLayersSwitcher=L.Control.extend({options:{collapsed:true,position:"topright",autoZIndex:true,hideSingleBase:false},initialize:function(d,c,a){L.setOptions(this,a);this._layers=[];this._lastZIndex=0;this._handlingClick=false;for(var b in d){this._addLayer(d[b],b)}for(b in c){this._addLayer(c[b],b,true)}},onAdd:function(a){this._initLayout();this._update();this._map=a;a.on("zoomend",this._checkDisabledLayers,this);return this._container},onRemove:function(){this._map.off("zoomend",this._checkDisabledLayers,this);for(var a=0;a<this._layers.length;a++){this._layers[a].layer.off("add remove",this._onLayerChange,this)}},addBaseLayer:function(b,a){this._addLayer(b,a);return(this._map)?this._update():this},addOverlay:function(b,a){this._addLayer(b,a,true);return(this._map)?this._update():this},removeLayer:function(a){a.off("add remove",this._onLayerChange,this);var b=this._getLayer(L.stamp(a));if(b){this._layers.splice(this._layers.indexOf(b),1)}return(this._map)?this._update():this},expand:function(){L.DomUtil.addClass(this._container,"leaflet-control-layers-expanded");this._form.style.height=null;var a=this._map.getSize().y-(this._container.offsetTop+50);if(a<this._form.clientHeight){L.DomUtil.addClass(this._form,"leaflet-control-layers-scrollbar");this._form.style.height=a+"px"}else{L.DomUtil.removeClass(this._form,"leaflet-control-layers-scrollbar")}this._checkDisabledLayers();return this},collapse:function(){L.DomUtil.removeClass(this._container,"leaflet-control-layers-expanded");return this},_initLayout:function(){var b="leaflet-control-layers",a=this._container=L.DomUtil.create("div",b);a.setAttribute("aria-haspopup",true);L.DomEvent.disableClickPropagation(a);if(!L.Browser.touch){L.DomEvent.disableScrollPropagation(a)}var d=this._form=L.DomUtil.create("form",b+"-list");if(this.options.collapsed){if(!L.Browser.android){L.DomEvent.on(a,{mouseenter:this.expand,mouseleave:this.collapse},this)}var c=this._layersLink=L.DomUtil.create("a","ms ms-globe "+b+"-toggle",a);c.href="#";c.title="Layers";if(L.Browser.touch){L.DomEvent.on(c,"click",L.DomEvent.stop).on(c,"click",this.expand,this)}else{L.DomEvent.on(c,"focus",this.expand,this)}L.DomEvent.on(d,"click",function(){setTimeout(L.bind(this._onInputClick,this),0)},this);this._map.on("click",this.collapse,this)}else{this.expand()}this._baseLayersList=L.DomUtil.create("div",b+"-base",d);this._separator=L.DomUtil.create("div",b+"-separator",d);this._overlaysList=L.DomUtil.create("div",b+"-overlays",d);a.appendChild(d)},_getLayer:function(b){for(var a=0;a<this._layers.length;a++){if(this._layers[a]&&L.stamp(this._layers[a].layer)===b){return this._layers[a]}}},_addLayer:function(c,b,a){c.on("add remove",this._onLayerChange,this);this._layers.push({layer:c,name:b,overlay:a});if(this.options.autoZIndex&&c.setZIndex){this._lastZIndex++;c.setZIndex(this._lastZIndex)}},_update:function(){if(!this._container){return this}L.DomUtil.empty(this._baseLayersList);L.DomUtil.empty(this._overlaysList);var a,d,c,e,b=0;for(c=0;c<this._layers.length;c++){e=this._layers[c];this._addItem(e);d=d||e.overlay;a=a||!e.overlay;b+=!e.overlay?1:0}if(this.options.hideSingleBase){a=a&&b>1;this._baseLayersList.style.display=a?"":"none"}this._separator.style.display=d&&a?"":"none";return this},_onLayerChange:function(c){if(!this._handlingClick){this._update()}var b=this._getLayer(L.stamp(c.target));var a=b.overlay?(c.type==="add"?"overlayadd":"overlayremove"):(c.type==="add"?"baselayerchange":null);if(a){this._map.fire(a,b)}},_createRadioElement:function(a,d){var c='<input type="radio" class="leaflet-control-layers-selector" name="'+a+'"'+(d?' checked="checked"':"")+"/>";var b=document.createElement("div");b.innerHTML=c;return b.firstChild},_addItem:function(g){var d=document.createElement("label"),f=this._map.hasLayer(g.layer),b;if(g.overlay){b=document.createElement("input");b.type="checkbox";b.className="leaflet-control-layers-selector";b.defaultChecked=f}else{b=this._createRadioElement("leaflet-base-layers",f)}b.layerId=L.stamp(g.layer);L.DomEvent.on(b,"click",this._onInputClick,this);var c=document.createElement("span");c.innerHTML="&nbsp;&nbsp"+g.name;var e=document.createElement("div");d.appendChild(e);e.appendChild(b);e.appendChild(c);var a=g.overlay?this._overlaysList:this._baseLayersList;a.appendChild(d);this._checkDisabledLayers();return d},_onInputClick:function(){var b=this._form.getElementsByTagName("input"),c,g,a;var e=[],d=[];this._handlingClick=true;for(var f=b.length-1;f>=0;f--){c=b[f];g=this._getLayer(c.layerId).layer;a=this._map.hasLayer(g);if(c.checked&&!a){e.push(g)}else{if(!c.checked&&a){d.push(g)}}}for(f=0;f<d.length;f++){this._map.removeLayer(d[f])}for(f=0;f<e.length;f++){this._map.addLayer(e[f])}this._handlingClick=false;this._refocusOnMap()},_checkDisabledLayers:function(){var a=this._form.getElementsByTagName("input"),b,d,e=this._map.getZoom();for(var c=a.length-1;c>=0;c--){b=a[c];d=this._getLayer(b.layerId).layer;b.disabled=(d.options.minZoom!==undefined&&e<d.options.minZoom)||(d.options.maxZoom!==undefined&&e>d.options.maxZoom)}},_expand:function(){return this.expand()},_collapse:function(){return this.collapse()}});L.control.baseLayersSwitcher=function(c,b,a){return new L.Control.BaseLayersSwitcher(c,b,a)};(function(){L.Control.EasyBar=L.Control.extend({options:{position:"topleft",id:null,leafletClasses:true},initialize:function(e,c){if(c){L.Util.setOptions(this,c)}this._buildContainer();this._buttons=[];for(var d=0;d<e.length;d++){e[d]._bar=this;e[d]._container=e[d].button;this._buttons.push(e[d]);this.container.appendChild(e[d].button)}},_buildContainer:function(){this._container=this.container=L.DomUtil.create("div","");this.options.leafletClasses&&L.DomUtil.addClass(this.container,"leaflet-bar easy-button-container leaflet-control");this.options.id&&(this.container.id=this.options.id)},enable:function(){L.DomUtil.addClass(this.container,"enabled");L.DomUtil.removeClass(this.container,"disabled");this.container.setAttribute("aria-hidden","false");return this},disable:function(){L.DomUtil.addClass(this.container,"disabled");L.DomUtil.removeClass(this.container,"enabled");this.container.setAttribute("aria-hidden","true");return this},onAdd:function(){return this.container},addTo:function(f){this._map=f;for(var d=0;d<this._buttons.length;d++){this._buttons[d]._map=f}var c=this._container=this.onAdd(f),g=this.getPosition(),e=f._controlCorners[g];L.DomUtil.addClass(c,"leaflet-control");if(g.indexOf("bottom")!==-1){e.insertBefore(c,e.firstChild)}else{e.appendChild(c)}return this}});L.easyBar=function(){var c=[L.Control.EasyBar];for(var d=0;d<arguments.length;d++){c.push(arguments[d])}return new (Function.prototype.bind.apply(L.Control.EasyBar,c))};L.Control.EasyButton=L.Control.extend({options:{position:"topleft",id:null,type:"replace",states:[],leafletClasses:true,tagName:"button"},initialize:function(d,f,e,g){this.options.states=[];if(g!=null){this.options.id=g}this.storage={};if(typeof arguments[arguments.length-1]==="object"){L.Util.setOptions(this,arguments[arguments.length-1])}if(this.options.states.length===0&&typeof d==="string"&&typeof f==="function"){this.options.states.push({icon:d,onClick:f,title:typeof e==="string"?e:""})}this._states=[];for(var c=0;c<this.options.states.length;c++){this._states.push(new b(this.options.states[c],this))}this._buildButton();this._activateState(this._states[0])},_buildButton:function(){this.button=L.DomUtil.create(this.options.tagName,"");if(this.tagName==="button"){this.button.type="button"}if(this.options.id){this.button.id=this.options.id}if(this.options.leafletClasses){L.DomUtil.addClass(this.button,"leaflet-bar-part leaflet-interactive easy-button gv-bgcolor")}L.DomEvent.addListener(this.button,"dblclick",L.DomEvent.stop);L.DomEvent.addListener(this.button,"mousedown",L.DomEvent.stop);L.DomEvent.addListener(this.button,"click",function(d){L.DomEvent.stop(d);this._currentState.onClick(this,this._map?this._map:null);this._map.getContainer().focus()},this);if(this.options.type=="replace"){this.button.appendChild(this._currentState.icon)}else{for(var c=0;c<this._states.length;c++){this.button.appendChild(this._states[c].icon)}}},_currentState:{stateName:"unnamed",icon:(function(){return document.createElement("span")})()},_states:null,state:function(c){if(typeof c=="string"){this._activateStateNamed(c)}else{if(typeof c=="number"){this._activateState(this._states[c])}}return this},_activateStateNamed:function(d){for(var c=0;c<this._states.length;c++){if(this._states[c].stateName==d){this._activateState(this._states[c])}}},_activateState:function(d){if(d===this._currentState){return}else{if(this.options.type=="replace"){this.button.appendChild(d.icon);this.button.removeChild(this._currentState.icon)}if(d.title){this.button.title=d.title}else{this.button.removeAttribute("title")}for(var c=0;c<this._states.length;c++){L.DomUtil.removeClass(this._states[c].icon,this._currentState.stateName+"-active");L.DomUtil.addClass(this._states[c].icon,d.stateName+"-active")}L.DomUtil.removeClass(this.button,this._currentState.stateName+"-active");L.DomUtil.addClass(this.button,d.stateName+"-active");this._currentState=d}},enable:function(){L.DomUtil.addClass(this.button,"enabled");L.DomUtil.removeClass(this.button,"disabled");this.button.setAttribute("aria-hidden","false");return this},disable:function(){L.DomUtil.addClass(this.button,"disabled");L.DomUtil.removeClass(this.button,"enabled");this.button.setAttribute("aria-hidden","true");return this},removeFrom:function(c){this._container.parentNode.removeChild(this._container);this._map=null;return this},onAdd:function(){var c=L.easyBar([this],{position:this.options.position,leafletClasses:this.options.leafletClasses});this._container=c.container;return this._container}});L.easyButton=function(){var c=Array.prototype.concat.apply([L.Control.EasyButton],arguments);return new (Function.prototype.bind.apply(L.Control.EasyButton,c))};function b(c,d){this.title=c.title;this.stateName=c.stateName?c.stateName:"unnamed-state";this.icon=L.DomUtil.create("span","");L.DomUtil.addClass(this.icon,"button-state state-"+this.stateName.replace(/(^\s*|\s*$)/g,""));this.icon.innerHTML=a(c.icon);this.onClick=L.Util.bind(c.onClick?c.onClick:function(){},d)}function a(d){var c;if(d.match(/[&;=<>"']/)){c=d}else{d=d.replace(/(^\s*|\s*$)/g,"");c=L.DomUtil.create("span","");if(d.indexOf("fa-")===0){L.DomUtil.addClass(c,"fa "+d)}else{if(d.indexOf("glyphicon-")===0){L.DomUtil.addClass(c,"glyphicon "+d)}else{L.DomUtil.addClass(c,d)}}c=c.outerHTML}return c}})();L.Control.Fullscreen=L.Control.extend({options:{position:"topleft",title:{"false":"Schermo intero","true":"Esci da Schermo intero"}},onAdd:function(b){var a=L.DomUtil.create("div","leaflet-control-fullscreen leaflet-bar leaflet-control");this.link=L.DomUtil.create("a","ms ms-max-extent",a);this.link.href="#";this._map=b;this._map.on("fullscreenchange",this._toggleTitle,this);this._toggleTitle();L.DomEvent.on(this.link,"click",this._click,this);return a},_click:function(a){L.DomEvent.stopPropagation(a);L.DomEvent.preventDefault(a);this._map.toggleFullscreen(this.options)},_toggleTitle:function(){this.link.title=this.options.title[this._map.isFullscreen()]}});L.Map.include({isFullscreen:function(){return this._isFullscreen||false},toggleFullscreen:function(b){var a=this.getContainer();if(this.isFullscreen()){if(b&&b.pseudoFullscreen){this._disablePseudoFullscreen(a)}else{if(document.exitFullscreen){document.exitFullscreen()}else{if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else{if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}else{if(document.msExitFullscreen){document.msExitFullscreen()}else{this._disablePseudoFullscreen(a)}}}}}}else{if(b&&b.pseudoFullscreen){this._enablePseudoFullscreen(a)}else{if(a.requestFullscreen){a.requestFullscreen()}else{if(a.mozRequestFullScreen){a.mozRequestFullScreen()}else{if(a.webkitRequestFullscreen){a.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}else{if(a.msRequestFullscreen){a.msRequestFullscreen()}else{this._enablePseudoFullscreen(a)}}}}}}},_enablePseudoFullscreen:function(a){L.DomUtil.addClass(a,"leaflet-pseudo-fullscreen");this._setFullscreen(true);this.invalidateSize();this.fire("fullscreenchange")},_disablePseudoFullscreen:function(a){L.DomUtil.removeClass(a,"leaflet-pseudo-fullscreen");this._setFullscreen(false);this.invalidateSize();this.fire("fullscreenchange")},_setFullscreen:function(b){this._isFullscreen=b;var a=this.getContainer();if(b){L.DomUtil.addClass(a,"leaflet-fullscreen-on")}else{L.DomUtil.removeClass(a,"leaflet-fullscreen-on")}},_onFullscreenChange:function(b){var a=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement;if(a===this.getContainer()&&!this._isFullscreen){this._setFullscreen(true);this.fire("fullscreenchange")}else{if(a!==this.getContainer()&&this._isFullscreen){this._setFullscreen(false);this.fire("fullscreenchange")}}}});L.Map.mergeOptions({fullscreenControl:false});L.Map.addInitHook(function(){if(this.options.fullscreenControl){this.fullscreenControl=new L.Control.Fullscreen(this.options.fullscreenControl);this.addControl(this.fullscreenControl)}var b;if("onfullscreenchange" in document){b="fullscreenchange"}else{if("onmozfullscreenchange" in document){b="mozfullscreenchange"}else{if("onwebkitfullscreenchange" in document){b="webkitfullscreenchange"}else{if("onmsfullscreenchange" in document){b="MSFullscreenChange"}}}}if(b){var a=L.bind(this._onFullscreenChange,this);this.whenReady(function(){L.DomEvent.on(document,b,a)});this.on("unload",function(){L.DomEvent.off(document,b,a)})}});L.control.fullscreen=function(a){return new L.Control.Fullscreen(a)};(function(){L.Control.Geocoder=L.Control.extend({options:{showResultIcons:false,collapsed:true,expand:"click",position:"topright",placeholder:"Ricerca Indirizzo...",errorMessage:"Non trovato."},_callbackId:0,initialize:function(a){L.Util.setOptions(this,a);if(!this.options.geocoder){this.options.geocoder=new L.Control.Geocoder.Nominatim()}},onAdd:function(f){var d="leaflet-control-geocoder",a=L.DomUtil.create("div",d+" leaflet-bar"),c=L.DomUtil.create("a","ms ms-zoom",a),e=this._form=L.DomUtil.create("form",d+"-form",a),b;c.innerHTML="";c.href="javascript:void(0);";this._map=f;this._container=a;b=this._input=L.DomUtil.create("input");b.type="text";b.placeholder=this.options.placeholder;L.DomEvent.addListener(b,"keydown",this._keydown,this);this._errorElement=document.createElement("div");this._errorElement.className=d+"-form-no-error";this._errorElement.innerHTML=this.options.errorMessage;this._alts=L.DomUtil.create("ul",d+"-alternatives leaflet-control-geocoder-alternatives-minimized");e.appendChild(b);this._container.appendChild(this._errorElement);a.appendChild(this._alts);L.DomEvent.addListener(e,"submit",this._geocode,this);if(this.options.collapsed){if(this.options.expand==="click"){L.DomEvent.addListener(c,"click",function(g){if(g.button===0&&g.detail!==2){this._toggle()}},this)}else{L.DomEvent.addListener(c,"mouseover",this._expand,this);L.DomEvent.addListener(c,"mouseout",this._collapse,this);this._map.on("movestart",this._collapse,this)}}else{L.DomEvent.addListener(c,"click",function(g){this._geocode(g)},this);this._expand()}L.DomEvent.disableClickPropagation(a);return a},_geocodeResult:function(b){L.DomUtil.removeClass(this._container,"leaflet-control-geocoder-throbber");if(b.length===1){this._geocodeResultSelected(b[0])}else{if(b.length>0){this._alts.innerHTML="";this._results=b;L.DomUtil.removeClass(this._alts,"leaflet-control-geocoder-alternatives-minimized");for(var a=0;a<b.length;a++){this._alts.appendChild(this._createAlt(b[a],a))}}else{L.DomUtil.addClass(this._errorElement,"leaflet-control-geocoder-error")}}},markGeocode:function(a){this._map.fitBounds(a.bbox);this._map.setZoom(16);if(this._geocodeMarker){this._map.removeLayer(this._geocodeMarker)}this._geocodeMarker=new L.Marker(a.center).bindPopup(a.html||a.name).addTo(this._map).openPopup();return this},_geocode:function(a){L.DomEvent.preventDefault(a);L.DomUtil.addClass(this._container,"leaflet-control-geocoder-throbber");this._clearResults();this.options.geocoder.geocode(this._input.value,this._geocodeResult,this);return false},_geocodeResultSelected:function(a){if(this.options.collapsed){this._collapse()}else{this._clearResults()}this.markGeocode(a)},_toggle:function(){if(this._container.className.indexOf("leaflet-control-geocoder-expanded")>=0){this._collapse()}else{this._expand()}},_expand:function(){L.DomUtil.addClass(this._container,"leaflet-control-geocoder-expanded");this._input.select()},_collapse:function(){this._container.className=this._container.className.replace(" leaflet-control-geocoder-expanded","");L.DomUtil.addClass(this._alts,"leaflet-control-geocoder-alternatives-minimized");L.DomUtil.removeClass(this._errorElement,"leaflet-control-geocoder-error")},_clearResults:function(){L.DomUtil.addClass(this._alts,"leaflet-control-geocoder-alternatives-minimized");this._selection=null;L.DomUtil.removeClass(this._errorElement,"leaflet-control-geocoder-error")},_createAlt:function(c,e){var b=L.DomUtil.create("li",""),d=L.DomUtil.create("a","",b),f=this.options.showResultIcons&&c.icon?L.DomUtil.create("img","",d):null,g=c.html?undefined:document.createTextNode(c.name),h=function h(a){L.DomEvent.preventDefault(a);this._geocodeResultSelected(c)};if(f){f.src=c.icon}b.setAttribute("data-result-index",e);if(c.html){d.innerHTML=c.html}else{d.appendChild(g)}L.DomEvent.addListener(b,"click",h,this);return b},_keydown:function(c){var d=this,a=function a(e){if(d._selection){L.DomUtil.removeClass(d._selection,"leaflet-control-geocoder-selected");d._selection=d._selection[e>0?"nextSibling":"previousSibling"]}if(!d._selection){d._selection=d._alts[e>0?"firstChild":"lastChild"]}if(d._selection){L.DomUtil.addClass(d._selection,"leaflet-control-geocoder-selected")}};switch(c.keyCode){case 27:if(this.options.collapsed){this._collapse()}break;case 38:a(-1);L.DomEvent.preventDefault(c);break;case 40:a(1);L.DomEvent.preventDefault(c);break;case 13:if(this._selection){var b=parseInt(this._selection.getAttribute("data-result-index"),10);this._geocodeResultSelected(this._results[b]);this._clearResults();L.DomEvent.preventDefault(c)}}return true}});L.Control.geocoder=function(a){return new L.Control.Geocoder(a)};L.Control.Geocoder.callbackId=0;L.Control.Geocoder.jsonp=function(b,f,g,c,d){var e="_l_geocoder_"+(L.Control.Geocoder.callbackId++);f[d||"callback"]=e;window[e]=L.Util.bind(g,c);var a=document.createElement("script");a.type="text/javascript";a.src=b+L.Util.getParamString(f);a.id=e;document.getElementsByTagName("head")[0].appendChild(a)};L.Control.Geocoder.getJSON=function(b,c,d){var a=new XMLHttpRequest();a.onreadystatechange=function(){if(a.readyState!=4){return}if(a.status!=200&&a.status!=304){d("");return}d(JSON.parse(a.response))};a.open("GET",b+L.Util.getParamString(c),true);a.setRequestHeader("Accept","application/json");a.send(null)};L.Control.Geocoder.template=function(c,a,b){return c.replace(/\{ *([\w_]+) *\}/g,function(f,d){var e=a[d];if(e===undefined){e=""}else{if(typeof e==="function"){e=e(a)}}return L.Control.Geocoder.htmlEscape(e)})};L.Control.Geocoder.htmlEscape=(function(){var d=/[&<>"'`]/g;var b=/[&<>"'`]/;var c={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"};function a(e){return c[e]}return function(e){if(e==null){return""}else{if(!e){return e+""}}e=""+e;if(!b.test(e)){return e}return e.replace(d,a)}})();L.Control.Geocoder.Nominatim=L.Class.extend({options:{serviceUrl:"//nominatim.openstreetmap.org/",geocodingQueryParams:{countrycodes:"it",viewbox:"7.49958,44.791951,10.06312,43.730645",bounded:1},reverseQueryParams:{},htmlTemplate:function(a){var b=a.display_name.replace("Genoa,","").replace("Italia","").replace("Liguria,","");return L.Control.Geocoder.template(b.split(",").join("<br/>"),a.address,true)}},initialize:function(a){L.Util.setOptions(this,a)},geocode:function(c,a,b){L.Control.Geocoder.jsonp(this.options.serviceUrl+"search/",L.extend({q:c+" Liguria",limit:10,format:"json",addressdetails:1},this.options.geocodingQueryParams),function(g){var f=[];for(var e=g.length-1;e>=0;e--){var h=g[e].boundingbox;for(var d=0;d<4;d++){h[d]=parseFloat(h[d])}f[e]={icon:g[e].icon,name:g[e].display_name,html:this.options.htmlTemplate?this.options.htmlTemplate(g[e]):undefined,bbox:L.latLngBounds([h[0],h[2]],[h[1],h[3]]),center:L.latLng(g[e].lat,g[e].lon),properties:g[e]}}a.call(b,f)},this,"json_callback")},reverse:function(b,d,a,c){L.Control.Geocoder.jsonp(this.options.serviceUrl+"reverse/",L.extend({lat:b.lat,lon:b.lng,zoom:Math.round(Math.log(d/256)/Math.log(2)),addressdetails:1,format:"json"},this.options.reverseQueryParams),function(f){var e=[],g;if(f&&f.lat&&f.lon){g=L.latLng(f.lat,f.lon);e.push({name:f.display_name,html:this.options.htmlTemplate?this.options.htmlTemplate(f):undefined,center:g,bounds:L.latLngBounds(g,g),properties:f})}a.call(c,e)},this,"json_callback")}});L.Control.Geocoder.Google=L.Class.extend({options:{service_url:"https://maps.googleapis.com/maps/api/geocode/json"},initialize:function(a){this._key=a},geocode:function(c,a,b){var d={address:c};if(this._key&&this._key.length){d.key=this._key}L.Control.Geocoder.getJSON(this.options.service_url,d,function(h){var f=[],k,g,j;if(h.results&&h.results.length){for(var e=0;e<=h.results.length-1;e++){k=h.results[e];g=L.latLng(k.geometry.location);j=L.latLngBounds(L.latLng(k.geometry.viewport.northeast),L.latLng(k.geometry.viewport.southwest));f[e]={name:k.formatted_address,bbox:j,center:g}}}a.call(b,f)})},reverse:function(b,e,a,c){var d={latlng:encodeURIComponent(b.lat)+","+encodeURIComponent(b.lng)};if(this._key&&this._key.length){d.key=this._key}L.Control.Geocoder.getJSON(this.options.service_url,d,function(j){var g=[],l,h,k;if(j.results&&j.results.length){for(var f=0;f<=j.results.length-1;f++){l=j.results[f];h=L.latLng(l.geometry.location);k=L.latLngBounds(L.latLng(l.geometry.viewport.northeast),L.latLng(l.geometry.viewport.southwest));g[f]={name:l.formatted_address,bbox:k,center:h}}}a.call(c,g)})}});return L.Control.Geocoder})();
/*
 Copyright (c) 2016 Dominik Moritz

 This file is part of the leaflet locate control. It is licensed under the MIT license.
 You can find the project at: https://github.com/domoritz/leaflet-locatecontrol
 */
(function(a,b){if(typeof define==="function"&&define.amd){define(["leaflet"],a)}else{if(typeof exports==="object"){if(typeof b!=="undefined"&&b.L){module.exports=a(L)}else{module.exports=a(require("leaflet"))}}}if(typeof b!=="undefined"&&b.L){b.L.Control.Locate=a(L)}}(function(a){var b=a.Control.extend({options:{position:"topleft",layer:undefined,setView:"untilPan",keepCurrentZoomLevel:false,clickBehavior:{inView:"stop",outOfView:"setView",},drawCircle:true,drawMarker:true,markerClass:a.CircleMarker,circleStyle:{color:"#136AEC",fillColor:"#136AEC",fillOpacity:0.15,weight:2,opacity:0.5},markerStyle:{color:"#136AEC",fillColor:"#2A93EE",fillOpacity:0.7,weight:2,opacity:0.9,radius:5},followCircleStyle:{},followMarkerStyle:{},icon:"fa fa-map-marker",iconLoading:"fa fa-spinner fa-spin",iconElementTag:"span",circlePadding:[0,0],metric:true,onLocationError:function(c,d){alert(c.message)},onLocationOutsideMapBounds:function(c){c.stop();alert(c.options.strings.outsideMapBoundsMsg)},showPopup:true,strings:{title:"Show me where I am",metersUnit:"meters",feetUnit:"feet",popup:"You are within {distance} {unit} from this point",outsideMapBoundsMsg:"You seem located outside the boundaries of the map"},locateOptions:{maxZoom:Infinity,watch:true,setView:false}},initialize:function(c){for(var d in c){if(typeof this.options[d]==="object"){a.extend(this.options[d],c[d])}else{this.options[d]=c[d]}}this.options.followMarkerStyle=a.extend({},this.options.markerStyle,this.options.followMarkerStyle);this.options.followCircleStyle=a.extend({},this.options.circleStyle,this.options.followCircleStyle)},onAdd:function(d){var c=a.DomUtil.create("div","leaflet-control-locate leaflet-bar leaflet-control");this._layer=this.options.layer||new a.LayerGroup();this._layer.addTo(d);this._event=undefined;this._link=a.DomUtil.create("a","leaflet-bar-part leaflet-bar-part-single",c);this._link.href="#";this._link.title=this.options.strings.title;this._icon=a.DomUtil.create(this.options.iconElementTag,this.options.icon,this._link);a.DomEvent.on(this._link,"click",a.DomEvent.stopPropagation).on(this._link,"click",a.DomEvent.preventDefault).on(this._link,"click",this._onClick,this).on(this._link,"dblclick",a.DomEvent.stopPropagation);this._resetVariables();this._map.on("unload",this._unload,this);return c},_onClick:function(){this._justClicked=true;this._userPanned=false;if(this._active&&!this._event){this.stop()}else{if(this._active&&this._event!==undefined){var c=this._map.getBounds().contains(this._event.latlng)?this.options.clickBehavior.inView:this.options.clickBehavior.outOfView;switch(c){case"setView":this.setView();break;case"stop":this.stop();break}}else{this.start()}}this._updateContainerStyle()},start:function(){this._activate();if(this._event){this._drawMarker(this._map);if(this.options.setView){this.setView()}}this._updateContainerStyle()},stop:function(){this._deactivate();this._cleanClasses();this._resetVariables();this._removeMarker()},_activate:function(){if(!this._active){this._map.locate(this.options.locateOptions);this._active=true;this._map.on("locationfound",this._onLocationFound,this);this._map.on("locationerror",this._onLocationError,this);this._map.on("dragstart",this._onDrag,this)}},_deactivate:function(){this._map.stopLocate();this._active=false;this._map.off("locationfound",this._onLocationFound,this);this._map.off("locationerror",this._onLocationError,this);this._map.off("dragstart",this._onDrag,this)},setView:function(){if(this._isOutsideMapBounds()){this.options.onLocationOutsideMapBounds(this)}else{if(this.options.keepCurrentZoomLevel){this._map.panTo([this._event.latitude,this._event.longitude])}else{this._map.fitBounds(this._event.bounds,{padding:this.options.circlePadding,maxZoom:this.options.locateOptions.maxZoom})}}this._drawMarker()},_drawMarker:function(){if(this._event.accuracy===undefined){this._event.accuracy=0}var c=this._event.accuracy;var i=this._event.latlng;if(this.options.drawCircle){var f=this._isFollowing()?this.options.followCircleStyle:this.options.circleStyle;if(!this._circle){this._circle=a.circle(i,c,f).addTo(this._layer)}else{this._circle.setLatLng(i).setRadius(c).setStyle(f)}}var h,g;if(this.options.metric){h=c.toFixed(0);g=this.options.strings.metersUnit}else{h=(c*3.2808399).toFixed(0);g=this.options.strings.feetUnit}if(this.options.drawMarker){var d=this._isFollowing()?this.options.followMarkerStyle:this.options.markerStyle;if(!this._marker){this._marker=new this.options.markerClass(i,d).addTo(this._layer)}else{this._marker.setLatLng(i).setStyle(d)}}var e=this.options.strings.popup;if(this.options.showPopup&&e&&this._marker){this._marker.bindPopup(a.Util.template(e,{distance:h,unit:g}))._popup.setLatLng(i)}},_removeMarker:function(){this._layer.clearLayers();this._marker=undefined;this._circle=undefined},_unload:function(){this.stop();this._map.off("unload",this._unload,this)},_onLocationError:function(c){if(c.code==3&&this.options.locateOptions.watch){return}this.stop();this.options.onLocationError(c,this)},_onLocationFound:function(c){if(this._event&&(this._event.latlng.lat===c.latlng.lat&&this._event.latlng.lng===c.latlng.lng&&this._event.accuracy===c.accuracy)){return}if(!this._active){return}this._event=c;this._drawMarker();this._updateContainerStyle();switch(this.options.setView){case"once":if(this._justClicked){this.setView()}break;case"untilPan":if(!this._userPanned){this.setView()}break;case"always":this.setView();break;case false:break}this._justClicked=false},_onDrag:function(){if(this._event){this._userPanned=true;this._updateContainerStyle();this._drawMarker()}},_isFollowing:function(){if(!this._active){return false}if(this.options.setView==="always"){return true}else{if(this.options.setView==="untilPan"){return !this._userPanned}}},_isOutsideMapBounds:function(){if(this._event===undefined){return false}return this._map.options.maxBounds&&!this._map.options.maxBounds.contains(this._event.latlng)},_updateContainerStyle:function(){if(!this._container){return}if(this._active&&!this._event){this._setClasses("requesting")}else{if(this._isFollowing()){this._setClasses("following")}else{if(this._active){this._setClasses("active")}else{this._cleanClasses()}}}},_setClasses:function(c){if(c=="requesting"){a.DomUtil.removeClasses(this._container,"active following");a.DomUtil.addClasses(this._container,"requesting");a.DomUtil.removeClasses(this._icon,this.options.icon);a.DomUtil.addClasses(this._icon,this.options.iconLoading)}else{if(c=="active"){a.DomUtil.removeClasses(this._container,"requesting following");a.DomUtil.addClasses(this._container,"active");a.DomUtil.removeClasses(this._icon,this.options.iconLoading);a.DomUtil.addClasses(this._icon,this.options.icon)}else{if(c=="following"){a.DomUtil.removeClasses(this._container,"requesting");a.DomUtil.addClasses(this._container,"active following");a.DomUtil.removeClasses(this._icon,this.options.iconLoading);a.DomUtil.addClasses(this._icon,this.options.icon)}}}},_cleanClasses:function(){a.DomUtil.removeClass(this._container,"requesting");a.DomUtil.removeClass(this._container,"active");a.DomUtil.removeClass(this._container,"following");a.DomUtil.removeClasses(this._icon,this.options.iconLoading);a.DomUtil.addClasses(this._icon,this.options.icon)},_resetVariables:function(){this._active=false;this._justClicked=false;this._userPanned=false}});a.control.locate=function(c){return new a.Control.Locate(c)};(function(){var c=function(f,d,e){e=e.split(" ");e.forEach(function(g){a.DomUtil[f].call(this,d,g)})};a.DomUtil.addClasses=function(d,e){c("addClass",d,e)};a.DomUtil.removeClasses=function(d,e){c("removeClass",d,e)}})();return b},window));(function(){L.Control.NavBar=L.Control.extend({options:{position:"topleft",forwardTitle:"Vai avanti",backTitle:"Via indietro",homeTitle:"Vai alla estensione iniziale"},onAdd:function(c){if(!this.options.center){this.options.center=c.getCenter()}if(!this.options.zoom){this.options.zoom=c.getZoom()}options=this.options;var b="leaflet-control-navbar",a=L.DomUtil.create("div",b+" leaflet-bar");this._homeButton=this._createButton(options.homeTitle,"fa fa-home",a,this._goHome);this._fwdButton=this._createButton(options.forwardTitle,"fa fa-caret-right",a,this._goFwd);this._backButton=this._createButton(options.backTitle,"fa fa-caret-left",a,this._goBack);this._viewHistory=[{center:this.options.center,zoom:this.options.zoom}];this._curIndx=0;this._updateDisabled();c.once("moveend",function(){this._map.on("moveend",this._updateHistory,this)},this);c.setView(options.center,options.zoom);return a},onRemove:function(a){a.off("moveend",this._updateHistory,this)},_goHome:function(){if(this.options.bbox){try{this._map.fitBounds(this.options.bbox)}catch(a){this._map.setView(this.options.center,this.options.zoom)}}this._map.setView(this.options.center,this.options.zoom)},_goBack:function(){if(this._curIndx!==0){this._map.off("moveend",this._updateHistory,this);this._map.once("moveend",function(){this._map.on("moveend",this._updateHistory,this)},this);this._curIndx--;this._updateDisabled();var a=this._viewHistory[this._curIndx];this._map.setView(a.center,a.zoom)}},_goFwd:function(){if(this._curIndx!=this._viewHistory.length-1){this._map.off("moveend",this._updateHistory,this);this._map.once("moveend",function(){this._map.on("moveend",this._updateHistory,this)},this);this._curIndx++;this._updateDisabled();var a=this._viewHistory[this._curIndx];this._map.setView(a.center,a.zoom)}},_createButton:function(e,c,a,b){var d=L.DomUtil.create("a",c,a);d.href="#";d.title=e;L.DomEvent.on(d,"mousedown dblclick",L.DomEvent.stopPropagation).on(d,"click",L.DomEvent.stop).on(d,"click",b,this).on(d,"click",this._refocusOnMap,this);return d},_updateHistory:function(){var b={center:this._map.getCenter(),zoom:this._map.getZoom()};var a=this._curIndx+1;this._viewHistory.splice(a,this._viewHistory.length-a,b);this._curIndx++;this._updateDisabled()},_setFwdEnabled:function(b){var a="leaflet-disabled";var c="leaflet-control-navbar-fwd-disabled";if(b===true){L.DomUtil.removeClass(this._fwdButton,c);L.DomUtil.removeClass(this._fwdButton,a)}else{L.DomUtil.addClass(this._fwdButton,c);L.DomUtil.addClass(this._fwdButton,a)}},_setBackEnabled:function(c){var b="leaflet-disabled";var a="leaflet-control-navbar-back-disabled";if(c===true){L.DomUtil.removeClass(this._backButton,a);L.DomUtil.removeClass(this._backButton,b)}else{L.DomUtil.addClass(this._backButton,a);L.DomUtil.addClass(this._backButton,b)}},_updateDisabled:function(){if(this._curIndx==(this._viewHistory.length-1)){this._setFwdEnabled(false)}else{this._setFwdEnabled(true)}if(this._curIndx<=0){this._setBackEnabled(false)}else{this._setBackEnabled(true)}}});L.control.navbar=function(a){return new L.Control.NavBar(a)}})();GV.Models.RlLayer=Backbone.Model.extend({initialize:function(){if(this.get("minScale")===0){this.set("minScale",591657550)}this.set("zIndex",GV.layerFactory.lastZIndex++);if(GV.app.map){this.set("inRange",GV.app.map.layerInRange(this.attributes))}else{this.set("inRange",true)}}});GV.Models.RlLayers=Backbone.Collection.extend({model:GV.Models.RlLayer});GV.Models.RlMap=Backbone.Model.extend({urlRoot:"/geoservices/REST/config/map/",initialize:function(){var a=new GV.Models.RlLayers(this.get("layers"));a.models=a.models.reverse();this.set("layers",a);this.get("layers").on("change",this.layersChanged,this);this.set("type","map")},layersChanged:function(a){this.trigger("layer:change",a)},parse:function(a){return a.data},toJSON:function(){var a=Backbone.Model.prototype.toJSON.call(this);if(a.layers&&a.layers.toJSON){a.layers=a.layers.toJSON()}return a}});GV.Models.RlMaps=Backbone.Collection.extend({model:GV.Models.RlMap,url:"/geoservices/REST/config/map/",add:function(c,a){var b={at:0};if(a){_.extend(b,a)}Backbone.Collection.prototype.add.call(this,c,b)},getLayerConfig:function(b){var a=null;_.each(this.models,function(d){var c=d.get("layers").models;a=_.find(c,function(e){return e.attributes.name===b})});if(a){return a.attributes}},getAllLayersConfig:function(){var a=[];_.each(this.models,function(b){_.each(b.get("layers").toJSON(),function(c){a.push(c)})});return a},setLayerAttribute:function(b,c,d){var a=null;_.each(this.models,function(f){var e=f.get("layers").models;_.each(e,function(g){if(g.get("name")===b){g.set(c,d)}})})}});GV.Views.Layout=Marionette.LayoutView.extend({template:false,controls:[],initialize:function(a){this.el=a.el;this.addMapView(a);this.listenTo(GV.rlMaps,"add",this.onAddMap)},render:function(a){var b=a.config.application.layout;if(this.map&&this.map.loadBaseLayers){this.map.loadBaseLayers(a.config.baseLayers)}if(this.map&&this.map.loadControls){this.map.loadControls(a)}if(b.toolbar){this.addToolbars(b.toolbar)}if(b.legend){this.addLegend(b.legend)}return this},addMapView:function(b){var a=new GV.Views.MapView();$(b.el).append(a.el);a.render(b);this.map=a.map},addToolbars:function(a){_.each(a,function(c){var b=c.position||"topleft";_.each(c.items,function(f){var d=f.options||{};d.position=b;if(GV.Buttons[f.name]){var e=GV.Buttons[f.name](d,this.map);if(e){e.name=f.name;this.controls.push(e);e.addTo(this.map)}}else{console.log("Bottone "+f.name+" non esistente")}},this)},this)},addLegend:function(b){var a=$("#gv-container");a.append("<div id='gv-legend-button'> </div>");this.addRegions({legendButton:"#gv-legend-button"});var c=new GV.Views.LegendButton();this.legendButton.show(c);a.append("<div id='gv-legend' style='display:none;'></div>");this.addRegions({legend:"#gv-legend"});var d=new GV.Views.LegendLayout();this.legend.show(d);d.title.show(new GV.Views.LegendTitle());d.body.show(new GV.Views.LegendBody({collection:GV.rlMaps}));if(b.show){$("#gv-legend").css({display:"block"});$("#gv-legend-button").css({display:"none"})}},onAddMap:function(a){var b=a.attributes.layers.toJSON();this.map.loadLayers(b)}});GV.Views.LegendItem=Marionette.CompositeView.extend({tagName:"ul",className:"gv-list-group",getTemplate:function(){var a;if(this.model.get("type")==="map"){if(GV.app.config.application.layout.legend.showMapInfoButton){a=['<li class="gv-list-legend-map-item"><%= name %>','<a class="gv-legend-map-info ms ms-information" title="Scheda metadati" href="/geoservices/REST/metadata/scheda_xml/<%= id %>?style=metadati.xsl" target="_blank"></a>',"</li>"].join("\n");return _.template(a)}else{return _.template("<li class='gv-list-legend-map-item'><%= name %></li>")}}else{if(this.model.get("inRange")){if(this.model.get("visible")){a=['<li class="gv-list-legend-layer-item">',"<div>",'<img class="gv-legend-layer-icon" src="<%= legend.icon %>" width="24px" height="24px">','<span class="gv-layer-visibility-span"><input type="checkbox" class="gv-layer-visibility-cb" checked></span>','<span class="gv-layer-title-span"><%= title %></span>',"</div>","</li>"].join("\n");return _.template(a)}else{a=['<li class="gv-list-legend-layer-item">','<img class="gv-legend-layer-icon" src="<%= legend.icon %>" width="24px" height="24px">','<span class="gv-layer-visibility-span"><input type="checkbox" class="gv-layer-visibility-cb"></span>','<span class="gv-layer-title-span"><%= title %></span>',"</li>"].join("\n");return _.template(a)}}else{a=['<li class="gv-list-legend-layer-disabled-item">','<img class="gv-legend-layer-icon" src="<%= legend.icon %>" width="24px" height="24px">','<span class="gv-layer-visibility-span"><input type="checkbox" class="gv-layer-visibility-cb" disabled></span>','<span class="gv-layer-title-span"><%= title %></span>',"</li>"].join("\n");return _.template(a)}}},initialize:function(){this.collection=this.model.get("layers");this.listenTo(this.collection,"change:inRange",this.onChangeInRangeLayer)},onChangeInRangeLayer:function(a){console.log("GV.Views.LegendItem: onChangeInRangeLayer");console.log(a);this.render()},events:{"click .gv-layer-visibility-cb":"setLayerVisibility"},setLayerVisibility:function(c){var a=this.model.attributes;if(a.type!=="map"){var b=c.currentTarget.checked;c.stopPropagation();this.model.set("visible",b);GV.app.map.setLayerVisible(a,b)}}});GV.Views.LegendBody=Marionette.CollectionView.extend({tagName:"ul",className:"gv-list-group",childView:GV.Views.LegendItem});GV.Views.LegendTitle=Marionette.ItemView.extend({className:"gv-legend-title gv-bgcolor",events:{"click .gv-close":"hideLegend","click .gv-legend-add":"addMap"},hideLegend:function(){$("#gv-legend").fadeOut("slow");$("#gv-legend-button").css({display:"block"})},addMap:function(){},getTemplate:function(){var a=["<div>","<b>LEGENDA</b>","<button class='gv-close' type='button'>Ã</button>","<button class='gv-legend-add ms ms-layers-add' title='Aggiungi Mappa' type='button'></button>","</div>",""].join("\n");return _.template(a)}});GV.Views.LegendLayout=Marionette.LayoutView.extend({template:_.template("<div id='gv-legend-title'></div><div id='gv-legend-body'></div>"),regions:{title:"#gv-legend-title",body:"#gv-legend-body"}});GV.Views.LegendButton=Marionette.ItemView.extend({template:_.template("<div  class='gv-legend-button gv-bgcolor gv-legend-button ms ms-layers-o' title='Legenda'></div>"),events:{click:"showLegend"},showLegend:function(){$("#gv-legend").fadeIn("slow")}});GV.Views.MapView=Backbone.View.extend({id:"gv-map",render:function(a){var b=a.mapType||"leaflet";if(b==="leaflet"){this.map=new GV.Map(a)}return this}});