<template>
    <div id="gv-map">
    </div>
</template>

<script>
    import Vue from 'vue'
    import Map from '../leaflet/Map.js'
    import GV from '../GV'

    const events = [
        'click',
        'dblclick',
        'mousedown',
        'mouseup',
        'mouseover',
        'mouseout',
        'mousemove',
        'contextmenu',
        'focus',
        'blur',
        'preclick',
        'load',
        'unload',
        'viewreset',
        'movestart',
        'move',
        'moveend',
        'dragstart',
        'drag',
        'dragend',
        'zoomstart',
        'zoomend',
        'zoomanim',
        'zoomlevelschange',
        'resize',
        'autopanstart',
        'layeradd',
        'layerremove',
        'baselayerchange',
        'overlayadd',
        'overlayremove',
        'locationfound',
        'locationerror',
        'popupopen',
        'popupclose',
    ];

    export default {
        name: 'gv-map',
        props: [],
        data() {
            return {
                map: null,
                maps: GV.config.maps
            }
        },
        mounted () {
            if (GV.config.debug) console.log('gv-map: mounted')

            this.map = new Map()

            this.registerMapEvents()

            this.subscribeConfigEvents()
        },
        methods: {
            registerMapEvents() {
                // Emetto eventi Vue per ogni evento della mappa Leaflet
                // Per utilizzare eventi mappa leaflet
                // ev Ã¨ oggetto formato da
                // - target (mappa Leaflet)
                // - type (tipo di evento es: 'move'
                // GV.eventBus.$on('lmap-move', ev => {console.log(ev)})
                events.forEach((eventName) => {
                    const exposedName = 'lmap-' + eventName;
                    this.map.on(eventName, (ev) => { GV.eventBus.$emit(exposedName, ev) })
                })
            },
            subscribeConfigEvents() {
                // Ascolto evento config-add-map e aggiungo layer alla mappa
                GV.eventBus.$on('config-add-map', (ev) => {
                    const mapConfig = ev.config
                    // Aggiungo livelli alla mappa
                    this.map.loadLayers(mapConfig.layers)
                    //gestione extent
                    if (mapConfig.extent_3857) {
                        this.map.setExtent(mapConfig.extent_3857)
                    }
                    //TODO: gestione find
                })
                // Ascolto evento config-remove-map e levo layer alla mappa
                GV.eventBus.$on('config-remove-map', (ev) => {
                    const mapConfig = ev.config
                    // Levo i livelli dalla mappa
                    mapConfig.layers.forEach(layerConfig => {
                        const layer = this.map.getLayerByName(layerConfig.name)
                        if (layer) {
                            this.map.removeLayer(layer)
                        }
                    })
                })

            }
        }
    }


</script>

<style scoped>
    #gv-map {
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 1;
    }
</style>
